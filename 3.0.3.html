<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频可视化播放器</title>
    <!-- 标签图标 -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDY0IDY0Ij4KICA8Y2lyY2xlIGN4PSIzMiIgY3k9IjMyIiByPSIzMCIgZmlsbD0iIzFFODhFNSIvPgogIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDggOCkgc2NhbGUoMikiPgogICAgPHBhdGggZD0iTTkuNDczIDYuNTdjLTEuMjcyLjU5Ni0yLjI5OSAxLjYyMy0yLjg5NSAyLjg5NWwtMS4wNDEtLjEzYy43MDktMS43MjEgMi4wODQtMy4wOTcgMy44MDctMy44MDdsLjEyOSAxLjA0MnptLS4yNi0yLjA3N2wtLjEyNy0xLjAxOWMtMi42MjUuOTAyLTQuNjk3IDIuOTc4LTUuNTkyIDUuNjA2bDEuMDIuMTI3Yy44MDYtMi4xNzQgMi41MjktMy45IDQuNjk5LTQuNzE0em0yLjc4NyAxMS41MDdjLTIuMjA5IDAtNC0xLjc5MS00LTRzMS43OTEtNCA0LTQgNCAxLjc5MSA0IDQtMS43OTEgNC00IDR6bTItNGMwLTEuMTAzLS44OTYtMi0yLTJzLTIgLjg5Ny0yIDIgLjg5NiAyIDIgMiAyLS44OTcgMi0yem0xMCAwYzAgNi42MjctNS4zNzMgMTItMTIgMTJzLTEyLTUuMzczLTEyLTEyIDUuMzczLTEyIDEyLTEyYzYuNjMgMCAxMiA1LjM5NiAxMiAxMnptLTIgMGMwLS4yMy0uMDItLjQ1Ni0uMDM0LS42ODItLjUwMSAxLjcyOS0xLjQ1MyAzLjE5OC0yLjM2MSA0LjEzN2wtMS40MzgtMS4zOTFjMS4xNTEtMS4xOSAyLjM5Ni0zLjQ0MiAyLjExNS01Ljg2Ny0uMjE5LTEuODg5LTEuMzQ0LTMuNTI0LTMuMzI1LTQuODcxLTEuNDYzLS44MzktMy4xNTMtMS4zMjYtNC45NTctMS4zMjYtNS41MTQgMC0xMCA0LjQ4Ni0xMCAxMHM0LjQ4NiAxMCAxMCAxMCAxMC00LjQ4NiAxMC0xMHptLTcuMzU4IDUuMjY3bDEuODgxIDEuODMyIDIuNjM5LTIuNjc4LTEuODgtMS44MzQtMi42NCAyLjY4eiIgZmlsbD0id2hpdGUiLz4KICA8L2c+Cjwvc3ZnPg=="/>
    <style>
        /* ============================================
        重置和基础样式
        ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            /* 颜色变量 */
            --primary-color: #3b82f6;
            --secondary-color: #1e40af;
            --dark-bg: rgba(30, 30, 30, 0.8);
            --light-bg: rgba(255, 255, 255, 0.1);
            --text-light: rgba(255, 255, 255, 0.9);
            --text-muted: rgba(255, 255, 255, 0.6);
            --blur-intensity: 10px;
        }

        body {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
            overflow: hidden;
        }

        /* ============================================
        粒子画布和背景层
        ============================================ */
        .particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.8;
            transition: opacity 0.5s ease;
        }

        .background-blur {
            position: fixed;
            top: -20px;
            left: -20px;
            width: calc(100% + 40px);
            height: calc(100% + 40px);
            background-size: cover;
            background-position: center;
            filter: blur(var(--blur-intensity)) brightness(0.7) saturate(1.2);
            z-index: -1;
            transition: background-image 0.5s ease, filter 0.3s ease;
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(30, 30, 30, 0.6), rgba(45, 45, 45, 0.8));
            z-index: -1;
        }

        /* ============================================
        顶部进度条
        ============================================ */
        .top-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 1000;
            cursor: pointer;
        }

        .top-progress {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.1s;
            position: relative;
        }

        .top-progress-thumb {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .time-tooltip {
            display: none;
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1001;
        }

        .top-progress-bar:hover .time-tooltip {
            display: block;
        }

        .top-progress-bar:hover .top-progress-thumb,
        .top-progress-bar.dragging .top-progress-thumb {
            opacity: 1;
        }

        /* ============================================
        主容器和布局
        ============================================ */
        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
            padding-bottom: 80px;
            overflow: hidden;
        }

        /* ============================================
        左侧播放列表区
        ============================================ */
        .playlist-section {
            width: 20%;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow: hidden;
            height: calc(100vh);
            z-index: 110;
        }

        .playlist-section.hidden {
            width: 0;
            opacity: 0;
        }

        /* 修改 .playlist-header 样式 */
        .playlist-header {
            display: flex;
            justify-content: center; /* 改为居中 */
            align-items: center;
            padding: 15px 20px 5px 20px; /* 减小下边距 */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 50px; /* 固定高度 */
        }

        .playlist-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center; /* 文字居中 */
            margin: 0; /* 移除默认边距 */
        }

        /* 修改播放列表控制按钮区域样式 */
        .playlist-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px 20px 15px 20px; /* 调整内边距 */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .playlist-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            width: 50%;
            justify-content: center;
        }

        

        .playlist-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .playlist-container::-webkit-scrollbar {
            width: 4px;
        }

        .playlist-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .playlist-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item.active {
            background: rgba(59, 130, 246, 0.3);
            border-left: 3px solid var(--primary-color);
        }

        .playlist-item img {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
        }

        .playlist-item-info {
            margin-left: 12px;
            flex: 1;
            min-width: 0;
        }

        .playlist-item-title {
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-artist {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-btn {
            position: absolute;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            padding: 0;
        }

        .playlist-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: rgba(255, 0, 0, 0.7);
        }

        /* 播放列表隐藏时的展开按钮 - 调整现有样式 */
        .show-playlist-btn {
            position: absolute;
            left: 0;
            top: 20px;
            transform: translateY(-50%);
            background: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .show-playlist-btn.visible {
            opacity: 0.6;
            visibility: visible;
        }

        .show-playlist-btn:hover {
            opacity: 1;
        }

        /* 新增外部折叠按钮样式 */
        .hide-playlist-btn-external {
            position: absolute;
            right: 0;
            top: 20px;
            transform: translateY(-50%);
            background: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            opacity: 0.6;
            visibility: visible;
            transition: all 0.3s ease;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hide-playlist-btn-external:hover {
            opacity: 1;
        }

        /* 当播放列表隐藏时，隐藏外部折叠按钮 */
        .playlist-section.hidden .hide-playlist-btn-external {
            opacity: 0;
            visibility: hidden;
        }

        .file-input-container {
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            gap: 8px;
        }

        .file-input-label:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #file-input, #folder-input {
            display: none;
        }

        /* ============================================
        中间主播放区 - 专辑封面
        ============================================ */
        .main-player-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: width 0.3s ease;
            height: 100vh;
        }

        .album-art-container {
            position: relative;
            margin-bottom: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 0px;
        }

        .album-art-background {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 500px;
            border-radius: 50%;
            background: linear-gradient(135deg, #333, #222);
            z-index: -1;
            transition: background 0.5s ease, width 0.3s ease, height 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .album-art-large {
            width: 500px;
            height: 500px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: spin-slow 28s linear infinite;
            position: relative;
            transition: transform 0.1s ease-out;
            z-index: 1;
        }

        .album-art-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 60ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
        }

        .album-art-controls {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .control-btn-hidden {
            position: absolute;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            pointer-events: auto;
            z-index: 10;
        }

        .control-btn-hidden:hover {
            color: rgba(255, 255, 255, 0.7);
            background: rgba(0, 0, 0, 0.3);
        }

        .control-btn-hidden .icon {
            width: 24px;
            height: 24px;
            stroke-width: 1.5px;
        }

        .prev-btn-hidden {
            left: 25%;
            transform: translateX(-50%);
        }

        .next-btn-hidden {
            right: 25%;
            transform: translateX(50%);
        }

        .album-art-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            display: none;
        }

        /* ============================================
        右侧歌词区
        ============================================ */
        .lyrics-section {
            width: 30%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: width 0.3s ease;
        }

        .lyrics-section.expanded {
            width: 50%;
        }

        .lyrics-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .lyrics-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lyrics-artist {
            font-size: 0.9rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lyrics-container {
            flex: 1;
            overflow-y: auto;
            text-align: center;
            line-height: 1.8;
            padding-right: 5px;
            position: relative;
            scrollbar-width: none;
            -ms-overflow-style: none;
            mask-image: linear-gradient(to bottom, 
                transparent 0%, 
                black 10%, 
                black 90%, 
                transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, 
                transparent 0%, 
                black 10%, 
                black 90%, 
                transparent 100%);
        }

        .lyrics-container::-webkit-scrollbar {
            display: none;
        }

        .lyrics-line {
            margin-bottom: 10px;
            transition: all 0.3s;
            opacity: 0.5;
        }

        .lyrics-line.active {
            color: var(--primary-color);
            font-weight: 500;
            font-size: 1.3rem;
            opacity: 1;
            transform: scale(1.05);
        }

        .no-lyrics {
            text-align: center;
            color: var(--text-muted);
            margin-top: 50%;
            transform: translateY(-50%);
        }

        /* ============================================
        音频可视化区域
        ============================================ */
        .audio-visualizer {
            position: fixed;
            bottom: 80px;
            left: 0;
            width: 100%;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            z-index: 99;
            transition: height 0.3s ease, opacity 0.3s ease, bottom 0.3s ease;
            opacity: 1;
            pointer-events: none;
        }

        .audio-visualizer.hidden {
            height: 0;
            opacity: 0;
        }

        .visualizer-container {
            display: flex;
            align-items: flex-end;
            height: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .visualizer-bar {
            width: 10px;
            margin: 0 1px;
            background: linear-gradient(to top, 
                var(--primary-color) 0%, 
                rgba(59, 130, 246, 0.8) 50%,
                rgba(59, 130, 246, 0.4) 100%);
            border-radius: 5px 5px 0 0;
            transition: height 0.05s ease-out, background 0.5s ease;
            position: relative;
        }

        .visualizer-bar.high-frequency::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            filter: blur(1px);
            opacity: 0.7;
        }

        /* ============================================
        底部控制栏
        ============================================ */
        .player-controls {
            position: fixed;
            bottom: -80px;
            left: 0;
            width: 100%;
            height: 80px;
            background: var(--dark-bg);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            transition: bottom 0.3s ease;
        }

        .player-controls.visible {
            bottom: 0;
        }

        .controls-hover-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px;
            z-index: 99;
            background: transparent;
        }

        .current-track-info {
            display: flex;
            align-items: center;
            width: 25%;
            min-width: 200px;
        }

        .album-art-small {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            overflow: hidden;
        }

        .album-art-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .track-info-small {
            margin-left: 15px;
            flex: 1;
            min-width: 0;
        }

        .track-title-small {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist-small {
            font-size: 0.9rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 20px;
            max-width: 50%;
        }

        .progress-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-time, .total-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            width: 40px;
        }

        .progress-bar-container {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            border-radius: 2px;
            width: 0%;
            position: relative;
            transition: width 0.1s;
        }

        .progress-thumb {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-bar-container:hover .progress-thumb,
        .progress-bar-container.dragging .progress-thumb {
            opacity: 1;
        }

        /* ============================================
        控制按钮区域
        ============================================ */
        .control-buttons {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 25%;
            justify-content: flex-end;
            min-width: 300px;
        }

        .progress-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-right: 20px;
        }

        .control-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .play-btn {
            background: var(--primary-color);
            width: 45px;
            height: 45px;
        }

        .play-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.05);
        }

        .icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
        }

        .volume-slider {
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        /* ============================================
        歌词管理面板
        ============================================ */
        .lyrics-manager-panel {
            position: absolute;
            bottom: calc(100% + 2px);
            left: 0;
            width: 100%;
            background: var(--dark-bg);
            backdrop-filter: blur(10px);
            border-radius: 8px 8px 0 0;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
            z-index: 101;
            max-height: 400px;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .lyrics-manager-panel.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .lyrics-manager-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lyrics-manager-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .lyrics-manager-search {
            padding: 10px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .lyrics-search-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            color: white;
            font-size: 0.9rem;
        }

        .lyrics-search-input::placeholder {
            color: var(--text-muted);
        }

        .lyrics-manager-list {
            flex: 1;
            overflow-y: auto;
            max-height: 250px;
        }

        .lyrics-manager-list::-webkit-scrollbar {
            width: 4px;
        }

        .lyrics-manager-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .lyrics-manager-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .lyrics-manager-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .lyrics-item {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lyrics-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .lyrics-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid var(--primary-color);
        }

        .lyrics-item-info {
            flex: 1;
        }

        .lyrics-file-name {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .lyrics-song-name {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .lyrics-item-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .lyrics-manager-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
        }

        .lyrics-manager-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            flex: 1;
            justify-content: center;
        }

        .lyrics-manager-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lyrics-manager-btn.primary {
            background: var(--primary-color);
        }

        .lyrics-manager-btn.primary:hover {
            background: var(--secondary-color);
        }

        #lyrics-file-input, #lyrics-folder-input {
            display: none;
        }

        /* ============================================
        设置面板
        ============================================ */
        .settings-panel {
            position: absolute;
            bottom: calc(100% + 2px);
            right: 0;
            width: 400px;
            background: var(--dark-bg);
            backdrop-filter: blur(10px);
            border-radius: 8px 0 0 8px;
            box-shadow: -5px -5px 15px rgba(0, 0, 0, 0.3);
            z-index: 101;
            max-height: 600px;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .settings-panel.active {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }

        .settings-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
        }

        .settings-content::-webkit-scrollbar {
            width: 4px;
        }

        .settings-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .settings-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .settings-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* ============================================
        设置分组
        ============================================ */
        .settings-group {
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .settings-group-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--primary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }

        .settings-group-title:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .settings-group-content {
            padding: 15px 20px;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .settings-group-content.collapsed {
            max-height: 0;
            padding: 0 20px;
        }

        .settings-group-arrow {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }

        .settings-group-arrow.collapsed {
            transform: rotate(-90deg);
        }

        /* ============================================
        设置项样式
        ============================================ */
        .setting-item {
            margin-bottom: 16px;
            transition: opacity 0.2s ease;
        }

        .settings-group-content.collapsed .setting-item {
            opacity: 0;
            pointer-events: none;
        }

        .setting-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .setting-value {
            font-size: 0.8rem;
            color: var(--text-muted);
            min-width: 40px;
            text-align: right;
        }

        .setting-slider {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        /* ============================================
        开关样式
        ============================================ */
        .setting-toggle {
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
            display: inline-block;
        }

        .setting-toggle.active {
            background: var(--primary-color);
        }

        .setting-toggle.active::after {
            transform: translateX(20px);
        }

        .setting-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-label {
            flex: 1;
        }

        .settings-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            flex: 1;
            justify-content: center;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .settings-btn.primary {
            background: var(--primary-color);
        }

        .settings-btn.primary:hover {
            background: var(--secondary-color);
        }

        /* ============================================
        动画
        ============================================ */
        @keyframes spin-slow {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* ============================================
        歌单管理面板
        ============================================ */
        .playlist-manager-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            backdrop-filter: blur(10px);
            z-index: 120;
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .playlist-manager-panel.active {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }

        .playlist-manager-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playlist-manager-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .playlist-manager-actions {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
        }

        .playlist-manager-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .playlist-manager-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .playlist-manager-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .playlist-manager-list::-webkit-scrollbar {
            width: 4px;
        }

        .playlist-manager-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-manager-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .playlist-manager-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .playlist-item-manager {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playlist-item-manager:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .playlist-item-manager.active {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid var(--primary-color);
        }

        .playlist-item-info {
            flex: 1;
        }

        .playlist-item-name {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .playlist-item-count {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .playlist-item-actions {
            display: flex;
            gap: 5px;
        }

        .playlist-item-action-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .playlist-item-action-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .no-playlists {
            text-align: center;
            color: var(--text-muted);
            padding: 30px 0;
        }
        /* 全部歌曲按钮 */
        .all-songs-btn {
            
            border: none;
            color: white;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            font-weight: 500;
            text-align: center;
            
        }

        
        .all-songs-btn.active {
            background: rgba(59, 130, 246, 0.4);
            border-left: 4px solid var(--primary-color);
        }

        /* ============================================
        歌曲上下文菜单
        ============================================ */
        .song-context-menu {
            position: fixed;
            background: var(--dark-bg);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 200;
            min-width: 200px;
            max-width: 300px;
            max-height: 400px;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .song-context-menu.active {
            transform: scale(1);
            opacity: 1;
            visibility: visible;
        }

        .context-menu-header {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .context-menu-header span {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .context-menu-list {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
            padding: 5px 0;
        }

        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .context-menu-item-name {
            font-size: 0.9rem;
        }

        .context-menu-item-check {
            color: var(--primary-color);
            font-size: 0.8rem;
            opacity: 0;
        }

        .context-menu-item.in-playlist .context-menu-item-check {
            opacity: 1;
        }

        /* ============================================
        新建歌单对话框
        ============================================ */
        .create-playlist-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .create-playlist-dialog.active {
            opacity: 1;
            visibility: visible;
        }

        .dialog-content {
            background: var(--dark-bg);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        .dialog-content h3 {
            margin-bottom: 20px;
            font-size: 1.2rem;
            text-align: center;
        }

        #new-playlist-name {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 15px;
            color: white;
            font-size: 1rem;
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        #new-playlist-name:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.15);
        }

        .dialog-buttons {
            display: flex;
            gap: 15px;
        }

        .dialog-btn {
            flex: 1;
            padding: 12px 0;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .dialog-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .dialog-btn.primary {
            background: var(--primary-color);
        }

        .dialog-btn.primary:hover {
            background: var(--secondary-color);
        }

        /* ============================================
        播放列表中的歌曲右键菜单按钮
        ============================================ */
        .add-to-playlist-btn {
            position: absolute;
            right: 40px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            padding: 0;
        }

        .playlist-item:hover .add-to-playlist-btn {
            opacity: 1;
        }

        .add-to-playlist-btn:hover {
            background: rgba(59, 130, 246, 0.7);
        }

        /* ============================================
        响应式设计
        ============================================ */

        /* 平板设备 (1024px以下) */
        @media (max-width: 1024px) {
            .lyrics-section {
                display: flex !important;
                width: 100%;
                height: calc(100vh - 140px);
                padding: 15px 20px;
                position: absolute;
                top: 60px;
                left: 0;
                z-index: 10;
            }
            
            .lyrics-section.expanded {
                width: 100%;
            }

            .control-buttons {
                width: auto;
                min-width: 200px;
            }
            
            .lyrics-header {
                position: sticky;
                top: 0;
                z-index: 5;
                margin-top: 0;
                padding: 15px 0;
                margin-bottom: 10px;
                height: auto;
                min-height: 70px;
            }
            
            .lyrics-title {
                font-size: 1.3rem;
                font-weight: 700;
                margin-bottom: 5px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .lyrics-artist {
                font-size: 0.9rem;
                color: var(--text-muted);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .lyrics-container {
                flex: 1;
                padding: 0 10px;
                margin-bottom: 20px;
                mask-image: linear-gradient(to bottom, 
                    transparent 0%, 
                    black 5%, 
                    black 95%, 
                    transparent 100%);
                -webkit-mask-image: linear-gradient(to bottom, 
                    transparent 0%, 
                    black 5%, 
                    black 95%, 
                    transparent 100%);
            }
            
            .lyrics-line {
                margin-bottom: 15px;
                font-size: 1.05rem;
                line-height: 1.6;
                padding: 5px 0;
            }
            
            .lyrics-line.active {
                font-size: 1.25rem;
                font-weight: 600;
                padding: 8px 0;
                transform: scale(1.05);
            }
            
            .album-art-container {
                display: none;
            }
            
            .main-player-section {
                width: 75%;
                height: 100%;
                justify-content: flex-start;
                padding-top: 60px;
            }
            
            .playlist-section {
                width: 300px;
                z-index: 110;
            }
            
            .volume-container {
                display: none;
            }
        }

        /* 移动设备 (768px以下) */
        @media (max-width: 768px) {
            .playlist-section {
                position: absolute;
                z-index: 50;
                height: 100%;
                z-index: 110;
            }
            
            .main-player-section {
                width: 100%;
                height: 100%;
                justify-content: flex-start;
                padding-top: 60px;
            }
            
            .album-art-container {
                display: none;
            }

            .current-track-info {
                display: none !important;
            }
            
            .lyrics-section {
                display: flex !important;
                width: 100%;
                height: calc(100vh - 140px);
                padding: 10px 20px;
                position: absolute;
                top: 60px;
                left: 0;
                z-index: 10;
            }
            
            .lyrics-section.expanded {
                width: 100%;
            }
            
            .lyrics-header {
                position: sticky;
                top: 0;
                z-index: 5;
                margin-top: 0;
                padding: 15px 0;
                margin-bottom: 10px;
            }
            
            .lyrics-container {
                flex: 1;
                padding: 0 10px;
                margin-bottom: 20px;
                mask-image: linear-gradient(to bottom, 
                    transparent 0%, 
                    black 5%, 
                    black 95%, 
                    transparent 100%);
                -webkit-mask-image: linear-gradient(to bottom, 
                    transparent 0%, 
                    black 5%, 
                    black 95%, 
                    transparent 100%);
            }
            
            .lyrics-line {
                margin-bottom: 15px;
                font-size: 1.1rem;
                line-height: 1.6;
                padding: 5px 0;
            }
            
            .lyrics-line.active {
                font-size: 1.4rem;
                font-weight: 600;
                padding: 10px 0;
                transform: scale(1.05);
            }
            
            .current-track-info {
                width: 40%;
                min-width: 150px;
            }
            
            .progress-section {
                min-width: 60%;
                padding: 0 10px;
            }
            
            .control-buttons {
                width: 100% !important;
                min-width: auto !important;
                padding-left: 10px;
            }

            .progress-controls {
                width: 100% !important;
                justify-content: center !important;
                margin-right: 0 !important;
                margin-bottom: 10px !important;
            }
            
            .settings-panel {
                width: 400px;
            }

            #shuffle-btn,
            #repeat-btn,
            #visualizer-toggle-btn {
                display: none !important;
            }
        }

        /* 小屏幕设备 (480px以下) */
        @media (max-width: 480px) {
            .lyrics-section {
                padding: 5px 15px;
            }
            
            .lyrics-header {
                padding: 12px 0;
            }
            
            .lyrics-title {
                font-size: 1.2rem;
            }
            
            .lyrics-artist {
                font-size: 0.85rem;
            }
            
            .lyrics-container {
                padding: 0 5px;
            }
            
            .lyrics-line {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            .lyrics-line.active {
                font-size: 1.2rem;
            }
            
            .current-track-info {
                width: 50%;
                min-width: 120px;
            }
            
            .control-buttons {
                width: 60%;
                justify-content: center;
            }
            
            .volume-container {
                display: none;
            }

            .progress-controls {
                margin-right: 0;
            }
            
            .settings-panel {
                width: 100%;
            }

            .playlist-section {
                width: 100%;
                z-index: 110;
            }
            
            #shuffle-btn,
            #repeat-btn,
            #visualizer-toggle-btn,
            #lock-controls-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- 粒子画布 -->
    <canvas class="particles-canvas" id="particles-canvas"></canvas>
    
    <!-- 顶部进度条 -->
    <div class="top-progress-bar" id="top-progress-bar">
        <div class="top-progress" id="top-progress">
            <div class="top-progress-thumb"></div>
        </div>
        <div class="time-tooltip" id="time-tooltip">0:00 / 0:00</div>
    </div>
    
    <!-- 背景模糊层 -->
    <div class="background-blur" id="background-blur"></div>
    <div class="background-overlay"></div>
    
    <div class="main-container">
        <!-- 左侧播放列表区 -->
        <div class="playlist-section" id="playlist-section">
            <div class="playlist-header">
                <h2>播放列表</h2>
            </div>
            
            <!-- 新增外部折叠按钮 -->
            <div class="hide-playlist-btn-external" id="hide-playlist-btn-external">
                <svg class="icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" />
                </svg>
            </div>
            
            <div class="playlist-controls">
                <button class="playlist-btn" id="shuffle-playlist-btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M14.83,13.41L13.42,14.82L16.55,17.95L14.5,20H20V14.5L17.96,16.54L14.83,13.41M14.5,4L16.54,6.04L4,18.59L5.41,20L17.96,7.46L20,9.5V4M10.59,9.17L5.41,4L4,5.41L9.17,10.58L10.59,9.17Z" />
                    </svg>
                    打乱
                </button>
                <button class="playlist-btn" id="playlist-manager-btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                    </svg>
                    歌单
                </button>
            </div>
            
            <div class="playlist-container" id="playlist-container">
                <!-- 播放列表将通过JavaScript动态生成 -->
                <div class="empty-playlist">
                    <p>暂无歌曲，请添加音乐文件</p>
                </div>
            </div>
            <!-- 歌单管理面板 -->
            <div class="playlist-manager-panel" id="playlist-manager-panel">
                <div class="playlist-manager-header">
                    <h3>歌单管理</h3>
                    <button class="control-btn" id="close-playlist-manager-btn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                        </svg>
                    </button>
                </div>
                <div class="playlist-manager-actions">
                    <button class="playlist-manager-btn" id="create-playlist-btn">新建歌单</button>
                    <button class="playlist-manager-btn" id="export-playlists-btn">导出歌单</button>
                    <button class="playlist-manager-btn" id="import-playlists-btn">导入歌单</button>
                    <input type="file" id="import-playlists-file-input" accept=".json" style="display: none;">
                </div>
                <div class="playlist-manager-list" id="playlist-manager-list">
                    <!-- 添加全部歌曲按钮 -->
                    <div class="all-songs-btn" id="all-songs-btn">全部歌曲</div>
                    <!-- 歌单列表将动态生成 -->
                    <div class="no-playlists">暂无歌单</div>
                </div>
            </div>
            <div class="file-input-container">
                <label for="file-input" class="file-input-label">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M14,13V17H10V13H7L12,8L17,13M19.35,10.03C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.03C2.34,8.36 0,10.9 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 21.95,10.22 19.35,10.03Z" />
                    </svg>
                    添加音乐文件
                </label>
                <input type="file" id="file-input" accept=".mp3,.flac,.ogg,.wav,.aac,.m4a" multiple>
                
                <label for="folder-input" class="file-input-label">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z" />
                    </svg>
                    添加音乐文件夹
                </label>
                <input type="file" id="folder-input" accept=".mp3,.flac,.ogg,.wav,.aac,.m4a,.lrc,.txt" multiple webkitdirectory directory>
            </div>
        </div>
        
        <!-- 播放列表隐藏时的展开按钮 -->
        <div class="show-playlist-btn" id="show-playlist-btn">
            <svg class="icon" viewBox="0 0 24 24">
                <path fill="currentColor" d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" />
            </svg>
        </div>
        
        <!-- 中间主播放区 -->
        <div class="main-player-section">
            <div class="album-art-container" id="album-art-container">
                <!-- 新增：边缘颜色背景层 -->
                <div class="album-art-background" id="album-art-background"></div>
                
                <div class="album-art-large">
                    <img id="album-art-large" src="data:image/svg+xml,%3Csvg width='500' height='500' viewBox='0 0 500 500' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='0' y='0' width='500' height='500' fill='%231a1a1a' rx='15' ry='15'/%3E%3Cg fill='%23222222'%3E%3Crect x='5' y='50' width='8' height='30' rx='4'/%3E%3Crect x='5' y='100' width='8' height='30' rx='4'/%3E%3Crect x='5' y='150' width='8' height='30' rx='4'/%3E%3Crect x='5' y='200' width='8' height='30' rx='4'/%3E%3Crect x='5' y='250' width='8' height='30' rx='4'/%3E%3Crect x='5' y='300' width='8' height='30' rx='4'/%3E%3Crect x='5' y='350' width='8' height='30' rx='4'/%3E%3Crect x='5' y='400' width='8' height='30' rx='4'/%3E%3Crect x='487' y='50' width='8' height='30' rx='4'/%3E%3Crect x='487' y='100' width='8' height='30' rx='4'/%3E%3Crect x='487' y='150' width='8' height='30' rx='4'/%3E%3Crect x='487' y='200' width='8' height='30' rx='4'/%3E%3Crect x='487' y='250' width='8' height='30' rx='4'/%3E%3Crect x='487' y='300' width='8' height='30' rx='4'/%3E%3Crect x='487' y='350' width='8' height='30' rx='4'/%3E%3Crect x='487' y='400' width='8' height='30' rx='4'/%3E%3C/g%3E%3Cg fill='%230d0d0d'%3E%3Crect x='20' y='470' width='60' height='15' rx='8'/%3E%3Crect x='420' y='470' width='60' height='15' rx='8'/%3E%3C/g%3E%3Crect x='20' y='20' width='460' height='460' fill='none' stroke='%23333333' stroke-width='2' rx='10' ry='10'/%3E%3Crect x='25' y='25' width='450' height='450' fill='none' stroke='%232a2a2a' stroke-width='1' rx='8' ry='8'/%3E%3Ccircle cx='250' cy='250' r='250' fill='%23000000'/%3E%3Cg stroke='%23222222' stroke-width='1.25' fill='none'%3E%3Ccircle cx='250' cy='250' r='87.5'/%3E%3Ccircle cx='250' cy='250' r='92.5'/%3E%3Ccircle cx='250' cy='250' r='97.5'/%3E%3Ccircle cx='250' cy='250' r='102.5'/%3E%3Ccircle cx='250' cy='250' r='107.5'/%3E%3Ccircle cx='250' cy='250' r='112.5'/%3E%3Ccircle cx='250' cy='250' r='117.5'/%3E%3Ccircle cx='250' cy='250' r='122.5'/%3E%3Ccircle cx='250' cy='250' r='127.5'/%3E%3Ccircle cx='250' cy='250' r='132.5'/%3E%3Ccircle cx='250' cy='250' r='137.5'/%3E%3Ccircle cx='250' cy='250' r='142.5'/%3E%3Ccircle cx='250' cy='250' r='147.5'/%3E%3Ccircle cx='250' cy='250' r='152.5'/%3E%3Ccircle cx='250' cy='250' r='157.5'/%3E%3Ccircle cx='250' cy='250' r='162.5'/%3E%3Ccircle cx='250' cy='250' r='167.5'/%3E%3Ccircle cx='250' cy='250' r='172.5'/%3E%3Ccircle cx='250' cy='250' r='177.5'/%3E%3Ccircle cx='250' cy='250' r='182.5'/%3E%3Ccircle cx='250' cy='250' r='187.5'/%3E%3Ccircle cx='250' cy='250' r='192.5'/%3E%3Ccircle cx='250' cy='250' r='197.5'/%3E%3Ccircle cx='250' cy='250' r='202.5'/%3E%3Ccircle cx='250' cy='250' r='207.5'/%3E%3Ccircle cx='250' cy='250' r='212.5'/%3E%3Ccircle cx='250' cy='250' r='217.5'/%3E%3Ccircle cx='250' cy='250' r='222.5'/%3E%3Ccircle cx='250' cy='250' r='227.5'/%3E%3Ccircle cx='250' cy='250' r='232.5'/%3E%3Ccircle cx='250' cy='250' r='237.5'/%3E%3Ccircle cx='250' cy='250' r='242.5'/%3E%3Ccircle cx='250' cy='250' r='247.5'/%3E%3C/g%3E%3Ccircle cx='250' cy='250' r='75' fill='%233b82f6'/%3E%3Ccircle cx='250' cy='250' r='70' fill='%23ffffff'/%3E%3Cdefs%3E%3Cpath id='textPath' d='M 250,200 A 50,50 0 1,1 249.9,200' fill='none'/%3E%3C/defs%3E%3Ctext fill='%231e40af' font-size='18' font-family='Arial, sans-serif' font-weight='bold' letter-spacing='1'%3E%3CtextPath href='%23textPath' startOffset='50%' text-anchor='middle'%3ENO COVER AVAILABLE%3C/textPath%3E%3C/text%3E%3Ccircle cx='250' cy='250' r='20' fill='%233b82f6'/%3E%3C/svg%3E" alt="专辑封面">
                </div>
                
                <!-- 新增：隐藏式控制按钮 -->
                <div class="album-art-controls">
                    <button class="control-btn-hidden prev-btn-hidden" id="prev-btn-hidden" title="上一首">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M6 6h2v12H6V6zm9.5 12l-8-6 8-6v12z"/>
                        </svg>
                    </button>
                    <button class="control-btn-hidden play-pause-btn-hidden" id="play-pause-btn-hidden" title="播放/暂停">
                        <svg class="icon" id="play-pause-icon-hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </button>
                    <button class="control-btn-hidden next-btn-hidden" id="next-btn-hidden" title="下一首">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M6 18l8-6-8-6v12zm10 0h2V6h-2v12z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="album-art-center">
                    <svg class="icon" id="album-art-play-icon" viewBox="0 0 24 24">
                        <path fill="white" d="M8,5.14V19.14L19,12.14L8,5.14Z" />
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- 右侧歌词区 -->
        <div class="lyrics-section" id="lyrics-section">
            <div class="lyrics-header">
                <div class="lyrics-title" id="lyrics-title">选择音乐文件</div>
                <div class="lyrics-artist" id="lyrics-artist">等待加载...</div>
            </div>
            <div class="lyrics-container" id="lyrics-container">
                <div class="no-lyrics">暂无歌词</div>
            </div>
        </div>
    </div>
    
    <!-- 音频可视化区域 -->
    <div class="audio-visualizer" id="audio-visualizer">
        <div class="visualizer-container" id="visualizer-container">
            <!-- 可视化柱将通过JavaScript动态生成 -->
        </div>
    </div>
    
    <!-- 底部控制栏感应区 -->
    <div class="controls-hover-area" id="controls-hover-area"></div>
    
    <!-- 底部控制区 -->
    <div class="player-controls" id="player-controls">
        <div class="current-track-info">
            <div class="album-art-small">
                <img id="album-art-small" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Crect width='60' height='60' fill='%23333'/%3E%3Cpath d='M30,15 L40,25 L40,45 L20,45 L20,25 Z' fill='%23222'/%3E%3Ccircle cx='30' cy='30' r='10' fill='%233b82f6'/%3E%3C/svg%3E" alt="专辑封面">
            </div>
            <div class="track-info-small">
                <h3 class="track-title-small" id="track-title-small">选择音乐文件</h3>
                <p class="track-artist-small" id="track-artist-small">等待加载...</p>
            </div>
        </div>
        
        <div class="progress-section">
            <div class="progress-controls">
                <button class="control-btn" id="shuffle-btn" title="随机播放">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M14.83,13.41L13.42,14.82L16.55,17.95L14.5,20H20V14.5L17.96,16.54L14.83,13.41M14.5,4L16.54,6.04L4,18.59L5.41,20L17.96,7.46L20,9.5V4M10.59,9.17L5.41,4L4,5.41L9.17,10.58L10.59,9.17Z" />
                    </svg>
                </button>
                <button class="control-btn" id="prev-btn" title="上一曲">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M6,6H8V18H6M9.5,12L18,18V6M16,14.14L12.97,12L16,9.86V14.14Z" />
                    </svg>
                </button>
                <button class="control-btn play-btn" id="play-btn" title="播放">
                    <svg class="icon" id="play-icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z" />
                    </svg>
                </button>
                <button class="control-btn" id="next-btn" title="下一曲">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M6,18L14.5,12L6,6M16,6V18H18V6H16Z" />
                    </svg>
                </button>
                <button class="control-btn" id="repeat-btn" title="循环播放">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M17,17H7V14L3,18L7,22V19H19V13H17M7,7H17V10L21,6L17,2V5H5V11H7V7Z" />
                    </svg>
                </button>
            </div>
            
            <div class="progress-container">
                <span class="current-time" id="current-time">0:00</span>
                <div class="progress-bar-container" id="progress-bar-container">
                    <div class="progress-bar" id="progress-bar">
                        <div class="progress-thumb"></div>
                    </div>
                </div>
                <span class="total-time" id="total-time">0:00</span>
            </div>
        </div>
        
        <div class="control-buttons">
            <!-- 设置按钮 -->
            <button class="control-btn" id="settings-btn" title="设置">
                <svg class="icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                </svg>
            </button>
            
            <!-- 锁定按钮 -->
            <button class="control-btn" id="lock-controls-btn" title="锁定控制栏">
                <svg class="icon" id="lock-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="square" stroke-linejoin="miter" fill="none" color="currentColor">
                    <!-- 锁定状态图标（默认显示锁定） -->
                    <rect width="14" height="10" x="5" y="11"/>
                    <path d="M7,7.625 L7,7 C7,4.23857625 9.23857625,2 12,2 L12,2 C14.7614237,2 17,4.23857625 17,7 L17,11"/>
                    <circle cx="12" cy="16" r="1"/>
                </svg>
            </button>
            
            <!-- 可视化效果开关按钮 -->
            <button class="control-btn" id="visualizer-toggle-btn" title="开关音频可视化">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <!-- 音频可视化声波（左右对称，仅6根柱形，长度缩短，间距更大） -->
                    <g transform="translate(12, 12)">
                        <!-- 左侧声波（3根柱形，间距均匀，高度梯度更自然） -->
                        <rect x="-9" y="-3.5" width="1.5" height="7" fill="white" rx="0.75" />
                        <rect x="-5.5" y="-6" width="1.5" height="12" fill="white" rx="0.75" />
                        <rect x="-2" y="-4.5" width="1.5" height="9" fill="white" rx="0.75" />
                        
                        <!-- 右侧声波（与左侧严格对称，视觉平衡感更强） -->
                        <rect x="0.5" y="-4.5" width="1.5" height="9" fill="white" rx="0.75" />
                        <rect x="4" y="-6" width="1.5" height="12" fill="white" rx="0.75" />
                        <rect x="7.5" y="-3.5" width="1.5" height="7" fill="white" rx="0.75" />
                    </g>
                </svg>
            </button>
            
            <!-- 歌词管理按钮 -->
            <button class="control-btn" id="lyrics-manager-btn" title="歌词管理">
                <svg class="icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M3,6H21V4H3C1.9,4 1,4.9 1,6V18C1,19.1 1.9,20 3,20H7V18H3V6M15,11H9V13H15V11M19,15H9V17H19V15M19,7H9V9H19V7Z" />
                </svg>
            </button>
            
            <div class="volume-container">
                <svg class="icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z" />
                </svg>
                <input type="range" min="0" max="100" value="100" class="volume-slider" id="volume-slider">
            </div>
        </div>
        
        <!-- 歌词管理面板 -->
        <div class="lyrics-manager-panel" id="lyrics-manager-panel">
            <div class="lyrics-manager-header">
                <h3>歌词管理</h3>
                <button class="control-btn" id="close-lyrics-manager-btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                    </svg>
                </button>
            </div>
            <div class="lyrics-manager-search">
                <input type="text" class="lyrics-search-input" id="lyrics-search-input" placeholder="搜索歌词文件...">
            </div>
            <div class="lyrics-manager-list" id="lyrics-manager-list">
                <!-- 歌词文件列表将动态生成 -->
                <div class="no-lyrics">暂无歌词文件</div>
            </div>
            <div class="lyrics-manager-footer">
                <button class="lyrics-manager-btn" id="import-lyrics-file-btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" />
                    </svg>
                    导入歌词文件
                </button>
                <button class="lyrics-manager-btn" id="import-lyrics-folder-btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z" />
                    </svg>
                    导入歌词文件夹
                </button>
                <button class="lyrics-manager-btn primary" id="auto-match-lyrics-btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M10,17L6,13L7.41,11.59L10,14.17L16.59,7.58L18,9" />
                    </svg>
                    自动匹配歌词
                </button>
            </div>
        </div>
        
        <!-- 设置面板 -->
        <div class="settings-panel" id="settings-panel">
            <div class="settings-header">
                <h3>播放器设置</h3>
                <button class="control-btn" id="close-settings-btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                    </svg>
                </button>
            </div>
            <div class="settings-content">
                <!-- 播放设置分组 -->
                <div class="settings-group">
                    <div class="settings-group-title" onclick="toggleSettingsGroup(this)">
                        <span>播放设置</span>
                        <svg class="settings-group-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
                        </svg>
                    </div>
                    <div class="settings-group-content collapsed">
                        <div class="setting-item">
                            <div class="toggle-container">
                                <span class="toggle-label">随机播放</span>
                                <div class="setting-toggle" id="settings-shuffle-toggle">
                                    <span class="setting-value" id="settings-shuffle-value">关闭</span>
                                </div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="toggle-container">
                                <span class="toggle-label">循环播放</span>
                                <div class="setting-toggle" id="settings-repeat-toggle">
                                    <span class="setting-value" id="settings-repeat-value">关闭</span>
                                </div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="toggle-container">
                                <span class="toggle-label">音频可视化</span>
                                <div class="setting-toggle active" id="settings-visualizer-toggle">
                                    <span class="setting-value" id="settings-visualizer-value">开启</span>
                                </div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="toggle-container">
                                <span class="toggle-label">锁定控制栏</span>
                                <div class="setting-toggle" id="settings-lock-toggle">
                                    <span class="setting-value" id="settings-lock-value">关闭</span>
                                </div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>音量</span>
                                <span class="setting-value" id="settings-volume-value">100%</span>
                            </div>
                            <input type="range" min="0" max="100" value="100" class="setting-slider" id="settings-volume-slider">
                        </div>
                    </div>
                </div>
                <!-- 专辑封面设置分组 -->
                <div class="settings-group">
                    <div class="settings-group-title" onclick="toggleSettingsGroup(this)">
                        <span>专辑封面</span>
                        <svg class="settings-group-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
                        </svg>
                    </div>
                    <div class="settings-group-content collapsed">
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>封面旋转速度</span>
                                <span class="setting-value" id="album-art-rotation-speed-value">70%</span>
                            </div>
                            <input type="range" min="0" max="100" value="70" class="setting-slider" id="album-art-rotation-speed-slider">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>封面大小</span>
                                <span class="setting-value" id="album-art-size-value">100%</span>
                            </div>
                            <input type="range" min="50" max="150" value="100" class="setting-slider" id="album-art-size-slider">
                        </div>
                        <!-- 新增：封面联动动画开关 -->
                        <div class="setting-item">
                            <div class="toggle-container">
                                <span class="toggle-label">封面联动动画</span>
                                <div class="setting-toggle active" id="album-art-animation-toggle">
                                    <span class="setting-value" id="album-art-animation-value">开启</span>
                                </div>
                            </div>
                        </div>
                        <!-- 新增：缩放方向开关 -->
                        <div class="setting-item">
                            <div class="toggle-container">
                                <span class="toggle-label">缩放方向</span>
                                <div class="setting-toggle active" id="zoom-direction-toggle">
                                    <span class="setting-value" id="zoom-direction-value">放大</span>
                                </div>
                            </div>
                        </div>
                        <!-- 新增：鼓声峰值阈值 -->
                        <div class="setting-item" style="display: none;">
                            <div class="setting-label">
                                <span>鼓声峰值阈值</span>
                                <span class="setting-value" id="peak-threshold-value">60%</span>
                            </div>
                            <input type="range" min="10" max="90" value="60" class="setting-slider" id="peak-threshold-slider">
                        </div>
                        
                        <!-- 新增：封面变化程度 -->
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>封面变化程度</span>
                                <span class="setting-value" id="change-intensity-value">100%</span>
                            </div>
                            <input type="range" min="0" max="200" value="100" class="setting-slider" id="change-intensity-slider">
                        </div>

                        <!-- 新增：封面图片大小 -->
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>封面图片大小</span>
                                <span class="setting-value" id="cover-image-size-value">100%</span>
                            </div>
                            <input type="range" min="50" max="150" value="100" class="setting-slider" id="cover-image-size-slider">
                        </div>
                    </div>
                </div>
                
                <!-- 背景设置分组 -->
                <div class="settings-group">
                    <div class="settings-group-title" onclick="toggleSettingsGroup(this)">
                        <span>背景设置</span>
                        <svg class="settings-group-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
                        </svg>
                    </div>
                    <div class="settings-group-content collapsed">
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>背景亮度</span>
                                <span class="setting-value" id="background-brightness-value">70%</span>
                            </div>
                            <input type="range" min="0" max="100" value="70" class="setting-slider" id="background-brightness-slider">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>背景模糊度</span>
                                <span class="setting-value" id="blur-intensity-value">20%</span>
                            </div>
                            <input type="range" min="0" max="100" value="20" class="setting-slider" id="blur-intensity-slider">
                        </div>
                    </div>
                </div>
                
                <!-- 可视化设置分组 -->
                <div class="settings-group">
                    <div class="settings-group-title" onclick="toggleSettingsGroup(this)">
                        <span>可视化效果</span>
                        <svg class="settings-group-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
                        </svg>
                    </div>
                    <div class="settings-group-content collapsed">
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>渐变强度</span>
                                <span class="setting-value" id="gradient-intensity-value">50%</span>
                            </div>
                            <input type="range" min="0" max="100" value="50" class="setting-slider" id="gradient-intensity-slider">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>响应曲线</span>
                                <span class="setting-value" id="response-curve-value">-100%</span>
                            </div>
                            <input type="range" min="-100" max="100" value="-100" class="setting-slider" id="response-curve-slider">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>平滑度</span>
                                <span class="setting-value" id="smoothness-value">0%</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="setting-slider" id="smoothness-slider">
                        </div>
                    </div>
                </div>
                
                <!-- 颜色设置分组 -->
                <div class="settings-group">
                    <div class="settings-group-title" onclick="toggleSettingsGroup(this)">
                        <span>颜色设置</span>
                        <svg class="settings-group-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
                        </svg>
                    </div>
                    <div class="settings-group-content collapsed">
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>饱和度</span>
                                <span class="setting-value" id="saturation-value">100%</span>
                            </div>
                            <input type="range" min="0" max="200" value="100" class="setting-slider" id="saturation-slider">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>透明度</span>
                                <span class="setting-value" id="transparency-value">100%</span>
                            </div>
                            <input type="range" min="0" max="100" value="100" class="setting-slider" id="transparency-slider">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>亮度</span>
                                <span class="setting-value" id="brightness-value">100%</span>
                            </div>
                            <input type="range" min="0" max="100" value="100" class="setting-slider" id="brightness-slider">
                        </div>
                    </div>
                </div>
                
                <!-- 歌词匹配设置分组 -->
                <div class="settings-group">
                    <div class="settings-group-title" onclick="toggleSettingsGroup(this)">
                        <span>歌词匹配</span>
                        <svg class="settings-group-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
                        </svg>
                    </div>
                    <div class="settings-group-content collapsed">
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>最低匹配程度</span>
                                <span class="setting-value" id="min-match-score-value">50%</span>
                            </div>
                            <input type="range" min="0" max="100" value="50" class="setting-slider" id="min-match-score-slider">
                        </div>
                        <div class="setting-item">
                            <div class="toggle-container">
                                <span class="toggle-label">播放时自动匹配歌词</span>
                                <div class="setting-toggle active" id="auto-match-on-play-toggle">
                                    <span class="setting-value" id="auto-match-on-play-value">开启</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 粒子设置分组 -->
                <div class="settings-group">
                    <div class="settings-group-title" onclick="toggleSettingsGroup(this)">
                        <span>粒子效果</span>
                        <svg class="settings-group-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
                        </svg>
                    </div>
                    <div class="settings-group-content collapsed">
                        <div class="setting-item">
                            <div class="toggle-container">
                                <span class="toggle-label">粒子效果</span>
                                <div class="setting-toggle active" id="particles-enabled-toggle">
                                    <span class="setting-value" id="particles-enabled-value">开启</span>
                                </div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>粒子数量</span>
                                <span class="setting-value" id="particles-count-value">320</span>
                            </div>
                            <input type="range" min="10" max="9192" value="320" class="setting-slider" id="particles-count-slider">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>粒子大小</span>
                                <span class="setting-value" id="particles-size-value">2</span>
                            </div>
                            <input type="range" min="1" max="10" value="2" class="setting-slider" id="particles-size-slider">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>粒子透明度</span>
                                <span class="setting-value" id="particles-opacity-value">80%</span>
                            </div>
                            <input type="range" min="5" max="100" value="80" class="setting-slider" id="particles-opacity-slider">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>粒子响应度</span>
                                <span class="setting-value" id="particles-response-value">100%</span>
                            </div>
                            <input type="range" min="0" max="500" value="100" class="setting-slider" id="particles-response-slider">
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <!-- 新增：设置导入导出按钮 -->
                <button class="settings-btn" id="export-settings-btn" title="导出当前设置到 'audio_player_settings.json' 文件">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" />
                    </svg>
                    导出设置
                </button>
                <button class="settings-btn" id="import-settings-btn" title="导入设置文件">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" />
                    </svg>
                    导入设置
                </button>
                <button class="settings-btn" id="reset-settings-btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6Z" />
                    </svg>
                    重置设置
                </button>
                <button class="settings-btn" id="close-settings-btn-footer">关闭</button>
            </div>
        </div>
    </div>

    <!-- 隐藏的文件输入 -->
    <input type="file" id="lyrics-file-input" accept=".lrc,.txt" multiple>
    <input type="file" id="lyrics-folder-input" webkitdirectory directory multiple>
    <!-- 新增：设置文件输入 -->
    <input type="file" id="settings-file-input" accept=".json" style="display: none;">
    <!-- 歌曲添加到歌单的上下文菜单 -->
    <div class="song-context-menu" id="song-context-menu">
        <div class="context-menu-header">
            <span>添加到歌单</span>
            <button class="control-btn" id="close-context-menu-btn">
                <svg class="icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                </svg>
            </button>
        </div>
        <div class="context-menu-list" id="context-menu-list">
            <!-- 歌单选项将动态生成 -->
        </div>
    </div>

    <!-- 新建歌单输入框 -->
    <div class="create-playlist-dialog" id="create-playlist-dialog">
        <div class="dialog-content">
            <h3>新建歌单</h3>
            <input type="text" id="new-playlist-name" placeholder="输入歌单名称" maxlength="50">
            <div class="dialog-buttons">
                <button class="dialog-btn" id="cancel-create-playlist-btn">取消</button>
                <button class="dialog-btn primary" id="confirm-create-playlist-btn">创建</button>
            </div>
        </div>
    </div>

    <script>
        /* ============================================
           全局变量声明
           ============================================ */
        
        // 音频播放相关变量
        let audio = new Audio();
        let currentTrackIndex = 0;
        let isPlaying = false;
        let isShuffled = false;
        let isDraggingProgress = false;
        let isDraggingTopProgress = false;
        let tracks = [];
        let lyricsData = [];
        let currentLyricIndex = -1;
        let hideControlsTimeout;
        let lastLyricUpdateTime = 0;
        let isControlsLocked = false;
        let lyricsFiles = [];
        let isVisualizerEnabled = true;

        // 音频分析相关变量
        let audioContext = null;
        let analyser = null;
        let source = null;
        let dataArray = null;
        let bufferLength = null;
        let visualizerBars = [];
        let animationId = null;
        let visualizerTimeout = null;
        let visualizerColor = '#3b82f6';

        // 歌词匹配相关变量
        let minMatchScore = 80; // 最低匹配程度（0-100）
        let autoMatchOnPlay = true; // 播放时自动匹配歌词
        let tracksMatchAttempted = new Set(); // 记录已尝试匹配的歌曲

        // 粒子系统相关变量
        let particlesCanvas = document.getElementById('particles-canvas');
        let particlesCtx = particlesCanvas.getContext('2d');
        let particles = [];
        let particlesEnabled = true;
        let particlesCount = 320;
        let particlesOpacity = 0.8;
        let particlesSize = 2;
        let particlesResponse = 1.0;
        let baseSpeed = 0.8;
        let volumeMultiplier = 1;
        let particlesAnimationId = null;

        // 音频分析历史记录
        let lastVolumeValues = [];
        const volumeHistorySize = 5;

        // 封面联动动画相关变量
        let isAlbumArtAnimationEnabled = true; // 封面联动动画开关
        let zoomDirection = true; // 缩放方向：true为放大，false为缩小
        let peakThreshold = 0.6; // 鼓声峰值阈值 (0-1)
        let coverImageSize = 1.0; // 封面图片大小 (0.5-1.5)
        let changeIntensity = 1.0; // 封面变化程度 (0-2)
        let currentImageScale = 1.0; // 当前图片缩放值
        let lastPeakTime = 0; // 上次峰值时间
        let lowFreqEnergyHistory = []; // 低频能量历史记录
        const historySize = 5; // 历史记录大小
        const minPeakInterval = 10; // 最小峰值间隔(毫秒)

        // 封面联动动画优化变量
        let animationState = {
            currentScale: 1.0,
            targetScale: 1.0,
            velocity: 0,
            isAnimating: false,
            lastAnimationTime: 0,
            smoothFactor: 0.15,
            maxVelocity: 0.05,
            energyHistory: [],
            energyHistorySize: 15
        };

        // 新增：动画历史记录
        let smoothedEnergy = 0;

        // 可视化设置参数
        let visualizerSettings = {
            gradientIntensity: 50,
            responseCurve: -100,
            smoothness: 0,
            saturation: 100,
            transparency: 100,
            brightness: 100,
            blurIntensity: 20,
            albumArtRotationSpeed: 70,
            albumArtSize: 100,
            backgroundBrightness: 70,
            minMatchScore: 50,
            autoMatchOnPlay: true
        };

        // 淡入淡出相关变量
        let fadeInterval = null;
        const fadeDuration = 500; // 淡入淡出持续时间（毫秒）

        // 歌单相关变量
        let playlists = []; // 歌单数组
        let currentPlaylistId = null; // 当前选中的歌单ID，null表示全部歌曲
        let contextMenuSongIndex = null; // 上下文菜单对应的歌曲索引
        
        /* ============================================
           DOM元素获取
           ============================================ */
        
        // 播放器控制相关
        const playlistSection = document.getElementById('playlist-section');
        const showPlaylistBtn = document.getElementById('show-playlist-btn');
        const hidePlaylistBtnExternal = document.getElementById('hide-playlist-btn-external');
        const playBtn = document.getElementById('play-btn');
        const playIcon = document.getElementById('play-icon');
        const albumArtPlayIcon = document.getElementById('album-art-play-icon');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const lockControlsBtn = document.getElementById('lock-controls-btn');
        const lockIcon = document.getElementById('lock-icon');
        const visualizerToggleBtn = document.getElementById('visualizer-toggle-btn');
        const lyricsManagerBtn = document.getElementById('lyrics-manager-btn');
        const closeLyricsManagerBtn = document.getElementById('close-lyrics-manager-btn');
        const lyricsManagerPanel = document.getElementById('lyrics-manager-panel');
        const lyricsManagerList = document.getElementById('lyrics-manager-list');
        const lyricsSearchInput = document.getElementById('lyrics-search-input');
        const importLyricsFileBtn = document.getElementById('import-lyrics-file-btn');
        const importLyricsFolderBtn = document.getElementById('import-lyrics-folder-btn');
        const autoMatchLyricsBtn = document.getElementById('auto-match-lyrics-btn');
        const lyricsFileInput = document.getElementById('lyrics-file-input');
        const lyricsFolderInput = document.getElementById('lyrics-folder-input');
        const shufflePlaylistBtn = document.getElementById('shuffle-playlist-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const volumeSlider = document.getElementById('volume-slider');
        const fileInput = document.getElementById('file-input');
        const folderInput = document.getElementById('folder-input');
        const playlistContainer = document.getElementById('playlist-container');
        const trackTitleSmall = document.getElementById('track-title-small');
        const trackArtistSmall = document.getElementById('track-artist-small');
        const albumArtLarge = document.getElementById('album-art-large');
        const albumArtSmall = document.getElementById('album-art-small');
        const backgroundBlur = document.getElementById('background-blur');
        const lyricsSection = document.getElementById('lyrics-section');
        const albumArtContainer = document.getElementById('album-art-container');
        const lyricsTitle = document.getElementById('lyrics-title');
        const lyricsArtist = document.getElementById('lyrics-artist');
        const lyricsContainer = document.getElementById('lyrics-container');
        const playerControls = document.getElementById('player-controls');
        const controlsHoverArea = document.getElementById('controls-hover-area');
        const topProgressBar = document.getElementById('top-progress-bar');
        const topProgress = document.getElementById('top-progress');
        const timeTooltip = document.getElementById('time-tooltip');
        const audioVisualizer = document.getElementById('audio-visualizer');
        const visualizerContainer = document.getElementById('visualizer-container');
        
        // 隐藏式控制按钮
        const prevBtnHidden = document.getElementById('prev-btn-hidden');
        const playPauseBtnHidden = document.getElementById('play-pause-btn-hidden');
        const playPauseIconHidden = document.getElementById('play-pause-icon-hidden');
        const nextBtnHidden = document.getElementById('next-btn-hidden');
        
        // 设置面板相关
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const resetSettingsBtn = document.getElementById('reset-settings-btn');
        const closeSettingsBtnFooter = document.getElementById('close-settings-btn-footer');
        
        // 新增：设置导入导出按钮
        const exportSettingsBtn = document.getElementById('export-settings-btn');
        const importSettingsBtn = document.getElementById('import-settings-btn');
        const settingsFileInput = document.getElementById('settings-file-input');
        
        // 设置滑块DOM元素
        const gradientIntensitySlider = document.getElementById('gradient-intensity-slider');
        const responseCurveSlider = document.getElementById('response-curve-slider');
        const smoothnessSlider = document.getElementById('smoothness-slider');
        const saturationSlider = document.getElementById('saturation-slider');
        const transparencySlider = document.getElementById('transparency-slider');
        const brightnessSlider = document.getElementById('brightness-slider');
        const blurIntensitySlider = document.getElementById('blur-intensity-slider');
        const albumArtRotationSpeedSlider = document.getElementById('album-art-rotation-speed-slider');
        const albumArtSizeSlider = document.getElementById('album-art-size-slider');
        const backgroundBrightnessSlider = document.getElementById('background-brightness-slider');
        const minMatchScoreSlider = document.getElementById('min-match-score-slider');
        const autoMatchOnPlayToggle = document.getElementById('auto-match-on-play-toggle');
        
        // 封面设置DOM元素
        const albumArtAnimationToggle = document.getElementById('album-art-animation-toggle');
        const albumArtAnimationValue = document.getElementById('album-art-animation-value');
        const zoomDirectionToggle = document.getElementById('zoom-direction-toggle');
        const zoomDirectionValue = document.getElementById('zoom-direction-value');
        const peakThresholdSlider = document.getElementById('peak-threshold-slider');
        const peakThresholdValue = document.getElementById('peak-threshold-value');
        const coverImageSizeSlider = document.getElementById('cover-image-size-slider');
        const coverImageSizeValue = document.getElementById('cover-image-size-value');
        const changeIntensitySlider = document.getElementById('change-intensity-slider');
        const changeIntensityValue = document.getElementById('change-intensity-value');
        const albumArtBackground = document.getElementById('album-art-background');
        
        // 粒子设置DOM元素
        const particlesEnabledToggle = document.getElementById('particles-enabled-toggle');
        const particlesCountSlider = document.getElementById('particles-count-slider');
        const particlesSizeSlider = document.getElementById('particles-size-slider');
        const particlesOpacitySlider = document.getElementById('particles-opacity-slider');
        const particlesResponseSlider = document.getElementById('particles-response-slider');
        
        // 设置值显示DOM元素
        const gradientIntensityValue = document.getElementById('gradient-intensity-value');
        const responseCurveValue = document.getElementById('response-curve-value');
        const smoothnessValue = document.getElementById('smoothness-value');
        const saturationValue = document.getElementById('saturation-value');
        const transparencyValue = document.getElementById('transparency-value');
        const brightnessValue = document.getElementById('brightness-value');
        const blurIntensityValue = document.getElementById('blur-intensity-value');
        const albumArtRotationSpeedValue = document.getElementById('album-art-rotation-speed-value');
        const albumArtSizeValue = document.getElementById('album-art-size-value');
        const backgroundBrightnessValue = document.getElementById('background-brightness-value');
        const minMatchScoreValue = document.getElementById('min-match-score-value');
        const autoMatchOnPlayValue = document.getElementById('auto-match-on-play-value');
        const particlesEnabledValue = document.getElementById('particles-enabled-value');
        const particlesCountValue = document.getElementById('particles-count-value');
        const particlesSizeValue = document.getElementById('particles-size-value');
        const particlesOpacityValue = document.getElementById('particles-opacity-value');
        const particlesResponseValue = document.getElementById('particles-response-value');
        
        // 播放设置DOM元素
        const settingsShuffleToggle = document.getElementById('settings-shuffle-toggle');
        const settingsShuffleValue = document.getElementById('settings-shuffle-value');
        const settingsRepeatToggle = document.getElementById('settings-repeat-toggle');
        const settingsRepeatValue = document.getElementById('settings-repeat-value');
        const settingsVisualizerToggle = document.getElementById('settings-visualizer-toggle');
        const settingsVisualizerValue = document.getElementById('settings-visualizer-value');
        const settingsLockToggle = document.getElementById('settings-lock-toggle');
        const settingsLockValue = document.getElementById('settings-lock-value');
        const settingsVolumeSlider = document.getElementById('settings-volume-slider');
        const settingsVolumeValue = document.getElementById('settings-volume-value');

        // 歌单管理相关元素
        const playlistManagerBtn = document.getElementById('playlist-manager-btn');
        const closePlaylistManagerBtn = document.getElementById('close-playlist-manager-btn');
        const playlistManagerPanel = document.getElementById('playlist-manager-panel');
        const playlistManagerList = document.getElementById('playlist-manager-list');
        const createPlaylistBtn = document.getElementById('create-playlist-btn');
        const exportPlaylistsBtn = document.getElementById('export-playlists-btn');
        const importPlaylistsBtn = document.getElementById('import-playlists-btn');
        const importPlaylistsFileInput = document.getElementById('import-playlists-file-input');

        // 上下文菜单相关元素
        const songContextMenu = document.getElementById('song-context-menu');
        const closeContextMenuBtn = document.getElementById('close-context-menu-btn');
        const contextMenuList = document.getElementById('context-menu-list');

        // 新建歌单对话框相关元素
        const createPlaylistDialog = document.getElementById('create-playlist-dialog');
        const newPlaylistNameInput = document.getElementById('new-playlist-name');
        const cancelCreatePlaylistBtn = document.getElementById('cancel-create-playlist-btn');
        const confirmCreatePlaylistBtn = document.getElementById('confirm-create-playlist-btn');
        // 全部歌曲按钮元素
        const allSongsBtn = document.getElementById('all-songs-btn');

        /* ============================================
           初始化函数
           ============================================ */
        
        // 初始化播放器
        function initPlayer() {
            // 初始化粒子系统
            initParticles();
            
            // 应用默认设置
            applyDefaultSettings();
            
            // 绑定事件监听
            bindEventListeners();
            
            // 初始化可视化效果
            createVisualizerBars();
            
            // 控制栏自动隐藏
            setupAutoHideControls();
            
            // 初始化音量
            setVolume();
            
            // 初始化MediaSession API
            initMediaSession();

            // 初始化拖放功能
            initDragAndDrop();
            
            // 响应式调整
            adjustLayout();
            window.addEventListener('resize', adjustLayout);
            
            // 应用初始设置
            applySettings();

            // 初始化歌单
            loadPlaylists();
        }
        
        // 绑定事件监听器
        function bindEventListeners() {
            // 播放控制事件
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', prevTrack);
            nextBtn.addEventListener('click', nextTrack);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', toggleRepeat);
            lockControlsBtn.addEventListener('click', toggleControlsLock);
            visualizerToggleBtn.addEventListener('click', toggleVisualizer);
            
            // 隐藏式控制按钮事件
            prevBtnHidden.addEventListener('click', prevTrack);
            playPauseBtnHidden.addEventListener('click', togglePlay);
            nextBtnHidden.addEventListener('click', nextTrack);
            
            // 歌词管理事件
            lyricsManagerBtn.addEventListener('click', toggleLyricsManager);
            closeLyricsManagerBtn.addEventListener('click', closeLyricsManager);
            importLyricsFileBtn.addEventListener('click', () => lyricsFileInput.click());
            importLyricsFolderBtn.addEventListener('click', () => lyricsFolderInput.click());
            autoMatchLyricsBtn.addEventListener('click', autoMatchAllTracksWithLyrics);
            lyricsFileInput.addEventListener('change', handleLyricsFileSelect);
            lyricsFolderInput.addEventListener('change', handleLyricsFolderSelect);
            lyricsSearchInput.addEventListener('input', filterLyricsList);
            
            // 播放列表事件
            shufflePlaylistBtn.addEventListener('click', shufflePlaylist);
            hidePlaylistBtnExternal.addEventListener('click', hidePlaylist);
            showPlaylistBtn.addEventListener('click', showPlaylist);
            volumeSlider.addEventListener('input', setVolume);
            fileInput.addEventListener('change', handleFileSelect);
            folderInput.addEventListener('change', handleFolderSelect);
            
            // 设置面板事件
            settingsBtn.addEventListener('click', toggleSettings);
            closeSettingsBtn.addEventListener('click', closeSettings);
            closeSettingsBtnFooter.addEventListener('click', closeSettings);
            resetSettingsBtn.addEventListener('click', resetSettings);
            
            // 新增：设置导入导出事件
            exportSettingsBtn.addEventListener('click', exportSettings);
            importSettingsBtn.addEventListener('click', () => settingsFileInput.click());
            settingsFileInput.addEventListener('change', handleSettingsFileSelect);
            
            // 设置滑块事件
            gradientIntensitySlider.addEventListener('input', updateSettingValue);
            responseCurveSlider.addEventListener('input', updateSettingValue);
            smoothnessSlider.addEventListener('input', updateSettingValue);
            saturationSlider.addEventListener('input', updateSettingValue);
            transparencySlider.addEventListener('input', updateSettingValue);
            brightnessSlider.addEventListener('input', updateSettingValue);
            blurIntensitySlider.addEventListener('input', updateSettingValue);
            albumArtRotationSpeedSlider.addEventListener('input', updateSettingValue);
            albumArtSizeSlider.addEventListener('input', updateSettingValue);
            backgroundBrightnessSlider.addEventListener('input', updateSettingValue);
            minMatchScoreSlider.addEventListener('input', updateSettingValue);
            autoMatchOnPlayToggle.addEventListener('click', toggleAutoMatchOnPlay);
            
            // 封面联动动画设置事件
            albumArtAnimationToggle.addEventListener('click', toggleAlbumArtAnimation);
            zoomDirectionToggle.addEventListener('click', toggleZoomDirection);
            peakThresholdSlider.addEventListener('input', updateAlbumArtAnimationSettings);
            coverImageSizeSlider.addEventListener('input', updateCoverImageSize);
            changeIntensitySlider.addEventListener('input', updateChangeIntensity);
            
            // 粒子设置事件
            particlesEnabledToggle.addEventListener('click', toggleParticles);
            particlesCountSlider.addEventListener('input', updateParticlesSettings);
            particlesSizeSlider.addEventListener('input', updateParticlesSettings);
            particlesOpacitySlider.addEventListener('input', updateParticlesSettings);
            particlesResponseSlider.addEventListener('input', updateParticlesSettings);
            
            // 音频事件
            audio.addEventListener('loadedmetadata', updateDuration);
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', nextTrack);
            audio.addEventListener('play', initAudioVisualizer);
            audio.addEventListener('pause', stopAudioVisualizer);
            audio.addEventListener('ended', stopAudioVisualizer);
            
            // 进度条事件
            progressBarContainer.addEventListener('click', setProgress);
            progressBarContainer.addEventListener('mousedown', startDragProgress);
            document.addEventListener('mousemove', dragProgress);
            document.addEventListener('mouseup', stopDragProgress);
            
            // 顶部进度条事件
            topProgressBar.addEventListener('click', setProgressTop);
            topProgressBar.addEventListener('mousedown', startDragProgressTop);
            document.addEventListener('mousemove', dragProgressTop);
            document.addEventListener('mouseup', stopDragProgressTop);

            // 播放设置事件
            settingsShuffleToggle.addEventListener('click', toggleSettingsShuffle);
            settingsRepeatToggle.addEventListener('click', toggleSettingsRepeat);
            settingsVisualizerToggle.addEventListener('click', toggleSettingsVisualizer);
            settingsLockToggle.addEventListener('click', toggleSettingsLock);
            settingsVolumeSlider.addEventListener('input', updateSettingsVolume);

            // 歌单管理事件
            playlistManagerBtn.addEventListener('click', togglePlaylistManager);
            closePlaylistManagerBtn.addEventListener('click', closePlaylistManager);
            createPlaylistBtn.addEventListener('click', openCreatePlaylistDialog);
            exportPlaylistsBtn.addEventListener('click', exportPlaylists);
            importPlaylistsBtn.addEventListener('click', () => importPlaylistsFileInput.click());
            importPlaylistsFileInput.addEventListener('change', handleImportPlaylistsFile);

            // 全部歌曲按钮事件
            if (allSongsBtn) {
                allSongsBtn.addEventListener('click', selectAllSongs);
            }

            // 新建歌单对话框事件
            cancelCreatePlaylistBtn.addEventListener('click', closeCreatePlaylistDialog);
            confirmCreatePlaylistBtn.addEventListener('click', createNewPlaylist);
            newPlaylistNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    createNewPlaylist();
                }
            });

            // 上下文菜单事件
            closeContextMenuBtn.addEventListener('click', closeContextMenu);
        }
        
        // 应用默认设置
        function applyDefaultSettings() {
            // 设置滑块默认值
            albumArtRotationSpeedSlider.value = 70;
            blurIntensitySlider.value = 20;
            responseCurveSlider.value = -100;
            smoothnessSlider.value = 0;
            minMatchScoreSlider.value = 80;
            particlesCountSlider.value = 320;
            particlesSizeSlider.value = 2;
            particlesOpacitySlider.value = 80;
            particlesResponseSlider.value = 100;
            peakThresholdSlider.value = 60;
            coverImageSizeSlider.value = 100;
            changeIntensitySlider.value = 100;
            
            // 确保缩放方向开关为激活状态（放大）
            zoomDirectionToggle.classList.add('active');
            zoomDirection = true;
            zoomDirectionValue.textContent = '放大';
            
            // 更新显示值
            updateSettingValue();
            updateParticlesSettings();
            updateAlbumArtAnimationSettings();
            updateCoverImageSize();
            updateChangeIntensity();
        }
        
        /* ============================================
           设置导入导出功能
           ============================================ */
        
        // 导出设置
        function exportSettings() {
            // 收集当前所有设置
            const settings = {
                // 播放设置
                isShuffled: isShuffled,
                audioLoop: audio.loop,
                isVisualizerEnabled: isVisualizerEnabled,
                isControlsLocked: isControlsLocked,
                volume: parseInt(volumeSlider.value),
                // 滑块设置
                gradientIntensity: parseInt(gradientIntensitySlider.value),
                responseCurve: parseInt(responseCurveSlider.value),
                smoothness: parseInt(smoothnessSlider.value),
                saturation: parseInt(saturationSlider.value),
                transparency: parseInt(transparencySlider.value),
                brightness: parseInt(brightnessSlider.value),
                blurIntensity: parseInt(blurIntensitySlider.value),
                albumArtRotationSpeed: parseInt(albumArtRotationSpeedSlider.value),
                albumArtSize: parseInt(albumArtSizeSlider.value),
                backgroundBrightness: parseInt(backgroundBrightnessSlider.value),
                minMatchScore: parseInt(minMatchScoreSlider.value),
                
                // 封面联动动画设置
                isAlbumArtAnimationEnabled: isAlbumArtAnimationEnabled,
                zoomDirection: zoomDirection,
                peakThreshold: parseInt(peakThresholdSlider.value),
                coverImageSize: parseInt(coverImageSizeSlider.value),
                changeIntensity: parseInt(changeIntensitySlider.value),
                
                // 粒子设置
                particlesEnabled: particlesEnabled,
                particlesCount: parseInt(particlesCountSlider.value),
                particlesSize: parseInt(particlesSizeSlider.value),
                particlesOpacity: parseInt(particlesOpacitySlider.value),
                particlesResponse: parseInt(particlesResponseSlider.value),
                
                // 歌词匹配设置
                autoMatchOnPlay: autoMatchOnPlay,
                
                // 其他设置
                volume: parseInt(volumeSlider.value),
                isVisualizerEnabled: isVisualizerEnabled,
                isShuffled: isShuffled,
                audioLoop: audio.loop,
                
                // 元数据
                exportDate: new Date().toISOString(),
                version: "1.0",
                playerName: "音频可视化播放器"
            };
            
            // 转换为JSON字符串
            const settingsJson = JSON.stringify(settings, null, 2);
            
            // 创建Blob对象
            const blob = new Blob([settingsJson], { type: 'application/json' });
            
            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'audio_player_settings.json';
            
            // 触发下载
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            showToast('设置已导出到 audio_player_settings.json 文件');
        }
        
        // 处理设置文件选择
        function handleSettingsFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    importSettings(settings);
                    showToast('设置导入成功');
                } catch (error) {
                    console.error('设置文件解析失败:', error);
                    showToast('设置文件格式错误，导入失败', 3000);
                }
            };
            reader.onerror = function() {
                showToast('读取设置文件失败', 3000);
            };
            reader.readAsText(file);
            
            // 清空输入框，允许重复选择同一文件
            e.target.value = '';
        }
        
        // 导入设置
        function importSettings(settings) {
            // 验证设置文件版本
            if (!settings.playerName || settings.playerName !== "音频可视化播放器") {
                showToast('无效的设置文件', 3000);
                return false;
            }
            
            // 导入播放设置
            if (settings.isShuffled !== undefined) {
                isShuffled = settings.isShuffled;
                settingsShuffleToggle.classList.toggle('active', isShuffled);
                settingsShuffleValue.textContent = isShuffled ? '开启' : '关闭';
                shuffleBtn.style.background = isShuffled ? 'rgba(59, 130, 246, 0.3)' : '';
            }
            
            if (settings.audioLoop !== undefined) {
                audio.loop = settings.audioLoop;
                settingsRepeatToggle.classList.toggle('active', audio.loop);
                settingsRepeatValue.textContent = audio.loop ? '开启' : '关闭';
                repeatBtn.style.background = audio.loop ? 'rgba(59, 130, 246, 0.3)' : '';
            }
            
            if (settings.isVisualizerEnabled !== undefined) {
                isVisualizerEnabled = settings.isVisualizerEnabled;
                settingsVisualizerToggle.classList.toggle('active', isVisualizerEnabled);
                settingsVisualizerValue.textContent = isVisualizerEnabled ? '开启' : '关闭';
                visualizerToggleBtn.style.background = isVisualizerEnabled ? 'rgba(59, 130, 246, 0.3)' : '';
            }
            
            if (settings.volume !== undefined) {
                volumeSlider.value = settings.volume;
                settingsVolumeSlider.value = settings.volume;
                settingsVolumeValue.textContent = `${settings.volume}%`;
                setVolume();
            }
            // 应用滑块设置
            if (settings.gradientIntensity !== undefined) gradientIntensitySlider.value = settings.gradientIntensity;
            if (settings.responseCurve !== undefined) responseCurveSlider.value = settings.responseCurve;
            if (settings.smoothness !== undefined) smoothnessSlider.value = settings.smoothness;
            if (settings.saturation !== undefined) saturationSlider.value = settings.saturation;
            if (settings.transparency !== undefined) transparencySlider.value = settings.transparency;
            if (settings.brightness !== undefined) brightnessSlider.value = settings.brightness;
            if (settings.blurIntensity !== undefined) blurIntensitySlider.value = settings.blurIntensity;
            if (settings.albumArtRotationSpeed !== undefined) albumArtRotationSpeedSlider.value = settings.albumArtRotationSpeed;
            if (settings.albumArtSize !== undefined) albumArtSizeSlider.value = settings.albumArtSize;
            if (settings.backgroundBrightness !== undefined) backgroundBrightnessSlider.value = settings.backgroundBrightness;
            if (settings.minMatchScore !== undefined) minMatchScoreSlider.value = settings.minMatchScore;
            
            // 应用封面联动动画设置
            if (settings.isAlbumArtAnimationEnabled !== undefined) {
                isAlbumArtAnimationEnabled = settings.isAlbumArtAnimationEnabled;
                albumArtAnimationToggle.classList.toggle('active', isAlbumArtAnimationEnabled);
                albumArtAnimationValue.textContent = isAlbumArtAnimationEnabled ? '开启' : '关闭';
            }

            if (settings.zoomDirection !== undefined) {
                zoomDirection = settings.zoomDirection;
                zoomDirectionToggle.classList.toggle('active', zoomDirection);
                zoomDirectionValue.textContent = zoomDirection ? '放大' : '缩小';
            }

            if (settings.peakThreshold !== undefined) peakThresholdSlider.value = settings.peakThreshold;
            if (settings.coverImageSize !== undefined) coverImageSizeSlider.value = settings.coverImageSize;
            if (settings.changeIntensity !== undefined) changeIntensitySlider.value = settings.changeIntensity;
            
            // 应用粒子设置
            if (settings.particlesEnabled !== undefined) {
                particlesEnabled = settings.particlesEnabled;
                particlesEnabledToggle.classList.toggle('active', particlesEnabled);
                particlesEnabledValue.textContent = particlesEnabled ? '开启' : '关闭';
            }
            
            if (settings.particlesCount !== undefined) particlesCountSlider.value = settings.particlesCount;
            if (settings.particlesSize !== undefined) particlesSizeSlider.value = settings.particlesSize;
            if (settings.particlesOpacity !== undefined) particlesOpacitySlider.value = settings.particlesOpacity;
            if (settings.particlesResponse !== undefined) particlesResponseSlider.value = settings.particlesResponse;
            
            // 应用歌词匹配设置
            if (settings.autoMatchOnPlay !== undefined) {
                autoMatchOnPlay = settings.autoMatchOnPlay;
                autoMatchOnPlayToggle.classList.toggle('active', autoMatchOnPlay);
                autoMatchOnPlayValue.textContent = autoMatchOnPlay ? '开启' : '关闭';
            }
            
            // 应用其他设置
            if (settings.volume !== undefined) volumeSlider.value = settings.volume;
            if (settings.isVisualizerEnabled !== undefined) {
                isVisualizerEnabled = settings.isVisualizerEnabled;
                visualizerToggleBtn.style.background = isVisualizerEnabled ? 'rgba(59, 130, 246, 0.3)' : '';
            }
            if (settings.isShuffled !== undefined) {
                isShuffled = settings.isShuffled;
                shuffleBtn.style.background = isShuffled ? 'rgba(59, 130, 246, 0.3)' : '';
            }
            if (settings.audioLoop !== undefined) {
                audio.loop = settings.audioLoop;
                repeatBtn.style.background = audio.loop ? 'rgba(59, 130, 246, 0.3)' : '';
            }
            
            // 更新显示值
            updateSettingValue();
            updateParticlesSettings();
            updateAlbumArtAnimationSettings();
            updateCoverImageSize();
            
            // 应用设置
            applySettings();
            setVolume();
            
            return true;
        }
        
        // 自动从文件夹导入设置文件
        function autoImportSettingsFromFolder(files) {
            // 查找名为 "audio_player_settings.json" 的文件
            const settingsFile = Array.from(files).find(file => 
                file.name === "audio_player_settings.json" || 
                file.name === "audio_player_settings.JSON"
            );
            
            if (settingsFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const settings = JSON.parse(e.target.result);
                        if (importSettings(settings)) {
                            showToast('从文件夹自动导入设置成功');
                        }
                    } catch (error) {
                        console.error('自动导入设置文件失败:', error);
                    }
                };
                reader.readAsText(settingsFile);
            }
        }
        
        /* ============================================
           音频播放控制函数
           ============================================ */
        
        // 切换播放/暂停
        function togglePlay() {
            if (tracks.length === 0) return;
            
            if (isPlaying) {
                // 立即更新状态，防止重复点击
                isPlaying = false;
                playIcon.innerHTML = '<path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z" />';
                playPauseIconHidden.innerHTML = '<path d="M8 5v14l11-7z" fill="none" stroke="currentColor" stroke-width="1.5"/>';
                document.querySelector('.album-art-large').style.animationPlayState = 'paused';
                updateMediaSessionPlaybackState('paused');
                
                // 暂停时淡出
                fadeOutAudio();
            } else {
                // 立即更新状态，防止重复点击
                isPlaying = true;
                playIcon.innerHTML = '<path fill="currentColor" d="M14,19H18V5H14M6,19H10V5H6V19Z" />';
                playPauseIconHidden.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" fill="none" stroke="currentColor" stroke-width="1.5"/>';
                document.querySelector('.album-art-large').style.animationPlayState = 'running';
                updateMediaSessionPlaybackState('playing');
                
                // 播放时淡入
                fadeInAudio();
            }
        }

        // 淡入音频
        function fadeInAudio() {
            if (fadeInterval) clearInterval(fadeInterval);
            
            // 确保音频在播放状态
            audio.play().catch(e => console.error("Play error:", e));
            
            const currentVolume = audio.volume;
            const targetVolume = volumeSlider.value / 100;
            const step = (targetVolume - currentVolume) / (fadeDuration / 50);
            
            let currentStep = 0;
            fadeInterval = setInterval(() => {
                currentStep++;
                audio.volume = currentVolume + (step * currentStep);
                
                if (currentStep >= (fadeDuration / 50) || audio.volume >= targetVolume) {
                    audio.volume = targetVolume;
                    clearInterval(fadeInterval);
                    fadeInterval = null;
                }
            }, 50);
        }

        // 淡出音频
        function fadeOutAudio(callback) {
            if (fadeInterval) clearInterval(fadeInterval);
            
            const currentVolume = audio.volume;
            const step = currentVolume / (fadeDuration / 50);
            
            let currentStep = 0;
            fadeInterval = setInterval(() => {
                currentStep++;
                audio.volume = currentVolume - (step * currentStep);
                
                if (currentStep >= (fadeDuration / 50) || audio.volume <= 0) {
                    audio.volume = 0;
                    clearInterval(fadeInterval);
                    fadeInterval = null;
                    // 立即暂停音频
                    audio.pause();
                    if (callback) callback();
                }
            }, 50);
        }

        // 上一曲（修改版，支持歌单模式）
        function prevTrack() {
            if (tracks.length === 0) return;
            
            // 取消任何正在进行的淡入淡出
            if (fadeInterval) {
                clearInterval(fadeInterval);
                fadeInterval = null;
            }
            
            // 获取当前可用的歌曲索引（根据当前歌单）
            let availableIndices = [];
            let currentPlaylist = null;
            
            if (currentPlaylistId === null) {
                // 全部歌曲模式
                availableIndices = tracks.map((_, index) => index);
            } else {
                // 歌单模式
                currentPlaylist = playlists.find(p => p.id === currentPlaylistId);
                if (currentPlaylist) {
                    // 根据文件名查找对应的歌曲索引
                    availableIndices = currentPlaylist.trackFilenames
                        .map(filename => tracks.findIndex(track => track.file.name === filename))
                        .filter(index => index !== -1 && index < tracks.length);
                } else {
                    availableIndices = tracks.map((_, index) => index);
                }
            }
            
            if (availableIndices.length === 0) return;
            
            // 查找当前歌曲在可用索引中的位置
            let currentIndexInAvailable;
            
            if (currentPlaylistId === null) {
                // 全部歌曲模式：直接使用当前索引
                currentIndexInAvailable = currentTrackIndex;
            } else {
                // 歌单模式：查找当前歌曲在歌单中的位置
                const currentTrack = tracks[currentTrackIndex];
                const currentFilename = currentTrack?.file?.name;
                if (currentFilename && currentPlaylist) {
                    currentIndexInAvailable = currentPlaylist.trackFilenames.indexOf(currentFilename);
                } else {
                    currentIndexInAvailable = -1;
                }
            }
            
            let newTrackIndex;
            
            if (isShuffled) {
                // 随机模式下，从可用索引中随机选择上一首
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * availableIndices.length);
                    newTrackIndex = availableIndices[randomIndex];
                } while (newTrackIndex === currentTrackIndex && availableIndices.length > 1);
            } else {
                if (currentIndexInAvailable === -1) {
                    // 如果当前播放的歌曲不在当前歌单中，切换到歌单中的第一首
                    newTrackIndex = availableIndices[0];
                } else {
                    // 否则切换到上一首
                    const prevIndexInAvailable = (currentIndexInAvailable - 1 + availableIndices.length) % availableIndices.length;
                    newTrackIndex = availableIndices[prevIndexInAvailable];
                }
            }
            
            currentTrackIndex = newTrackIndex;
            
            // 重置音量到正常水平
            audio.volume = volumeSlider.value / 100;
            
            loadTrack(currentTrackIndex);
            
            // 无论之前是否在播放，切换歌曲后都开始播放
            isPlaying = true;
            playIcon.innerHTML = '<path fill="currentColor" d="M14,19H18V5H14M6,19H10V5H6V19Z" />';
            playPauseIconHidden.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" fill="none" stroke="currentColor" stroke-width="1.5"/>';
            document.querySelector('.album-art-large').style.animationPlayState = 'running';
            updateMediaSessionPlaybackState('playing');
            
            audio.play().catch(e => console.error("Play error:", e));
        }

        // 下一曲（修改版，支持歌单模式）
        function nextTrack() {
            if (tracks.length === 0) return;
            
            // 取消任何正在进行的淡入淡出
            if (fadeInterval) {
                clearInterval(fadeInterval);
                fadeInterval = null;
            }
            
            // 获取当前可用的歌曲索引（根据当前歌单）
            let availableIndices = [];
            let currentPlaylist = null;
            
            if (currentPlaylistId === null) {
                // 全部歌曲模式
                availableIndices = tracks.map((_, index) => index);
            } else {
                // 歌单模式
                currentPlaylist = playlists.find(p => p.id === currentPlaylistId);
                if (currentPlaylist) {
                    // 根据文件名查找对应的歌曲索引
                    availableIndices = currentPlaylist.trackFilenames
                        .map(filename => tracks.findIndex(track => track.file.name === filename))
                        .filter(index => index !== -1 && index < tracks.length);
                } else {
                    availableIndices = tracks.map((_, index) => index);
                }
            }
            
            if (availableIndices.length === 0) return;
            
            // 查找当前歌曲在可用索引中的位置
            let currentIndexInAvailable;
            
            if (currentPlaylistId === null) {
                // 全部歌曲模式：直接使用当前索引
                currentIndexInAvailable = currentTrackIndex;
            } else {
                // 歌单模式：查找当前歌曲在歌单中的位置
                const currentTrack = tracks[currentTrackIndex];
                const currentFilename = currentTrack?.file?.name;
                if (currentFilename && currentPlaylist) {
                    currentIndexInAvailable = currentPlaylist.trackFilenames.indexOf(currentFilename);
                } else {
                    currentIndexInAvailable = -1;
                }
            }
            
            let newTrackIndex;
            
            if (isShuffled) {
                // 随机模式下，从可用索引中随机选择下一首
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * availableIndices.length);
                    newTrackIndex = availableIndices[randomIndex];
                } while (newTrackIndex === currentTrackIndex && availableIndices.length > 1);
            } else {
                if (currentIndexInAvailable === -1) {
                    // 如果当前播放的歌曲不在当前歌单中，切换到歌单中的第一首
                    newTrackIndex = availableIndices[0];
                } else {
                    // 否则切换到下一首
                    const nextIndexInAvailable = (currentIndexInAvailable + 1) % availableIndices.length;
                    newTrackIndex = availableIndices[nextIndexInAvailable];
                }
            }
            
            currentTrackIndex = newTrackIndex;
            
            // 重置音量到正常水平
            audio.volume = volumeSlider.value / 100;
            
            loadTrack(currentTrackIndex);
            
            // 无论之前是否在播放，切换歌曲后都开始播放
            isPlaying = true;
            playIcon.innerHTML = '<path fill="currentColor" d="M14,19H18V5H14M6,19H10V5H6V19Z" />';
            playPauseIconHidden.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" fill="none" stroke="currentColor" stroke-width="1.5"/>';
            document.querySelector('.album-art-large').style.animationPlayState = 'running';
            updateMediaSessionPlaybackState('playing');
            
            audio.play().catch(e => console.error("Play error:", e));
        }

        // 切换随机播放
        function toggleShuffle() {
            isShuffled = !isShuffled;
            shuffleBtn.style.background = isShuffled ? 'rgba(59, 130, 246, 0.3)' : '';
            // 同步更新设置面板显示
            settingsShuffleToggle.classList.toggle('active', isShuffled);
            settingsShuffleValue.textContent = isShuffled ? '开启' : '关闭';
        }
        
        // 切换循环播放
        function toggleRepeat() {
            audio.loop = !audio.loop;
            repeatBtn.style.background = audio.loop ? 'rgba(59, 130, 246, 0.3)' : '';
            // 同步更新设置面板显示
            settingsRepeatToggle.classList.toggle('active', audio.loop);
            settingsRepeatValue.textContent = audio.loop ? '开启' : '关闭';
        }
        
        // 切换控制栏锁定状态
        function toggleControlsLock() {
            isControlsLocked = !isControlsLocked;
            
            const lockIcon = document.getElementById('lock-icon');
            
            if (isControlsLocked) {
                // 锁定状态：显示解锁图标
                lockIcon.innerHTML = `
                    <rect width="14" height="10" x="5" y="11"/>
                    <path d="M12,3 L12,3 C14.7614237,3 17,5.23857625 17,8 L17,11 L7,11 L7,8 C7,5.23857625 9.23857625,3 12,3 Z"/>
                    <circle cx="12" cy="16" r="1"/>
                `;
                // 移除锁定按钮的背景色
                lockControlsBtn.style.background = '';
                playerControls.classList.add('visible');
                clearTimeout(hideControlsTimeout);
                
                // 显示锁定提示
                showToast('控制栏已锁定', 2000);
            } else {
                // 解锁状态：显示锁定图标
                
                lockIcon.innerHTML = `
                    <rect width="14" height="10" x="5" y="11"/>
                    <path d="M7,7.625 L7,7 C7,4.23857625 9.23857625,2 12,2 L12,2 C14.7614237,2 17,4.23857625 17,7 L17,11"/>
                    <circle cx="12" cy="16" r="1"/>
                `;
                lockControlsBtn.style.background = '';
                
                // 显示解锁提示
                showToast('控制栏已解锁', 2000);
                
                // 如果鼠标不在控制栏区域，延迟隐藏
                if (!playerControls.matches(':hover') && !controlsHoverArea.matches(':hover')) {
                    hideControlsTimeout = setTimeout(() => {
                        playerControls.classList.remove('visible');
                        // 同时调整可视化区域位置
                        audioVisualizer.style.bottom = '0';
                    }, 2000);
                }
            }
            // 同步更新设置面板显示
            settingsLockToggle.classList.toggle('active', isControlsLocked);
            settingsLockValue.textContent = isControlsLocked ? '开启' : '关闭';
        }
        
        /* ============================================
           可视化效果函数
           ============================================ */
        
        // 创建可视化柱子
        function createVisualizerBars() {
            visualizerContainer.innerHTML = '';
            visualizerBars = [];
            
            // 创建127根柱子（奇数）
            const barCount = 127;
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                
                // 中间柱子为低频，向两侧依次为中频、高频
                const isCenter = i === Math.floor(barCount / 2);
                const distanceFromCenter = Math.abs(i - Math.floor(barCount / 2));
                
                // 为高频柱子添加光晕效果
                if (distanceFromCenter >= barCount / 3) {
                    bar.classList.add('high-frequency');
                }
                
                visualizerContainer.appendChild(bar);
                visualizerBars.push(bar);
            }
            
            // 应用当前颜色
            updateVisualizerColor();
        }
        
        // 初始化音频可视化
        function initAudioVisualizer() {
            if (!isVisualizerEnabled) return;
            
            // 创建音频上下文
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                source = audioContext.createMediaElementSource(audio);
                
                // 连接分析器
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                // 配置分析器
                analyser.fftSize = 2048;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }
            
            // 启动可视化动画
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            animateVisualizer();
            
            // 显示可视化区域
            audioVisualizer.classList.remove('hidden');

            console.log(`封面动画设置: 动画${isAlbumArtAnimationEnabled ? '开启' : '关闭'}, 方向${zoomDirection ? '放大' : '缩小'}`);
            
            // 如果启用了播放时自动匹配歌词，并且当前歌曲没有歌词，尝试匹配
            if (autoMatchOnPlay && tracks.length > 0 && currentTrackIndex >= 0) {
                const currentTrack = tracks[currentTrackIndex];
                if (!currentTrack.lyrics && !tracksMatchAttempted.has(currentTrackIndex)) {
                    autoMatchLyrics(currentTrack, currentTrackIndex);
                    tracksMatchAttempted.add(currentTrackIndex);
                }
            }
        }
        
        // 停止音频可视化（优化版）
        function stopAudioVisualizer() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // 停止播放后，平滑地重置封面缩放
            if (isAlbumArtAnimationEnabled) {
                animationState.targetScale = coverImageSize;
                animationState.isAnimating = true;
                
                // 使用requestAnimationFrame平滑过渡到默认大小
                function smoothReset() {
                    applySpringAnimation();
                    if (animationState.isAnimating && Math.abs(animationState.currentScale - coverImageSize) > 0.001) {
                        requestAnimationFrame(smoothReset);
                    }
                }
                requestAnimationFrame(smoothReset);
            } else {
                albumArtLarge.style.transform = `scale(${coverImageSize})`;
            }
            
            // 原有的可视化柱子渐隐逻辑保持不变
            if (visualizerTimeout) {
                clearTimeout(visualizerTimeout);
            }
            
            visualizerTimeout = setTimeout(() => {
                if (!isPlaying) {
                    visualizerBars.forEach(bar => {
                        bar.style.height = '0px';
                    });
                    audioVisualizer.classList.add('hidden');
                }
            }, 1000);
        }
        
        // 动画可视化效果
        function animateVisualizer() {
            if (!analyser || !isVisualizerEnabled) return;
            
            // 获取频率数据
            analyser.getByteFrequencyData(dataArray);
            
            // 计算20-500Hz频段的能量
            const lowFreqEnergy = getLowFrequencyEnergy();
            
            // 检测鼓声峰值（使用优化版本）
            const hasPeak = detectPeakImproved(lowFreqEnergy);

            // 更新封面缩放（使用优化版本）
            updateAlbumArtScaleOptimized();
            
            // 计算加权平均音量，更关注低频和中频
            let weightedSum = 0;
            let weightSum = 0;
            
            // 低频和中频权重更高
            for (let i = 0; i < bufferLength; i++) {
                // 低频和中频权重更高
                let weight;
                if (i < bufferLength * 0.3) {
                    // 低频 - 最高权重
                    weight = 1.5;
                } else if (i < bufferLength * 0.6) {
                    // 中频 - 中等权重
                    weight = 1.2;
                } else {
                    // 高频 - 较低权重
                    weight = 0.8;
                }
                
                weightedSum += dataArray[i] * weight;
                weightSum += weight;
            }
            
            const weightedAverageVolume = weightedSum / weightSum;
            
            // 将音量值添加到历史记录
            lastVolumeValues.push(weightedAverageVolume);
            if (lastVolumeValues.length > volumeHistorySize) {
                lastVolumeValues.shift();
            }
            
            // 计算平滑后的音量（使用历史记录的平均值）
            const smoothedVolume = lastVolumeValues.reduce((a, b) => a + b, 0) / lastVolumeValues.length;
            
            // 增强音量响应 - 使用非线性映射使变化更明显
            const normalizedVolume = smoothedVolume / 255;
            
            // 使用指数曲线增强响应 - 音量越大，速度增加越快
            const responseCurve = Math.pow(normalizedVolume, 0.7); // 0.7使响应更敏感
            
            // 更新粒子速度乘数 - 扩大速度范围
            volumeMultiplier = 0.3 + responseCurve * 3.0; // 范围从0.3到3.3
            
            // 计算柱子高度
            const barCount = visualizerBars.length;
            const centerIndex = Math.floor(barCount / 2);
            
            // 更新每个柱子的高度
            for (let i = 0; i < barCount; i++) {
                const distanceFromCenter = Math.abs(i - centerIndex);
                
                // 计算频率数据索引
                // 低频在中间，向两侧逐渐变为高频
                let dataIndex;
                if (i <= centerIndex) {
                    // 左侧：从低频到高频
                    dataIndex = Math.floor((centerIndex - i) / centerIndex * bufferLength * 0.3);
                } else {
                    // 右侧：从高频到低频
                    dataIndex = Math.floor((i - centerIndex) / centerIndex * bufferLength * 0.3);
                }
                
                // 确保索引在有效范围内
                dataIndex = Math.min(bufferLength - 1, Math.max(0, dataIndex));
                
                // 获取频率值并转换为高度
                let value = dataArray[dataIndex];
                
                // 应用响应曲线设置
                const responseCurve = visualizerSettings.responseCurve / 100;
                value = Math.pow(value / 255, 1 - responseCurve * 0.5) * 255;
                
                let height = (value / 255) * 60; // 最大高度60px
                
                // 根据距离中心的位置调整高度（中间柱子更高）
                const centerFactor = 1 - (distanceFromCenter / centerIndex) * 0.5;
                height *= centerFactor;
                
                // 应用平滑度设置
                const smoothness = visualizerSettings.smoothness / 100;
                const currentHeight = parseFloat(visualizerBars[i].style.height) || 0;
                const targetHeight = height;
                
                // 平滑过渡
                const newHeight = currentHeight + (targetHeight - currentHeight) * (1 - smoothness * 0.9);
                
                // 设置柱子高度
                visualizerBars[i].style.height = `${newHeight}px`;
            }
            
            // 继续动画
            animationId = requestAnimationFrame(animateVisualizer);
        }
        
        // 切换可视化效果
        function toggleVisualizer() {
            isVisualizerEnabled = !isVisualizerEnabled;
            
            // 更新按钮状态
            visualizerToggleBtn.style.background = isVisualizerEnabled ? 'rgba(59, 130, 246, 0.3)' : '';
            // 同步更新设置面板显示
            settingsVisualizerToggle.classList.toggle('active', isVisualizerEnabled);
            settingsVisualizerValue.textContent = isVisualizerEnabled ? '开启' : '关闭';

            if (isVisualizerEnabled) {
                // 启用可视化
                if (isPlaying) {
                    initAudioVisualizer();
                }
            } else {
                // 禁用可视化
                stopAudioVisualizer();
                
                // 隐藏可视化区域
                audioVisualizer.classList.add('hidden');
            }
        }
        
        // 获取频段的能量
        function getLowFrequencyEnergy() {
            if (!dataArray) return 0;
            
            // 计算频率范围对应的索引
            // 假设采样率为44100Hz，分析器频率范围为0-22050Hz
            const sampleRate = 44100;
            const nyquist = sampleRate / 2;
            const binSize = nyquist / bufferLength;
            
            // 专注于更窄的频段：20-250Hz
            const startBin = Math.floor(20 / binSize);
            const endBin = Math.floor(120 / binSize);
            
            let sum = 0;
            let count = 0;
            
            for (let i = startBin; i <= endBin && i < bufferLength; i++) {
                // 加权处理，中间频段权重更高
                let weight = 1.0;
                const normalizedBin = (i - startBin) / (endBin - startBin);
                if (normalizedBin > 0.3 && normalizedBin < 0.7) {
                    weight = 1.5; // 中间频段权重更高
                }
                
                sum += dataArray[i] * weight;
                count += weight;
            }
            
            return count > 0 ? (sum / count / 255) : 0; // 归一化到0-1
        }
        
        // 检测鼓声峰值
        function detectPeak(currentEnergy) {
            // 添加到历史记录
            lowFreqEnergyHistory.push(currentEnergy);
            if (lowFreqEnergyHistory.length > historySize) {
                lowFreqEnergyHistory.shift();
            }
            
            // 计算历史平均值
            const avgEnergy = lowFreqEnergyHistory.reduce((a, b) => a + b, 0) / lowFreqEnergyHistory.length;
            
            // 检查是否超过阈值且不是太频繁
            const now = Date.now();
            const isPeak = currentEnergy > peakThreshold && 
                        currentEnergy > avgEnergy * 1.3 &&  // 降低阈值，使检测更灵敏
                        (now - lastPeakTime) > minPeakInterval;
            
            if (isPeak) {
                lastPeakTime = now;
                console.log(`检测到峰值: ${currentEnergy.toFixed(3)}，方向: ${zoomDirection ? '放大' : '缩小'}`);
            }
            
            return isPeak;
        }
        
        /* ============================================
           封面联动动画函数
           ============================================ */
        
        // 更新专辑封面缩放
        function updateAlbumArtScale(hasPeak, lowFreqEnergy) {
            // 调用优化版本
            updateAlbumArtScaleOptimized();
        }

        // 切换缩放方向（优化版）
        function toggleZoomDirection() {
            zoomDirection = !zoomDirection;
            zoomDirectionToggle.classList.toggle('active');
            zoomDirectionValue.textContent = zoomDirection ? '放大' : '缩小';
            
            // 重置动画状态，避免方向切换时的突变
            resetAnimationState();
            
            // 立即应用新的缩放方向
            albumArtLarge.style.transform = `scale(${coverImageSize})`;
            currentImageScale = coverImageSize;
            
            console.log(`缩放方向已切换为: ${zoomDirection ? '放大' : '缩小'}`);
        }

        // 更新封面图片大小（优化版）
        function updateCoverImageSize() {
            coverImageSize = parseInt(coverImageSizeSlider.value) / 100;
            coverImageSizeValue.textContent = `${coverImageSizeSlider.value}%`;
            
            // 重置动画状态
            resetAnimationState();
            
            console.log(`封面图片大小已更新为: ${coverImageSize}`);
            
            // 立即应用新的图片大小
            albumArtLarge.style.transform = `scale(${coverImageSize})`;
            currentImageScale = coverImageSize;
            
            // 更新背景层大小以匹配封面
            updateAlbumArtBackgroundSize();
        }

        // 更新专辑封面背景层大小
        function updateAlbumArtBackgroundSize() {
            const albumArtLarge = document.querySelector('.album-art-large');
            const albumArtBackground = document.querySelector('.album-art-background');
            
            if (albumArtLarge && albumArtBackground) {
                const size = albumArtLarge.offsetWidth;
                albumArtBackground.style.width = `${size}px`;
                albumArtBackground.style.height = `${size}px`;
            }
        }
        
        // 切换封面联动动画（优化版）
        function toggleAlbumArtAnimation() {
            isAlbumArtAnimationEnabled = !isAlbumArtAnimationEnabled;
            albumArtAnimationToggle.classList.toggle('active', isAlbumArtAnimationEnabled);
            albumArtAnimationValue.textContent = isAlbumArtAnimationEnabled ? '开启' : '关闭';
            
            // 如果关闭了动画，重置图片缩放和动画状态
            if (!isAlbumArtAnimationEnabled) {
                resetAnimationState();
                albumArtLarge.style.transform = `scale(${coverImageSize})`;
                currentImageScale = coverImageSize;
            }
        }
        
        // 切换缩放方向
        function toggleZoomDirection() {
            zoomDirection = !zoomDirection;
            zoomDirectionToggle.classList.toggle('active');
            zoomDirectionValue.textContent = zoomDirection ? '放大' : '缩小';
        }
        
        // 更新封面联动动画设置
        function updateAlbumArtAnimationSettings() {
            peakThreshold = parseInt(peakThresholdSlider.value) / 100;
            peakThresholdValue.textContent = `${peakThresholdSlider.value}%`;
        }
        
        // 更新封面图片大小
        function updateCoverImageSize() {
            coverImageSize = parseInt(coverImageSizeSlider.value) / 100;
            coverImageSizeValue.textContent = `${coverImageSizeSlider.value}%`;
            
            // 立即应用新的图片大小
            if (!isAlbumArtAnimationEnabled) {
                albumArtLarge.style.transform = `scale(${coverImageSize})`;
            } else {
                // 如果动画开启，在下次动画更新时会自动应用
                // 这里强制更新一次
                updateAlbumArtScale(false, 0);
            }
        }
        
        /* ============================================
           粒子系统函数
           ============================================ */
        
        // 初始化粒子系统
        function initParticles() {
            // 设置画布尺寸
            resizeParticlesCanvas();
            window.addEventListener('resize', resizeParticlesCanvas);
            
            // 创建粒子
            createParticles();
            
            // 开始动画
            animateParticles();
        }
        
        // 调整粒子画布尺寸
        function resizeParticlesCanvas() {
            particlesCanvas.width = window.innerWidth;
            particlesCanvas.height = window.innerHeight;
        }
        
        // 创建粒子
        function createParticles() {
            particles = [];
            
            for (let i = 0; i < particlesCount; i++) {
                particles.push({
                    x: Math.random() * particlesCanvas.width,
                    y: Math.random() * particlesCanvas.height,
                    size: Math.random() * particlesSize + 1,
                    speedX: (Math.random() - 0.5) * baseSpeed,
                    speedY: (Math.random() - 0.5) * baseSpeed,
                    color: adjustColorProperties(visualizerColor, 0.7, 0.8),
                    originalSpeedX: 0,
                    originalSpeedY: 0,
                    frequencyMultiplier: Math.random() * 2 + 0.5, // 频率响应乘数
                    beatMultiplier: 1, // 节拍响应乘数
                    targetSize: Math.random() * particlesSize + 1
                });
            }
            
            // 存储原始速度
            particles.forEach(particle => {
                particle.originalSpeedX = particle.speedX;
                particle.originalSpeedY = particle.speedY;
            });
        }
        
        // 动画粒子
        function animateParticles() {
            if (!particlesEnabled) {
                particlesAnimationId = requestAnimationFrame(animateParticles);
                return;
            }
            
            // 清空画布
            particlesCtx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
            
            // 如果有音频分析数据，更新粒子行为
            if (analyser && dataArray) {
                analyser.getByteFrequencyData(dataArray);
                
                // 计算不同频段的能量
                const lowFreqEnergy = getFrequencyEnergy(0, 0.3); // 低频
                const midFreqEnergy = getFrequencyEnergy(0.3, 0.6); // 中频
                const highFreqEnergy = getFrequencyEnergy(0.6, 1); // 高频
                
                // 计算整体音量
                const overallVolume = (lowFreqEnergy + midFreqEnergy + highFreqEnergy) / 3;
                
                // 更新粒子
                particles.forEach((particle, index) => {
                    // 根据频率响应调整粒子行为
                    const freqIndex = index % 3;
                    let energy = 0;
                    
                    if (freqIndex === 0) {
                        energy = lowFreqEnergy;
                        // 低频影响粒子大小和速度
                        particle.targetSize = particlesSize + (energy / 255) * particlesSize * 2;
                        particle.speedX = particle.originalSpeedX * (1 + (energy / 255) * 2);
                        particle.speedY = particle.originalSpeedY * (1 + (energy / 255) * 2);
                    } else if (freqIndex === 1) {
                        energy = midFreqEnergy;
                        // 中频影响粒子方向变化
                        if (energy > 128) {
                            particle.speedX += (Math.random() - 0.5) * 0.1;
                            particle.speedY += (Math.random() - 0.5) * 0.1;
                        }
                    } else {
                        energy = highFreqEnergy;
                        // 高频影响粒子颜色和闪烁
                        if (energy > 150) {
                            particle.color = adjustColorProperties(
                                visualizerColor, 
                                0.7 + (energy / 255) * 0.3, 
                                0.8 + (energy / 255) * 0.2
                            );
                        }
                    }
                    
                    // 根据整体音量调整粒子速度
                    const responseFactor = particlesResponse;
                    particle.speedX = particle.originalSpeedX * (1 + (overallVolume / 255) * responseFactor * 2);
                    particle.speedY = particle.originalSpeedY * (1 + (overallVolume / 255) * responseFactor * 2);
                    
                    // 平滑调整粒子大小
                    particle.size += (particle.targetSize - particle.size) * 0.1;
                    
                    // 更新位置
                    particle.x += particle.speedX * volumeMultiplier;
                    particle.y += particle.speedY * volumeMultiplier;
                    
                    // 边界检查
                    if (particle.x < 0) particle.x = particlesCanvas.width;
                    if (particle.x > particlesCanvas.width) particle.x = 0;
                    if (particle.y < 0) particle.y = particlesCanvas.height;
                    if (particle.y > particlesCanvas.height) particle.y = 0;
                    
                    // 绘制粒子
                    particlesCtx.beginPath();
                    particlesCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    particlesCtx.fillStyle = particle.color;
                    particlesCtx.globalAlpha = particlesOpacity;
                    particlesCtx.fill();
                });
            } else {
                // 没有音频数据时的默认行为
                particles.forEach(particle => {
                    // 更新位置
                    particle.x += particle.speedX;
                    particle.y += particle.speedY;
                    
                    // 边界检查
                    if (particle.x < 0) particle.x = particlesCanvas.width;
                    if (particle.x > particlesCanvas.width) particle.x = 0;
                    if (particle.y < 0) particle.y = particlesCanvas.height;
                    if (particle.y > particlesCanvas.height) particle.y = 0;
                    
                    // 绘制粒子
                    particlesCtx.beginPath();
                    particlesCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    particlesCtx.fillStyle = particle.color;
                    particlesCtx.globalAlpha = particlesOpacity;
                    particlesCtx.fill();
                });
            }
            
            particlesAnimationId = requestAnimationFrame(animateParticles);
        }
        
        // 获取频率能量
        function getFrequencyEnergy(startFreq, endFreq) {
            if (!dataArray) return 0;
            
            const startIndex = Math.floor(startFreq * bufferLength);
            const endIndex = Math.floor(endFreq * bufferLength);
            let sum = 0;
            
            for (let i = startIndex; i < endIndex; i++) {
                sum += dataArray[i];
            }
            
            return sum / (endIndex - startIndex);
        }
        
        // 切换粒子效果
        function toggleParticles() {
            particlesEnabled = !particlesEnabled;
            particlesEnabledToggle.classList.toggle('active', particlesEnabled);
            particlesEnabledValue.textContent = particlesEnabled ? '开启' : '关闭';
            
            if (particlesEnabled) {
                particlesCanvas.style.opacity = particlesOpacity;
                if (!particlesAnimationId) {
                    animateParticles();
                }
            } else {
                particlesCanvas.style.opacity = 0;
            }
        }
        
        // 更新粒子设置
        function updateParticlesSettings() {
            particlesCount = parseInt(particlesCountSlider.value);
            particlesSize = parseInt(particlesSizeSlider.value);
            particlesOpacity = parseInt(particlesOpacitySlider.value) / 100;
            particlesResponse = parseInt(particlesResponseSlider.value) / 100;
            
            particlesCountValue.textContent = particlesCount;
            particlesSizeValue.textContent = particlesSize;
            particlesOpacityValue.textContent = `${Math.round(particlesOpacity * 100)}%`;
            particlesResponseValue.textContent = `${Math.round(particlesResponse * 100)}%`;
            
            // 更新粒子透明度
            if (particlesEnabled) {
                particlesCanvas.style.opacity = particlesOpacity;
            }
            
            // 重新创建粒子
            createParticles();
        }
        
        // 更新粒子颜色
        function updateParticlesColor() {
            particles.forEach(particle => {
                particle.color = adjustColorProperties(visualizerColor, 0.7, 0.8);
            });
        }
        
        /* ============================================
           歌词处理函数
           ============================================ */
        
        // 切换歌词管理面板
        function toggleLyricsManager() {
            if (lyricsManagerPanel.classList.contains('active')) {
                closeLyricsManager();
            } else {
                openLyricsManager();
            }
        }
        
        // 打开歌词管理面板
        function openLyricsManager() {
            lyricsManagerPanel.classList.add('active');
            renderLyricsList();
        }
        
        // 关闭歌词管理面板
        function closeLyricsManager() {
            lyricsManagerPanel.classList.remove('active');
        }
        
        // 渲染歌词列表
        function renderLyricsList() {
            const searchTerm = lyricsSearchInput.value.toLowerCase();
            const filteredLyrics = lyricsFiles.filter(lyricsFile => {
                return lyricsFile.fileName.toLowerCase().includes(searchTerm) || 
                       lyricsFile.songTitle.toLowerCase().includes(searchTerm);
            });
            
            if (filteredLyrics.length === 0) {
                lyricsManagerList.innerHTML = '<div class="no-lyrics">暂无歌词文件</div>';
                return;
            }
            
            lyricsManagerList.innerHTML = '';
            
            filteredLyrics.forEach((lyricsFile, index) => {
                const lyricsItem = document.createElement('div');
                lyricsItem.className = 'lyrics-item';
                
                // 检查是否为当前歌曲使用的歌词
                const isActive = tracks[currentTrackIndex] && 
                                 tracks[currentTrackIndex].lyrics === lyricsFile.content;
                
                if (isActive) {
                    lyricsItem.classList.add('active');
                }
                
                lyricsItem.innerHTML = `
                    <div class="lyrics-item-info">
                        <div class="lyrics-file-name">${lyricsFile.fileName}</div>
                        <div class="lyrics-song-name">${lyricsFile.songTitle} - ${lyricsFile.songArtist}</div>
                    </div>
                    <div class="lyrics-item-time">${lyricsFile.importTime}</div>
                `;
                
                lyricsItem.addEventListener('click', () => {
                    // 为当前播放的歌曲应用此歌词
                    if (tracks.length > 0) {
                        applyLyricsToTrack(currentTrackIndex, lyricsFile);
                        closeLyricsManager();
                    } else {
                        alert('请先选择要播放的歌曲');
                    }
                });
                
                lyricsManagerList.appendChild(lyricsItem);
            });
        }
        
        // 过滤歌词列表
        function filterLyricsList() {
            renderLyricsList();
        }
        
        /* ============================================
           文件处理函数
           ============================================ */
        
        // 处理文件选择
        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            
            if (files.length === 0) return;
            
            // 显示加载状态
            showLoadingState(true);
            
            try {
                const processedTracks = await processAudioFilesBatch(files);
                
                // 添加到播放列表
                tracks = tracks.concat(processedTracks);
                renderPlaylist();
                
                // 如果是第一首歌曲，自动加载
                if (tracks.length === processedTracks.length) {
                    loadTrack(0);
                }
                
                // 尝试自动匹配歌词
                autoMatchAllTracks();
                
                showToast(`成功导入 ${processedTracks.length} 首歌曲`);
                
            } catch (error) {
                console.error('导入文件失败:', error);
                showToast('导入文件失败，请重试');
            } finally {
                showLoadingState(false);
                // 清空输入框
                e.target.value = '';
            }
        }
        
        // 处理文件夹选择
        async function handleFolderSelect(e) {
            const files = Array.from(e.target.files);
            
            if (files.length === 0) return;
            
            // 显示加载状态
            showLoadingState(true);
            
            try {
                // 自动导入设置文件（如果存在）
                autoImportSettingsFromFolder(files);
                
                // 分离音频文件和歌词文件
                const audioFiles = files.filter(file => 
                    file.type.match('audio.*') || 
                    file.name.toLowerCase().endsWith('.mp3') ||
                    file.name.toLowerCase().endsWith('.flac') ||
                    file.name.toLowerCase().endsWith('.ogg') ||
                    file.name.toLowerCase().endsWith('.wav') ||
                    file.name.toLowerCase().endsWith('.aac') ||
                    file.name.toLowerCase().endsWith('.m4a')
                );
                
                const lyricsFiles = files.filter(file => 
                    file.name.toLowerCase().endsWith('.lrc') ||
                    file.name.toLowerCase().endsWith('.txt')
                );
                
                // 先处理歌词文件（快速处理）
                if (lyricsFiles.length > 0) {
                    await importLyricsFiles(lyricsFiles);
                }
                
                // 批量处理音频文件（使用 Promise.all 提高效率）
                const processedTracks = await processAudioFilesBatch(audioFiles);
                
                // 添加到播放列表
                tracks = tracks.concat(processedTracks);
                renderPlaylist();
                
                // 如果是第一首歌曲，自动加载
                if (tracks.length === processedTracks.length) {
                    loadTrack(0);
                }
                
                // 自动匹配歌词
                autoMatchAllTracks();
                
                showToast(`成功导入 ${processedTracks.length} 首歌曲和 ${lyricsFiles.length} 个歌词文件`);
                
            } catch (error) {
                console.error('导入文件夹失败:', error);
                showToast('导入文件夹失败，请重试');
            } finally {
                showLoadingState(false);
                // 清空输入框，允许重复选择同一文件夹
                e.target.value = '';
            }
        }
        
        // 批量处理音频文件
        async function processAudioFilesBatch(files) {
            const processedTracks = [];
            
            // 使用 Promise.all 并发处理文件
            const processingPromises = files.map(file => processSingleAudioFile(file));
            const results = await Promise.allSettled(processingPromises);
            
            // 收集成功处理的结果
            results.forEach((result, index) => {
                if (result.status === 'fulfilled' && result.value) {
                    processedTracks.push(result.value);
                } else {
                    console.warn(`文件 ${files[index].name} 处理失败:`, result.reason);
                }
            });
            
            return processedTracks;
        }

        // 处理单个音频文件
        function processSingleAudioFile(file) {
            return new Promise((resolve, reject) => {
                // 检查文件类型
                if (!file.type.match('audio.*') && 
                    !file.name.toLowerCase().endsWith('.mp3') &&
                    !file.name.toLowerCase().endsWith('.flac') &&
                    !file.name.toLowerCase().endsWith('.ogg') &&
                    !file.name.toLowerCase().endsWith('.wav') &&
                    !file.name.toLowerCase().endsWith('.aac') &&
                    !file.name.toLowerCase().endsWith('.m4a')) {
                    reject(new Error(`文件 ${file.name} 不是音频文件`));
                    return;
                }
                
                // 使用jsmediatags读取音频元数据
                if (typeof jsmediatags !== 'undefined') {
                    jsmediatags.read(file, {
                        onSuccess: function(tag) {
                            const track = {
                                file: file,
                                title: tag.tags.title || file.name.replace(/\.[^/.]+$/, ""),
                                artist: tag.tags.artist || '未知艺术家',
                                album: tag.tags.album || '未知专辑',
                                cover: null,
                                lyrics: null
                            };
                            
                            // 处理封面图片
                            if (tag.tags.picture) {
                                try {
                                    const base64String = Array.from(tag.tags.picture.data)
                                        .map(byte => String.fromCharCode(byte))
                                        .join('');
                                    track.cover = `data:${tag.tags.picture.format};base64,${btoa(base64String)}`;
                                } catch (e) {
                                    console.error('封面解析失败:', file.name, e);
                                }
                            }
                            
                            // 处理歌词 - 优先使用内嵌歌词
                            if (tag.tags.unsynchronisedLyrics) {
                                if (typeof tag.tags.unsynchronisedLyrics === 'object' && tag.tags.unsynchronisedLyrics.lyrics) {
                                    track.lyrics = tag.tags.unsynchronisedLyrics.lyrics;
                                } else {
                                    track.lyrics = tag.tags.unsynchronisedLyrics;
                                }
                            } else if (tag.tags.lyrics) {
                                if (typeof tag.tags.lyrics === 'object' && tag.tags.lyrics.lyrics) {
                                    track.lyrics = tag.tags.lyrics.lyrics;
                                } else {
                                    track.lyrics = tag.tags.lyrics;
                                }
                            }
                            
                            resolve(track);
                        },
                        onError: function(error) {
                            console.error('元数据读取失败:', file.name, error);
                            // 如果读取元数据失败，使用默认信息
                            const track = {
                                file: file,
                                title: file.name.replace(/\.[^/.]+$/, ""),
                                artist: '未知艺术家',
                                album: '未知专辑',
                                cover: null,
                                lyrics: null
                            };
                            resolve(track);
                        }
                    });
                } else {
                    // 如果jsmediatags不可用，使用默认信息
                    const track = {
                        file: file,
                        title: file.name.replace(/\.[^/.]+$/, ""),
                        artist: '未知艺术家',
                        album: '未知专辑',
                        cover: null,
                        lyrics: null
                    };
                    resolve(track);
                }
            });
        }
        
        /* ============================================
           歌词匹配函数
           ============================================ */
        
        // 自动匹配所有曲目的歌词
        function autoMatchAllTracks() {
            tracks.forEach((track, index) => {
                if (!track.lyrics) {
                    autoMatchLyrics(track, index);
                }
            });
        }
        
        // 自动匹配所有曲目的歌词（通过按钮触发）
        function autoMatchAllTracksWithLyrics() {
            let matchedCount = 0;
            // 先匹配当前歌曲，覆盖现有
            const currentTrack = tracks[currentTrackIndex];
            const matchedLyricsCurrent = findBestLyricsMatch(currentTrack);
            if (matchedLyricsCurrent) {
                applyLyricsToTrack(currentTrackIndex, matchedLyricsCurrent);
                matchedCount++;
                updateLyrics(tracks[currentTrackIndex]);
                renderLyricsList();
            }

            // 然后匹配其他未匹配的
            tracks.forEach((track, index) => {
                if (index !== currentTrackIndex && !track.lyrics) {
                    const matchedLyrics = findBestLyricsMatch(track);
                    if (matchedLyrics) {
                        applyLyricsToTrack(index, matchedLyrics);
                        matchedCount++;
                    }
                }
            });
            
            if (matchedCount > 0) {
                let message = `成功为 ${matchedCount} 首歌曲匹配了歌词`;
                showToast(message, 5000);
            } else {
                showToast('未能匹配到任何歌词，请检查歌词文件或调整匹配程度设置', 3000);
            }
            
            // 更新歌词列表
            renderLyricsList();
        }

        // 自动匹配歌词
        function autoMatchLyrics(track, trackIndex) {
            if (lyricsFiles.length === 0) return;
            
            const matchedLyrics = findBestLyricsMatch(track);
            
            if (matchedLyrics) {
                // 自动应用匹配的歌词
                applyLyricsToTrack(trackIndex, matchedLyrics);
                console.log(`自动匹配歌词: ${track.title} - ${matchedLyrics.fileName}`);
            }
        }
        
        // 查找最佳歌词匹配
        function findBestLyricsMatch(track) {
            if (lyricsFiles.length === 0) return null;

            let bestMatch = null;
            let bestScore = 0;

            const trackTitle = track.title.toLowerCase().replace(/[^\w\u3040-\u30ff\u4e00-\u9faf]/gi, '');
            const trackArtist = track.artist.toLowerCase().replace(/[^\w\u3040-\u30ff\u4e00-\u9faf]/gi, '');
            // 新增：获取歌曲文件名（不含扩展名）
            const trackFileName = track.file.name.replace(/\.[^/.]+$/, "").toLowerCase().replace(/[^\w\u3040-\u30ff\u4e00-\u9faf]/gi, '');

            // 计算阈值（将0-100的百分比映射到0-150的分数）
            const threshold = minMatchScore * 1.5;

            lyricsFiles.forEach(lyricsFile => {
                const fileName = lyricsFile.fileName.toLowerCase().replace(/\.(lrc|txt)$/, '').replace(/[^\w\u3040-\u30ff\u4e00-\u9faf]/gi, '');

                let score = 0;

                // 规则1: 完全匹配 "歌手 - 标题" - 最高优先级
                const idealMatch = `${trackArtist} - ${trackTitle}`;
                if (fileName === idealMatch) {
                    score = 150;
                }
                // 规则2: 完全匹配 "标题 - 歌手" - 同样高优先级
                else if (fileName === `${trackTitle} - ${trackArtist}`) {
                    score = 145;
                }
                // 规则3: 完全匹配文件名（新增）- 提高优先级
                else if (fileName === trackFileName) {
                    score = 140; // 提高文件名匹配的分数
                }
                // 规则4: 完全匹配标题
                else if (fileName === trackTitle) {
                    score = 100;
                }
                // 规则5: 包含标题和歌手
                else {
                    // 新增：精确匹配检查
                    const exactTitleMatch = new RegExp(`\\b${trackTitle}\\b`, 'i').test(fileName);
                    const exactArtistMatch = new RegExp(`\\b${trackArtist}\\b`, 'i').test(fileName);
                    const exactFileNameMatch = new RegExp(`\\b${trackFileName}\\b`, 'i').test(fileName);
                    
                    if (exactTitleMatch && exactArtistMatch) {
                        score = 120;
                    } else if (exactTitleMatch) {
                        score = 80;
                    } else if (exactArtistMatch) {
                        score = 60;
                    } else if (exactFileNameMatch) {
                        score = 100; // 提高精确文件名匹配的分数
                    } else {
                        // 模糊匹配（部分包含）
                        if (fileName.includes(trackTitle) && trackTitle.length > 0) {
                            score += 40; // 降低模糊匹配的分数
                        }
                        if (fileName.includes(trackArtist) && trackArtist.length > 0) {
                            score += 20; // 降低模糊匹配的分数
                        }
                        // 规则6: 包含文件名（新增）- 提高权重
                        if (fileName.includes(trackFileName) && trackFileName.length > 0) {
                            score += 60; // 提高文件名包含匹配的分数
                        }
                    }
                }

                // 如果分数大于阈值，并且是当前最好的匹配，则更新
                if (score >= threshold && score > bestScore) {
                    bestScore = score;
                    bestMatch = lyricsFile;
                }
            });

            return bestMatch;
        }
        
        // 处理歌词文件选择
        function handleLyricsFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // 显示加载状态
            showLoadingState(true);
            
            importLyricsFiles(files).then(() => {
                showToast(`成功导入 ${files.length} 个歌词文件`);
            }).finally(() => {
                showLoadingState(false);
                e.target.value = '';
            });
        }
        
        // 处理歌词文件夹选择
        function handleLyricsFolderSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // 显示加载状态
            showLoadingState(true);
            
            importLyricsFiles(files).then(() => {
                showToast(`成功导入 ${files.length} 个歌词文件`);
            }).finally(() => {
                showLoadingState(false);
                e.target.value = '';
            });
        }
        
        // 导入歌词文件
        function importLyricsFiles(files) {
            return new Promise((resolve) => {
                let processed = 0;
                const total = files.length;
                
                if (total === 0) {
                    resolve();
                    return;
                }
                
                files.forEach(file => {
                    // 检查文件类型
                    if (!file.name.toLowerCase().endsWith('.lrc') && !file.name.toLowerCase().endsWith('.txt')) {
                        processed++;
                        if (processed === total) resolve();
                        return;
                    }
                    
                    // 读取文件内容，支持多种编码
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        let lyricsContent = e.target.result;
                        
                        // 尝试检测编码并转换
                        lyricsContent = detectAndConvertEncoding(lyricsContent);
                        
                        // 提取歌曲信息（从歌词内容中）
                        let songTitle = extractSongTitleFromLyrics(lyricsContent) || file.name.replace(/\.(lrc|txt)$/, '');
                        let songArtist = extractArtistFromLyrics(lyricsContent) || '未知艺术家';
                        
                        const lyricsFile = {
                            fileName: file.name,
                            file: file,
                            content: lyricsContent,
                            songTitle: songTitle,
                            songArtist: songArtist,
                            importTime: new Date().toLocaleString()
                        };
                        
                        lyricsFiles.push(lyricsFile);
                        renderLyricsList();
                        
                        // 重置已尝试匹配的歌曲，让新歌词可以匹配到之前未匹配的歌曲
                        tracksMatchAttempted.clear();
                        
                        // 尝试自动匹配现有歌曲（仅对没有内嵌歌词的歌曲）
                        tracks.forEach((track, index) => {
                            if (!track.lyrics) {
                                const matchedLyrics = findBestLyricsMatch(track);
                                if (matchedLyrics && matchedLyrics.fileName === file.name) {
                                    applyLyricsToTrack(index, matchedLyrics);
                                }
                            }
                        });
                        
                        processed++;
                        if (processed === total) resolve();
                    };
                    reader.onerror = () => {
                        processed++;
                        if (processed === total) resolve();
                    };
                    reader.readAsText(file);
                });
            });
        }
        
        /* ============================================
        播放设置函数
        ============================================ */

        // 切换随机播放设置
        function toggleSettingsShuffle() {
            // 调用底部控制栏的随机播放函数
            toggleShuffle();
            
            // 更新设置面板显示
            settingsShuffleToggle.classList.toggle('active', isShuffled);
            settingsShuffleValue.textContent = isShuffled ? '开启' : '关闭';
        }

        // 切换循环播放设置
        function toggleSettingsRepeat() {
            // 调用底部控制栏的循环播放函数
            toggleRepeat();
            
            // 更新设置面板显示
            settingsRepeatToggle.classList.toggle('active', audio.loop);
            settingsRepeatValue.textContent = audio.loop ? '开启' : '关闭';
        }

        // 切换音频可视化设置
        function toggleSettingsVisualizer() {
            // 调用底部控制栏的可视化开关函数
            toggleVisualizer();
            
            // 更新设置面板显示
            settingsVisualizerToggle.classList.toggle('active', isVisualizerEnabled);
            settingsVisualizerValue.textContent = isVisualizerEnabled ? '开启' : '关闭';
        }

        // 切换锁定控制栏设置
        function toggleSettingsLock() {
            // 调用底部控制栏的锁定控制栏函数
            toggleControlsLock();
            
            // 更新设置面板显示
            settingsLockToggle.classList.toggle('active', isControlsLocked);
            settingsLockValue.textContent = isControlsLocked ? '开启' : '关闭';
        }

        // 更新音量设置
        function updateSettingsVolume() {
            const value = parseInt(settingsVolumeSlider.value);
            settingsVolumeValue.textContent = `${value}%`;
            
            // 更新底部控制栏的音量
            volumeSlider.value = value;
            setVolume();
        }

        // 更新播放设置显示
        function updatePlaySettingsDisplay() {
            // 随机播放
            settingsShuffleToggle.classList.toggle('active', isShuffled);
            settingsShuffleValue.textContent = isShuffled ? '开启' : '关闭';
            
            // 循环播放
            settingsRepeatToggle.classList.toggle('active', audio.loop);
            settingsRepeatValue.textContent = audio.loop ? '开启' : '关闭';
            
            // 音频可视化
            settingsVisualizerToggle.classList.toggle('active', isVisualizerEnabled);
            settingsVisualizerValue.textContent = isVisualizerEnabled ? '开启' : '关闭';
            
            // 锁定控制栏
            settingsLockToggle.classList.toggle('active', isControlsLocked);
            settingsLockValue.textContent = isControlsLocked ? '开启' : '关闭';
            
            // 音量
            settingsVolumeSlider.value = volumeSlider.value;
            settingsVolumeValue.textContent = `${volumeSlider.value}%`;
        }


        /* ============================================
           设置管理函数
           ============================================ */
        
        // 切换设置分组折叠状态
        function toggleSettingsGroup(titleElement) {
            const groupContent = titleElement.nextElementSibling;
            const arrow = titleElement.querySelector('.settings-group-arrow');
            
            groupContent.classList.toggle('collapsed');
            arrow.classList.toggle('collapsed');
        }

        // 切换设置面板
        function toggleSettings() {
            if (settingsPanel.classList.contains('active')) {
                closeSettings();
            } else {
                openSettings();
            }
        }
        
        // 打开设置面板
        function openSettings() {
            settingsPanel.classList.add('active');
        }
        
        // 关闭设置面板
        function closeSettings() {
            settingsPanel.classList.remove('active');
        }
        
        // 重置设置
        function resetSettings() {
            // 重置播放设置
            settingsShuffleToggle.classList.remove('active');
            settingsShuffleValue.textContent = '关闭';
            settingsRepeatToggle.classList.remove('active');
            settingsRepeatValue.textContent = '关闭';
            settingsVisualizerToggle.classList.add('active');
            settingsVisualizerValue.textContent = '开启';
            settingsLockToggle.classList.remove('active');
            settingsLockValue.textContent = '关闭';
            settingsVolumeSlider.value = 100;
            settingsVolumeValue.textContent = '100%';
            
            // 同步更新实际设置
            isShuffled = false;
            audio.loop = false;
            isVisualizerEnabled = true;
            isControlsLocked = false;
            volumeSlider.value = 100;
            setVolume();
            
            // 更新UI
            shuffleBtn.style.background = '';
            repeatBtn.style.background = '';
            visualizerToggleBtn.style.background = 'rgba(59, 130, 246, 0.3)';
            lockControlsBtn.style.background = '';
            // 重置滑块值
            gradientIntensitySlider.value = 50;
            responseCurveSlider.value = 0;
            smoothnessSlider.value = 0;
            saturationSlider.value = 100;
            transparencySlider.value = 100;
            brightnessSlider.value = 100;
            blurIntensitySlider.value = 20;
            albumArtRotationSpeedSlider.value = 70;
            albumArtSizeSlider.value = 100;
            backgroundBrightnessSlider.value = 70;
            minMatchScoreSlider.value = 50;
            
            // 重置粒子设置
            particlesEnabledToggle.classList.add('active');
            particlesCountSlider.value = 320;
            particlesSizeSlider.value = 2;
            particlesOpacitySlider.value = 80;
            particlesResponseSlider.value = 100;
            
            // 重置封面联动动画设置
            albumArtAnimationToggle.classList.add('active');
            zoomDirectionToggle.classList.add('active');
            peakThresholdSlider.value = 60;
            coverImageSizeSlider.value = 100;
            changeIntensitySlider.value = 100;
            
            // 重置缩放方向为放大
            zoomDirection = true;
            zoomDirectionValue.textContent = '放大';

            // 重置动画状态
            resetAnimationState();
            
            // 重置自动匹配设置
            autoMatchOnPlayToggle.classList.add('active');
            
            // 更新显示值
            updateSettingValue();
            updateParticlesSettings();
            updateAlbumArtAnimationSettings();
            updateCoverImageSize();
            updateChangeIntensity();
            
            // 应用默认设置
            applySettings();
        }
        
        // 应用设置 - 实时应用
        function applySettings() {
            // 更新设置参数
            visualizerSettings.gradientIntensity = parseInt(gradientIntensitySlider.value);
            visualizerSettings.responseCurve = parseInt(responseCurveSlider.value);
            visualizerSettings.smoothness = parseInt(smoothnessSlider.value);
            visualizerSettings.saturation = parseInt(saturationSlider.value);
            visualizerSettings.transparency = parseInt(transparencySlider.value);
            visualizerSettings.brightness = parseInt(brightnessSlider.value);
            visualizerSettings.blurIntensity = parseInt(blurIntensitySlider.value);
            visualizerSettings.albumArtRotationSpeed = parseInt(albumArtRotationSpeedSlider.value);
            visualizerSettings.albumArtSize = parseInt(albumArtSizeSlider.value);
            visualizerSettings.backgroundBrightness = parseInt(backgroundBrightnessSlider.value);
            visualizerSettings.minMatchScore = parseInt(minMatchScoreSlider.value);
            
            // 更新歌词匹配设置
            minMatchScore = visualizerSettings.minMatchScore;
            
            // 应用设置到可视化效果
            updateVisualizerColor();
            
            // 应用模糊度设置
            const blurValue = (visualizerSettings.blurIntensity / 100) * 50; // 最大模糊50px
            document.documentElement.style.setProperty('--blur-intensity', `${blurValue}px`);
            
            // 应用专辑封面旋转速度
            const rotationPercent = visualizerSettings.albumArtRotationSpeed;
            let rotationSpeed;

            if (rotationPercent === 0) {
                // 当速度为0%时，停止旋转
                rotationSpeed = 4294967295; // 设置一个非常大的值来模拟停止
                document.querySelector('.album-art-large').style.animationPlayState = 'paused';
            } else {
                // 使用公式：旋转一圈的时间 = 1000 / 百分比值
                // 这样：100% -> 10秒, 50% -> 20秒, 10% -> 100秒, 1% -> 1000秒
                rotationSpeed = 1000 / rotationPercent;
                
                // 限制在合理范围内：最短10秒一圈，最长1000秒一圈
                rotationSpeed = Math.max(10, Math.min(1000, rotationSpeed));
                
                document.querySelector('.album-art-large').style.animationPlayState = 'running';
            }

            document.querySelector('.album-art-large').style.animationDuration = `${rotationSpeed}s`;
            
            // 新增：重置动画状态以确保设置更改后动画正常工作
            resetAnimationState();

            // 应用专辑封面大小
            const albumArtSize = visualizerSettings.albumArtSize;
            const albumArtLarge = document.querySelector('.album-art-large');
            albumArtLarge.style.width = `${albumArtSize * 5}px`;
            albumArtLarge.style.height = `${albumArtSize * 5}px`;
            // 更新背景层大小
            updateAlbumArtBackgroundSize();
            
            // 应用背景亮度
            const backgroundBrightness = visualizerSettings.backgroundBrightness / 100;
            backgroundBlur.style.filter = `blur(var(--blur-intensity)) brightness(${0.3 + backgroundBrightness * 0.5}) saturate(1.2)`;
        }
        
        // 更新设置值显示
        function updateSettingValue() {
            gradientIntensityValue.textContent = `${gradientIntensitySlider.value}%`;
            responseCurveValue.textContent = `${responseCurveSlider.value}%`;
            smoothnessValue.textContent = `${smoothnessSlider.value}%`;
            saturationValue.textContent = `${saturationSlider.value}%`;
            transparencyValue.textContent = `${transparencySlider.value}%`;
            brightnessValue.textContent = `${brightnessSlider.value}%`;
            blurIntensityValue.textContent = `${blurIntensitySlider.value}%`;
            albumArtRotationSpeedValue.textContent = `${albumArtRotationSpeedSlider.value}%`;
            albumArtSizeValue.textContent = `${albumArtSizeSlider.value}%`;
            backgroundBrightnessValue.textContent = `${backgroundBrightnessSlider.value}%`;
            minMatchScoreValue.textContent = `${minMatchScoreSlider.value}%`;
            
            // 实时应用设置
            applySettings();
        }
        
        // 切换播放时自动匹配歌词
        function toggleAutoMatchOnPlay() {
            autoMatchOnPlay = !autoMatchOnPlay;
            autoMatchOnPlayToggle.classList.toggle('active', autoMatchOnPlay);
            autoMatchOnPlayValue.textContent = autoMatchOnPlay ? '开启' : '关闭';
            visualizerSettings.autoMatchOnPlay = autoMatchOnPlay;
        }
        
        /* ============================================
           播放列表管理函数
           ============================================ */
        
        // 加载曲目
        function loadTrack(index) {
            if (tracks.length === 0) return;

            // 重置动画状态
            resetAnimationState();
            
            const track = tracks[index];
            const url = URL.createObjectURL(track.file);
            audio.src = url;
            
            // 重置歌词状态
            lyricsData = [];
            currentLyricIndex = -1;
            lastLyricUpdateTime = 0;
            
            // 更新UI
            trackTitleSmall.textContent = track.title;
            trackArtistSmall.textContent = track.artist;
            lyricsTitle.textContent = track.title;
            lyricsArtist.textContent = track.artist;
            
            // 更新歌词
            updateLyrics(track);
            
            // 更新MediaSession元数据
            updateMediaSessionMetadata(track);
            
            if (track.cover) {
            albumArtLarge.src = track.cover;
            albumArtSmall.src = track.cover;
            backgroundBlur.style.backgroundImage = `url(${track.cover})`;
            
            // 提取专辑封面主色调并应用到可视化效果
            const albumArtImg = new Image();
            albumArtImg.crossOrigin = "Anonymous";
            albumArtImg.onload = function() {
                // 提取主色调用于可视化效果
                extractDominantColor(albumArtImg, function(color) {
                    visualizerColor = color;
                    updateVisualizerColor();
                });
                
                // 提取边缘颜色用于背景填充
                extractEdgeColor(albumArtImg, function(edgeColors) {
                    // 使用从专辑封面提取的多色渐变
                    albumArtBackground.style.background = edgeColors.gradient;
                    albumArtBackground.style.backgroundBlendMode = 'overlay';
                    
                    // 为背景层添加模糊和透明度效果
                    
                    albumArtBackground.style.opacity = '0.85';
                    
                    // 添加背景色作为回退，确保渐变加载前有颜色
                    albumArtBackground.style.backgroundColor = edgeColors.baseColor;
                    
                    // 加载完图片后立即更新背景层大小
                    updateAlbumArtBackgroundSize();
                });
            };
            albumArtImg.src = track.cover;
        } else {
            // 使用默认封面时的处理
            const defaultCover = "data:image/svg+xml,%3Csvg width='500' height='500' viewBox='0 0 500 500' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='0' y='0' width='500' height='500' fill='%231a1a1a' rx='15' ry='15'/%3E%3Cg fill='%23222222'%3E%3Crect x='5' y='50' width='8' height='30' rx='4'/%3E%3Crect x='5' y='100' width='8' height='30' rx='4'/%3E%3Crect x='5' y='150' width='8' height='30' rx='4'/%3E%3Crect x='5' y='200' width='8' height='30' rx='4'/%3E%3Crect x='5' y='250' width='8' height='30' rx='4'/%3E%3Crect x='5' y='300' width='8' height='30' rx='4'/%3E%3Crect x='5' y='350' width='8' height='30' rx='4'/%3E%3Crect x='5' y='400' width='8' height='30' rx='4'/%3E%3Crect x='487' y='50' width='8' height='30' rx='4'/%3E%3Crect x='487' y='100' width='8' height='30' rx='4'/%3E%3Crect x='487' y='150' width='8' height='30' rx='4'/%3E%3Crect x='487' y='200' width='8' height='30' rx='4'/%3E%3Crect x='487' y='250' width='8' height='30' rx='4'/%3E%3Crect x='487' y='300' width='8' height='30' rx='4'/%3E%3Crect x='487' y='350' width='8' height='30' rx='4'/%3E%3Crect x='487' y='400' width='8' height='30' rx='4'/%3E%3C/g%3E%3Cg fill='%230d0d0d'%3E%3Crect x='20' y='470' width='60' height='15' rx='8'/%3E%3Crect x='420' y='470' width='60' height='15' rx='8'/%3E%3C/g%3E%3Crect x='20' y='20' width='460' height='460' fill='none' stroke='%23333333' stroke-width='2' rx='10' ry='10'/%3E%3Crect x='25' y='25' width='450' height='450' fill='none' stroke='%232a2a2a' stroke-width='1' rx='8' ry='8'/%3E%3Ccircle cx='250' cy='250' r='250' fill='%23000000'/%3E%3Cg stroke='%23222222' stroke-width='1.25' fill='none'%3E%3Ccircle cx='250' cy='250' r='87.5'/%3E%3Ccircle cx='250' cy='250' r='92.5'/%3E%3Ccircle cx='250' cy='250' r='97.5'/%3E%3Ccircle cx='250' cy='250' r='102.5'/%3E%3Ccircle cx='250' cy='250' r='107.5'/%3E%3Ccircle cx='250' cy='250' r='112.5'/%3E%3Ccircle cx='250' cy='250' r='117.5'/%3E%3Ccircle cx='250' cy='250' r='122.5'/%3E%3Ccircle cx='250' cy='250' r='127.5'/%3E%3Ccircle cx='250' cy='250' r='132.5'/%3E%3Ccircle cx='250' cy='250' r='137.5'/%3E%3Ccircle cx='250' cy='250' r='142.5'/%3E%3Ccircle cx='250' cy='250' r='147.5'/%3E%3Ccircle cx='250' cy='250' r='152.5'/%3E%3Ccircle cx='250' cy='250' r='157.5'/%3E%3Ccircle cx='250' cy='250' r='162.5'/%3E%3Ccircle cx='250' cy='250' r='167.5'/%3E%3Ccircle cx='250' cy='250' r='172.5'/%3E%3Ccircle cx='250' cy='250' r='177.5'/%3E%3Ccircle cx='250' cy='250' r='182.5'/%3E%3Ccircle cx='250' cy='250' r='187.5'/%3E%3Ccircle cx='250' cy='250' r='192.5'/%3E%3Ccircle cx='250' cy='250' r='197.5'/%3E%3Ccircle cx='250' cy='250' r='202.5'/%3E%3Ccircle cx='250' cy='250' r='207.5'/%3E%3Ccircle cx='250' cy='250' r='212.5'/%3E%3Ccircle cx='250' cy='250' r='217.5'/%3E%3Ccircle cx='250' cy='250' r='222.5'/%3E%3Ccircle cx='250' cy='250' r='227.5'/%3E%3Ccircle cx='250' cy='250' r='232.5'/%3E%3Ccircle cx='250' cy='250' r='237.5'/%3E%3Ccircle cx='250' cy='250' r='242.5'/%3E%3Ccircle cx='250' cy='250' r='247.5'/%3E%3C/g%3E%3Ccircle cx='250' cy='250' r='75' fill='%233b82f6'/%3E%3Ccircle cx='250' cy='250' r='70' fill='%23ffffff'/%3E%3Cdefs%3E%3Cpath id='textPath' d='M 250,200 A 50,50 0 1,1 249.9,200' fill='none'/%3E%3C/defs%3E%3Ctext fill='%231e40af' font-size='18' font-family='Arial, sans-serif' font-weight='bold' letter-spacing='1'%3E%3CtextPath href='%23textPath' startOffset='50%' text-anchor='middle'%3ENO COVER AVAILABLE%3C/textPath%3E%3C/text%3E%3Ccircle cx='250' cy='250' r='20' fill='%233b82f6'/%3E%3C/svg%3E";
            albumArtLarge.src = defaultCover;
            albumArtSmall.src = defaultCover;
            backgroundBlur.style.backgroundImage = `url(${defaultCover})`;
            
            // 重置可视化颜色为默认颜色
            visualizerColor = '#3b82f6';
            updateVisualizerColor();
            
            // 重置专辑封面背景为多色渐变
            albumArtBackground.style.background = `
                radial-gradient(circle at 20% 20%, #555555 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, #444444 0%, transparent 50%),
                radial-gradient(circle at 20% 80%, #333333 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, #222222 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, #3a3a3a 0%, transparent 70%),
                radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.7) 100%)
            `;
            albumArtBackground.style.backgroundBlendMode = 'overlay';
            albumArtBackground.style.filter = 'blur(20px)';
            albumArtBackground.style.opacity = '0.85';
            albumArtBackground.style.backgroundColor = '#2a2a2a';
            
            // 更新背景层大小
            updateAlbumArtBackgroundSize();
        }
            
            // 更新播放列表中的当前曲目
            updateCurrentTrackInPlaylist();
            
            // 更新歌词列表中的高亮
            renderLyricsList();

            // 取消任何正在进行的淡入淡出
            if (fadeInterval) {
                clearInterval(fadeInterval);
                fadeInterval = null;
            }
            
            // 重置音量到正常水平
            audio.volume = volumeSlider.value / 100;
            
            // 如果之前正在播放，继续播放
            if (isPlaying) {
                audio.play().catch(e => console.error("Play error:", e));
                updateMediaSessionPlaybackState('playing');
            }
        }
        
        // 渲染播放列表（修改版，支持歌单过滤并修复高亮问题）
        function renderPlaylist() {
            if (tracks.length === 0) {
                playlistContainer.innerHTML = '<div class="empty-playlist"><p>暂无歌曲，请添加音乐文件</p></div>';
                return;
            }
            
            // 获取当前显示的歌单歌曲索引
            let trackIndices = [];
            if (currentPlaylistId === null) {
                // 全部歌曲：显示所有歌曲
                trackIndices = tracks.map((_, index) => index);
            } else {
                // 歌单模式：根据歌单记录显示歌曲
                const playlist = playlists.find(p => p.id === currentPlaylistId);
                if (playlist) {
                    // 根据歌单中的文件名记录查找对应的歌曲
                    // 这确保了即使歌曲曾被删除后又重新添加，只要文件名匹配就会显示
                    trackIndices = playlist.trackFilenames
                        .map(filename => tracks.findIndex(track => track.file.name === filename))
                        .filter(index => index !== -1);
                } else {
                    // 如果歌单不存在，显示全部歌曲
                    trackIndices = tracks.map((_, index) => index);
                    currentPlaylistId = null;
                    localStorage.setItem('currentPlaylistId', null);
                }
            }
            
            if (trackIndices.length === 0) {
                playlistContainer.innerHTML = `<div class="empty-playlist"><p>当前歌单暂无歌曲</p></div>`;
                return;
            }
            
            playlistContainer.innerHTML = '';
            
            trackIndices.forEach((trackIndex, listIndex) => {
                const track = tracks[trackIndex];
                if (!track) return; // 防止track为undefined
                
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.dataset.trackIndex = trackIndex; 
                playlistItem.dataset.listIndex = listIndex;   
                
                // 标记当前播放的歌曲
                if (trackIndex === currentTrackIndex) {
                    playlistItem.classList.add('active');
                }
                
                playlistItem.innerHTML = `
                    <img src="${track.cover || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Crect width='40' height='40' fill='%23333'/%3E%3Cpath d='M20,10 L26,16 L26,30 L14,30 L14,16 Z' fill='%23222'/%3E%3Ccircle cx='20' cy='20' r='8' fill='%233b82f6'/%3E%3C/svg%3E"}" alt="专辑封面">
                    <button class="add-to-playlist-btn" data-index="${trackIndex}" title="添加到歌单">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                    <button class="delete-btn" data-index="${trackIndex}" title="删除">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <div class="playlist-item-info">
                        <div class="playlist-item-title">${track.title}</div>
                        <div class="playlist-item-artist">${track.artist}</div>
                    </div>
                `;
                
                // 点击歌曲播放
                playlistItem.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-to-playlist-btn') || 
                        e.target.closest('.add-to-playlist-btn') ||
                        e.target.classList.contains('delete-btn') || 
                        e.target.closest('.delete-btn')) return;
                    
                    currentTrackIndex = trackIndex;
                    loadTrack(currentTrackIndex);
                    if (!isPlaying) {
                        isPlaying = true;
                        playIcon.innerHTML = '<path fill="currentColor" d="M14,19H18V5H14M6,19H10V5H6V19Z" />';
                        playPauseIconHidden.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" fill="none" stroke="currentColor" stroke-width="1.5"/>';
                        document.querySelector('.album-art-large').style.animationPlayState = 'running';
                        audio.play().catch(e => console.error("Play error:", e));
                        updateMediaSessionPlaybackState('playing');
                    }
                });
                
                // 添加到歌单按钮
                const addToPlaylistBtn = playlistItem.querySelector('.add-to-playlist-btn');
                addToPlaylistBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const rect = addToPlaylistBtn.getBoundingClientRect();
                    openSongContextMenu(trackIndex, rect.left - 150, rect.bottom + 5);
                });
                
                // 右键菜单
                playlistItem.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    openSongContextMenu(trackIndex, e.clientX, e.clientY);
                });
                
                // 删除按钮
                const deleteBtn = playlistItem.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTrack(trackIndex);
                });
                
                // 拖拽功能
                playlistItem.setAttribute('draggable', 'true');
                playlistItem.addEventListener('dragstart', handleDragStart);
                playlistItem.addEventListener('dragover', handleDragOver);
                playlistItem.addEventListener('drop', handleDrop);
                playlistItem.addEventListener('dragend', handleDragEnd);
                
                playlistContainer.appendChild(playlistItem);
            });
            
            // 更新当前播放歌曲的激活状态
            updateCurrentTrackInPlaylist();
        }
        
        // 删除曲目
        function deleteTrack(index) {
            if (tracks.length === 0) return;

            const deletedTrack = tracks[index];
            const deletedFilename = deletedTrack?.file?.name;

            /*
            // 更新所有歌单中的文件名
            playlists.forEach(playlist => {
                // 删除被删除歌曲在歌单中的引用
                const filenameIndex = playlist.trackFilenames.indexOf(deletedFilename);
                if (filenameIndex !== -1) {
                    playlist.trackFilenames.splice(filenameIndex, 1);
                }
            });

            savePlaylists();
            */

            // 处理当前播放歌曲被删除的情况
            if (index === currentTrackIndex) {
                // 暂停播放
                audio.pause();

                if (tracks.length === 1) {
                    // 如果是最后一首歌
                    audio.src = '';
                    isPlaying = false;
                    playIcon.innerHTML = '<path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z" />';
                    playPauseIconHidden.innerHTML = '<path d="M8 5v14l11-7z" fill="none" stroke="currentColor" stroke-width="1.5"/>';
                    trackTitleSmall.textContent = '选择音乐文件';
                    trackArtistSmall.textContent = '等待加载...';
                    lyricsTitle.textContent = '选择音乐文件';
                    lyricsArtist.textContent = '等待加载...';
                    currentTrackIndex = 0;
                    backgroundBlur.style.backgroundImage = '';
                    document.querySelector('.album-art-large').style.animationPlayState = 'paused';
                    updateLyrics({});
                    updateMediaSessionMetadata(null);
                    updateMediaSessionPlaybackState('none');
                } else {
                    // 调整当前播放索引
                    if (currentTrackIndex < tracks.length - 1) {
                        // 如果删除的不是最后一首，保持当前位置
                        // currentTrackIndex 会在删除后自动指向下一首
                    } else {
                        // 如果删除的是最后一首，播放前一首
                        currentTrackIndex--;
                    }
                }
            } else if (index < currentTrackIndex) {
                // 如果删除的是当前播放歌曲之前的歌曲，调整当前播放索引
                currentTrackIndex--;
            }

            // 从全局tracks中删除歌曲
            tracks.splice(index, 1);

            // 如果没有歌曲了
            if (tracks.length === 0) {
                audio.src = '';
                isPlaying = false;
                playIcon.innerHTML = '<path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z" />';
                playPauseIconHidden.innerHTML = '<path d="M8 5v14l11-7z" fill="none" stroke="currentColor" stroke-width="1.5"/>';
                trackTitleSmall.textContent = '选择音乐文件';
                trackArtistSmall.textContent = '等待加载...';
                lyricsTitle.textContent = '选择音乐文件';
                lyricsArtist.textContent = '等待加载...';
                currentTrackIndex = 0;
                backgroundBlur.style.backgroundImage = '';
                document.querySelector('.album-art-large').style.animationPlayState = 'paused';
                updateLyrics({});
                updateMediaSessionMetadata(null);
                updateMediaSessionPlaybackState('none');
            } else if (index === currentTrackIndex) {
                // 如果删除的是当前播放的歌曲，加载新的当前歌曲
                loadTrack(currentTrackIndex);
                if (isPlaying) {
                    audio.play().catch(e => console.error("Play error:", e));
                    updateMediaSessionPlaybackState('playing');
                }
            }

            renderPlaylist();
        }
            
        
        
        // 更新播放列表中的当前曲目高亮
        function updateCurrentTrackInPlaylist() {
            const items = playlistContainer.querySelectorAll('.playlist-item');
            items.forEach((item) => {
                const trackIndex = parseInt(item.dataset.trackIndex);
                // 直接比较原始索引
                if (trackIndex === currentTrackIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // 打乱播放列表
        function shufflePlaylist() {
            if (tracks.length === 0) return;

            // 获取当前播放的歌曲（用于在打乱后保持当前播放歌曲不变）
            const currentTrack = tracks[currentTrackIndex];
            const currentFilename = currentTrack?.file?.name;

            if (currentPlaylistId === null) {
                // 如果是全部歌曲模式，打乱全局tracks
                for (let i = tracks.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [tracks[i], tracks[j]] = [tracks[j], tracks[i]];
                }

                // 更新当前播放索引
                currentTrackIndex = tracks.findIndex(track => track.file.name === currentFilename);
            } else {
                // 如果是歌单模式，只打乱当前歌单的trackFilenames
                const playlist = playlists.find(p => p.id === currentPlaylistId);
                if (playlist) {
                    // 打乱歌单中的文件名顺序
                    for (let i = playlist.trackFilenames.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [playlist.trackFilenames[i], playlist.trackFilenames[j]] = [playlist.trackFilenames[j], playlist.trackFilenames[i]];
                    }

                    // 保存打乱后的歌单
                    savePlaylists();

                    // 重新渲染播放列表
                    renderPlaylist();
                }
            }

            renderPlaylist();
        }

        /* ============================================
        歌单管理函数
        ============================================ */

        // 加载歌单
        function loadPlaylists() {
            const savedPlaylists = localStorage.getItem('audioPlayerPlaylists');
            if (savedPlaylists) {
                try {
                    playlists = JSON.parse(savedPlaylists);
                    // 确保每个歌单都有必要的属性
                    playlists.forEach(playlist => {
                        if (!playlist.trackFilenames) {
                            // 如果是从旧版本升级，需要将索引转换为文件名
                            if (playlist.trackIndices && Array.isArray(playlist.trackIndices)) {
                                playlist.trackFilenames = playlist.trackIndices
                                    .map(index => tracks[index]?.file?.name)
                                    .filter(name => name);
                                delete playlist.trackIndices; // 删除旧属性
                            } else {
                                playlist.trackFilenames = [];
                            }
                        }
                        if (!playlist.createdAt) playlist.createdAt = new Date().toISOString();
                        if (!playlist.updatedAt) playlist.updatedAt = new Date().toISOString();
                    });
                    savePlaylists(); // 保存转换后的歌单
                } catch (error) {
                    console.error('加载歌单失败:', error);
                    playlists = [];
                }
            } else {
                // 创建默认歌单
                playlists = [
                    {
                        id: 'default',
                        name: '默认歌单',
                        trackFilenames: [], // 改为存储文件名
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                savePlaylists();
            }
            
            // 加载当前选中的歌单
            const savedCurrentPlaylistId = localStorage.getItem('currentPlaylistId');
            currentPlaylistId = null;
        }
        // 保存歌单
        function savePlaylists() {
            // 确保每个歌单都有正确的数据结构
            playlists.forEach(playlist => {
                if (!playlist.trackFilenames) {
                    playlist.trackFilenames = [];
                }
                playlist.updatedAt = new Date().toISOString();
            });
            localStorage.setItem('audioPlayerPlaylists', JSON.stringify(playlists));
        }

        // 切换歌单管理面板
        function togglePlaylistManager() {
            if (playlistManagerPanel.classList.contains('active')) {
                closePlaylistManager();
            } else {
                openPlaylistManager();
            }
        }

        // 打开歌单管理面板
        function openPlaylistManager() {
            playlistManagerPanel.classList.add('active');
            renderPlaylistManagerList();
        }

        // 关闭歌单管理面板
        function closePlaylistManager() {
            playlistManagerPanel.classList.remove('active');
        }

        // 渲染歌单管理列表（修复版，包含编辑和删除按钮）
        function renderPlaylistManagerList() {
            // 清空列表
            playlistManagerList.innerHTML = '';

            // 添加全部歌曲按钮
            const allSongsBtn = document.createElement('div');
            allSongsBtn.id = 'all-songs-btn';
            allSongsBtn.className = 'all-songs-btn';
            allSongsBtn.textContent = '全部歌曲';
            allSongsBtn.addEventListener('click', () => selectAllSongs());
            playlistManagerList.appendChild(allSongsBtn);
            
            // 设置全部歌曲按钮的高亮状态
            allSongsBtn.classList.toggle('active', currentPlaylistId === null);
            
            // 检查是否有歌单
            if (playlists.length === 0) {
                // 没有歌单时才显示提示
                const noPlaylists = document.createElement('div');
                noPlaylists.className = 'no-playlists';
                noPlaylists.textContent = '暂无歌单';
                playlistManagerList.appendChild(noPlaylists);
                return;
            }
            
            // 有歌单时渲染歌单列表
            playlists.forEach((playlist, index) => {
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item-manager';
                
                if (playlist.id === currentPlaylistId) {
                    playlistItem.classList.add('active');
                }

                // 计算有效歌曲数量
                const validSongCount = playlist.trackFilenames
                    .filter(filename => tracks.some(track => track.file.name === filename))
                    .length;

                playlistItem.innerHTML = `
                    <div class="playlist-item-info">
                        <div class="playlist-item-name">${playlist.name}</div>
                        <div class="playlist-item-count">${validSongCount} 首歌曲</div>
                    </div>
                    <div class="playlist-item-actions">
                        <button class="playlist-item-action-btn edit-playlist-btn" data-index="${index}" title="编辑">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="playlist-item-action-btn delete-playlist-btn" data-index="${index}" title="删除">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </button>
                    </div>
                `;

                // 点击歌单项选择该歌单
                playlistItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.playlist-item-actions')) {
                        selectPlaylist(playlist.id);
                        closePlaylistManager();
                    }
                });

                // 编辑按钮
                const editBtn = playlistItem.querySelector('.edit-playlist-btn');
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editPlaylist(index);
                });

                // 删除按钮
                const deleteBtn = playlistItem.querySelector('.delete-playlist-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deletePlaylist(index);
                });

                playlistManagerList.appendChild(playlistItem);
            });
        }

        // 选择歌单
        function selectPlaylist(playlistId) {
            currentPlaylistId = playlistId;
            localStorage.setItem('currentPlaylistId', playlistId);
            
            // 更新全部歌曲按钮高亮状态
            if (allSongsBtn) {
                allSongsBtn.classList.toggle('active', playlistId === null);
            }
            
            // 重新渲染播放列表（只显示当前歌单的歌曲）
            renderPlaylist();
            
            /*
            // 如果当前播放的歌曲不在当前歌单中，切换到歌单中的第一首（如果存在）
            if (currentPlaylistId) {
                const playlist = playlists.find(p => p.id === currentPlaylistId);
                if (playlist && playlist.trackFilenames.length > 0) {
                    const currentTrack = tracks[currentTrackIndex];
                    const currentFilename = currentTrack?.file?.name;
                    
                    // 检查当前播放歌曲是否在歌单中
                    if (!playlist.trackFilenames.includes(currentFilename)) {
                        // 如果当前播放的歌曲不在当前歌单中，切换到歌单中的第一首
                        const firstFilename = playlist.trackFilenames[0];
                        const firstTrackIndex = tracks.findIndex(track => track.file.name === firstFilename);
                        if (firstTrackIndex !== -1) {
                            currentTrackIndex = firstTrackIndex;
                            loadTrack(currentTrackIndex);
                            if (isPlaying) {
                                audio.play().catch(e => console.error("Play error:", e));
                            }
                        }
                    }
                }
            }
            */
        }

        // 新建歌单
        function openCreatePlaylistDialog() {
            newPlaylistNameInput.value = '';
            createPlaylistDialog.classList.add('active');
            setTimeout(() => {
                newPlaylistNameInput.focus();
            }, 100);
        }

        function closeCreatePlaylistDialog() {
            createPlaylistDialog.classList.remove('active');
        }

        function createNewPlaylist() {
            const name = newPlaylistNameInput.value.trim();
            if (!name) {
                showToast('请输入歌单名称', 3000);
                return;
            }

            const newPlaylist = {
                id: 'playlist_' + Date.now(),
                name: name,
                trackIndices: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            playlists.push(newPlaylist);
            savePlaylists();
            renderPlaylistManagerList();
            closeCreatePlaylistDialog();
            
            showToast(`歌单"${name}"创建成功`);
        }

        // 编辑歌单
        function editPlaylist(index) {
            const playlist = playlists[index];
            const newName = prompt('请输入新的歌单名称:', playlist.name);
            
            if (newName && newName.trim() !== playlist.name) {
                playlist.name = newName.trim();
                playlist.updatedAt = new Date().toISOString();
                savePlaylists();
                renderPlaylistManagerList();
                showToast('歌单名称已更新');
            }
        }

        // 删除歌单
        function deletePlaylist(index) {
            if (playlists.length <= 1) {
                showToast('至少需要保留一个歌单', 3000);
                return;
            }

            const playlist = playlists[index];
            if (!confirm(`确定要删除歌单"${playlist.name}"吗？`)) {
                return;
            }

            // 如果删除的是当前选中的歌单，切换到默认歌单
            if (playlist.id === currentPlaylistId) {
                currentPlaylistId = 'default';
                localStorage.setItem('currentPlaylistId', 'default');
            }

            playlists.splice(index, 1);
            savePlaylists();
            renderPlaylistManagerList();
            renderPlaylist();
            
            showToast(`歌单"${playlist.name}"已删除`);
        }

        // 导出歌单
        function exportPlaylists() {
            const dataStr = JSON.stringify(playlists, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'audio_player_playlists.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('歌单已导出到 audio_player_playlists.json 文件');
        }

        // 导入歌单
        function handleImportPlaylistsFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedPlaylists = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedPlaylists)) {
                        throw new Error('歌单文件格式不正确');
                    }

                    // 验证歌单数据结构
                    const validPlaylists = importedPlaylists.filter(playlist => 
                        playlist.id && playlist.name && 
                        (Array.isArray(playlist.trackFilenames) || Array.isArray(playlist.trackIndices))
                    );

                    if (validPlaylists.length === 0) {
                        throw new Error('歌单文件中没有有效的歌单数据');
                    }

                    // 处理每个导入的歌单
                    validPlaylists.forEach(importedPlaylist => {
                        // 检查歌单数据结构并标准化
                        if (Array.isArray(importedPlaylist.trackIndices) && !Array.isArray(importedPlaylist.trackFilenames)) {
                            // 旧格式：将trackIndices转换为trackFilenames
                            importedPlaylist.trackFilenames = importedPlaylist.trackIndices
                                .map(index => {
                                    if (index >= 0 && index < tracks.length) {
                                        return tracks[index]?.file?.name;
                                    }
                                    return null;
                                })
                                .filter(name => name !== null);
                            
                            // 删除旧的trackIndices属性
                            delete importedPlaylist.trackIndices;
                        }
                        
                        // 确保trackFilenames数组存在
                        if (!Array.isArray(importedPlaylist.trackFilenames)) {
                            importedPlaylist.trackFilenames = [];
                        }
                        
                        // 过滤掉无效的文件名（歌曲已不存在的情况）
                        importedPlaylist.trackFilenames = importedPlaylist.trackFilenames.filter(filename => 
                            tracks.some(track => track.file.name === filename)
                        );
                        
                        // 添加时间戳（如果不存在）
                        if (!importedPlaylist.createdAt) {
                            importedPlaylist.createdAt = new Date().toISOString();
                        }
                        if (!importedPlaylist.updatedAt) {
                            importedPlaylist.updatedAt = new Date().toISOString();
                        }
                        
                        // 合并歌单，避免ID重复
                        const existingIndex = playlists.findIndex(p => p.id === importedPlaylist.id);
                        if (existingIndex === -1) {
                            playlists.push(importedPlaylist);
                        } else {
                            // 如果ID已存在，询问是否覆盖
                            if (confirm(`歌单"${importedPlaylist.name}"已存在，是否覆盖？`)) {
                                playlists[existingIndex] = importedPlaylist;
                            }
                        }
                    });

                    savePlaylists();
                    renderPlaylistManagerList();
                    showToast(`成功导入 ${validPlaylists.length} 个歌单`);
                } catch (error) {
                    console.error('导入歌单失败:', error);
                    showToast(`导入歌单失败: ${error.message}`, 3000);
                }
            };
            reader.onerror = function() {
                showToast('读取歌单文件失败', 3000);
            };
            reader.readAsText(file);
            
            // 清空输入框
            e.target.value = '';
        }

        // 检查歌曲是否在歌单中
        function isSongInPlaylist(trackIndex, playlistId) {
            if (trackIndex < 0 || trackIndex >= tracks.length) return false;
            
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist || !playlist.trackFilenames) return false;
            
            const currentTrack = tracks[trackIndex];
            const currentFilename = currentTrack.file.name;
            return playlist.trackFilenames.includes(currentFilename);
        }

        // 添加歌曲到歌单
        function addSongToPlaylist(trackIndex, playlistId) {
            if (trackIndex < 0 || trackIndex >= tracks.length) return false;
            
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) return false;

            const currentTrack = tracks[trackIndex];
            const currentFilename = currentTrack.file.name;
            
            if (!playlist.trackFilenames.includes(currentFilename)) {
                playlist.trackFilenames.push(currentFilename);
                playlist.updatedAt = new Date().toISOString();
                savePlaylists();
                return true;
            }
            return false;
        }

        // 从歌单移除歌曲
        function removeSongFromPlaylist(trackIndex, playlistId) {
            if (trackIndex < 0 || trackIndex >= tracks.length) return false;
            
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) return false;

            const currentTrack = tracks[trackIndex];
            const currentFilename = currentTrack.file.name;
            
            const index = playlist.trackFilenames.indexOf(currentFilename);
            if (index !== -1) {
                playlist.trackFilenames.splice(index, 1);
                playlist.updatedAt = new Date().toISOString();
                savePlaylists();
                
                // 如果当前歌单是选中的歌单，重新渲染播放列表
                if (currentPlaylistId === playlistId) {
                    renderPlaylist();
                }
                return true;
            }
            return false;
        }

        // 打开歌曲上下文菜单
        function openSongContextMenu(trackIndex, x, y) {
            contextMenuSongIndex = trackIndex;
            
            // 渲染歌单选项
            renderContextMenuList();
            
            // 定位上下文菜单
            songContextMenu.style.left = x + 'px';
            songContextMenu.style.top = y + 'px';
            
            // 显示上下文菜单
            songContextMenu.classList.add('active');
            
            // 点击其他地方关闭菜单
            setTimeout(() => {
                document.addEventListener('click', closeContextMenuOnClick);
            }, 10);
        }

        // 关闭上下文菜单
        function closeContextMenu() {
            songContextMenu.classList.remove('active');
            contextMenuSongIndex = null;
            document.removeEventListener('click', closeContextMenuOnClick);
        }

        function closeContextMenuOnClick(e) {
            if (!songContextMenu.contains(e.target)) {
                closeContextMenu();
            }
        }

        // 渲染上下文菜单列表
        function renderContextMenuList() {
            contextMenuList.innerHTML = '';

            playlists.forEach(playlist => {
                const isInPlaylist = isSongInPlaylist(contextMenuSongIndex, playlist.id);
                
                const menuItem = document.createElement('div');
                menuItem.className = `context-menu-item ${isInPlaylist ? 'in-playlist' : ''}`;
                menuItem.innerHTML = `
                    <span class="context-menu-item-name">${playlist.name}</span>
                    <span class="context-menu-item-check">✓</span>
                `;
                
                menuItem.addEventListener('click', () => {
                    if (isInPlaylist) {
                        removeSongFromPlaylist(contextMenuSongIndex, playlist.id);
                        showToast(`已从"${playlist.name}"移除`);
                    } else {
                        addSongToPlaylist(contextMenuSongIndex, playlist.id);
                        showToast(`已添加到"${playlist.name}"`);
                    }
                    closeContextMenu();
                });
                
                contextMenuList.appendChild(menuItem);
            });
        }

        // 选择全部歌曲
        function selectAllSongs() {
            currentPlaylistId = null;
            localStorage.setItem('currentPlaylistId', null);
            
            // 更新按钮高亮状态
            if (allSongsBtn) {
                allSongsBtn.classList.add('active');
            }
            
            // 重新渲染播放列表（显示所有歌曲）
            renderPlaylist();
            
            // 重新渲染歌单管理列表以更新高亮
            renderPlaylistManagerList();
            
            // 如果当前播放的歌曲不在所有歌曲中（这不应该发生，但为了安全）
            if (currentTrackIndex >= tracks.length) {
                currentTrackIndex = 0;
                if (tracks.length > 0) {
                    loadTrack(currentTrackIndex);
                }
            }
            // !!! 新增：自动关闭歌单管理面板 !!!
            closePlaylistManager();
        }
        
        /* ============================================
           播放器界面控制函数
           ============================================ */
        
        // 隐藏播放列表
        function hidePlaylist() {
            playlistSection.classList.add('hidden');
            lyricsSection.classList.add('expanded');
            setTimeout(() => {
                showPlaylistBtn.classList.add('visible');
            }, 300);
        }
        
        // 显示播放列表
        function showPlaylist() {
            showPlaylistBtn.classList.remove('visible');
            lyricsSection.classList.remove('expanded');
            setTimeout(() => {
                playlistSection.classList.remove('hidden');
            }, 100);
        }
        
        // 设置控制栏自动隐藏
        function setupAutoHideControls() {
            // 鼠标进入控制栏区域时显示
            playerControls.addEventListener('mouseenter', () => {
                playerControls.classList.add('visible');
                // 同时调整可视化区域位置
                audioVisualizer.style.bottom = '80px';
                clearTimeout(hideControlsTimeout);
            });
            
            // 鼠标进入控制栏感应区时显示控制栏
            controlsHoverArea.addEventListener('mouseenter', () => {
                playerControls.classList.add('visible');
                // 同时调整可视化区域位置
                audioVisualizer.style.bottom = '80px';
                clearTimeout(hideControlsTimeout);
            });
            
            // 鼠标离开控制栏区域时延迟隐藏
            playerControls.addEventListener('mouseleave', () => {
                if (!isControlsLocked) {
                    hideControlsTimeout = setTimeout(() => {
                        playerControls.classList.remove('visible');
                        // 同时调整可视化区域位置
                        audioVisualizer.style.bottom = '0';
                    }, 2000);
                }
            });
            
            // 鼠标离开控制栏感应区时延迟隐藏
            controlsHoverArea.addEventListener('mouseleave', () => {
                if (!isControlsLocked) {
                    hideControlsTimeout = setTimeout(() => {
                        playerControls.classList.remove('visible');
                        // 同时调整可视化区域位置
                        audioVisualizer.style.bottom = '0';
                    }, 2000);
                }
            });
            
            // 页面加载后延迟隐藏控制栏
            if (!isControlsLocked) {
                setTimeout(() => {
                    playerControls.classList.remove('visible');
                    // 同时调整可视化区域位置
                    audioVisualizer.style.bottom = '0';
                }, 3000);
            }
        }
        
        /* ============================================
           进度条控制函数
           ============================================ */
        
        // 设置音量
        function setVolume() {
            audio.volume = volumeSlider.value / 100;
            // 同步更新设置面板显示
            settingsVolumeSlider.value = volumeSlider.value;
            settingsVolumeValue.textContent = `${volumeSlider.value}%`;
        }
        
        // 更新进度条
        function updateProgress() {
            if (isDraggingProgress || isDraggingTopProgress) return;
            
            const { currentTime, duration } = audio;
            const progressPercent = (currentTime / duration) * 100;
            progressBar.style.width = `${progressPercent}%`;
            topProgress.style.width = `${progressPercent}%`;
            
            // 更新时间显示
            currentTimeEl.textContent = formatTime(currentTime);
            timeTooltip.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
            
            // 优化歌词更新 - 限制更新频率
            const now = Date.now();
            if (now - lastLyricUpdateTime > 100) {
                updateLyricsHighlight(currentTime);
                lastLyricUpdateTime = now;
            }
            
            // 更新MediaSession播放位置
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setPositionState({
                    duration: duration,
                    playbackRate: audio.playbackRate,
                    position: currentTime
                });
            }
        }
        
        // 更新总时长
        function updateDuration() {
            totalTimeEl.textContent = formatTime(audio.duration);
            timeTooltip.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
        }
        
        // 设置底部进度条位置
        function setProgress(e) {
            if (tracks.length === 0) return;
            
            const rect = progressBarContainer.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audio.currentTime = percent * audio.duration;
        }
        
        // 开始拖动底部进度条
        function startDragProgress(e) {
            if (tracks.length === 0) return;
            
            isDraggingProgress = true;
            progressBarContainer.classList.add('dragging');
            setProgress(e);
        }
        
        // 拖动底部进度条
        function dragProgress(e) {
            if (!isDraggingProgress) return;
            
            const rect = progressBarContainer.getBoundingClientRect();
            let percent = (e.clientX - rect.left) / rect.width;
            percent = Math.max(0, Math.min(1, percent));
            
            audio.currentTime = percent * audio.duration;
            progressBar.style.width = `${percent * 100}%`;
            topProgress.style.width = `${percent * 100}%`;
            currentTimeEl.textContent = formatTime(audio.currentTime);
        }
        
        // 停止拖动底部进度条
        function stopDragProgress() {
            isDraggingProgress = false;
            progressBarContainer.classList.remove('dragging');
        }
        
        // 设置顶部进度条位置
        function setProgressTop(e) {
            if (tracks.length === 0) return;
            
            const rect = topProgressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audio.currentTime = percent * audio.duration;
        }
        
        // 开始拖动顶部进度条
        function startDragProgressTop(e) {
            if (tracks.length === 0) return;
            
            isDraggingTopProgress = true;
            topProgressBar.classList.add('dragging');
            setProgressTop(e);
        }
        
        // 拖动顶部进度条
        function dragProgressTop(e) {
            if (!isDraggingTopProgress) return;
            
            const rect = topProgressBar.getBoundingClientRect();
            let percent = (e.clientX - rect.left) / rect.width;
            percent = Math.max(0, Math.min(1, percent));
            
            audio.currentTime = percent * audio.duration;
            progressBar.style.width = `${percent * 100}%`;
            topProgress.style.width = `${percent * 100}%`;
            currentTimeEl.textContent = formatTime(audio.currentTime);
        }
        
        // 停止拖动顶部进度条
        function stopDragProgressTop() {
            isDraggingTopProgress = false;
            topProgressBar.classList.remove('dragging');
        }
        
        /* ============================================
           歌词显示函数
           ============================================ */
        
        // 更新歌词显示
        function updateLyrics(track) {
            lyricsContainer.innerHTML = '';
            lyricsData = [];
            currentLyricIndex = -1;
            lastLyricUpdateTime = 0;
            
            if (track.lyrics) {
                let lyricsText = '';
                
                // 处理不同类型的歌词数据
                if (typeof track.lyrics === 'string') {
                    lyricsText = track.lyrics;
                } else if (track.lyrics.lyrics) {
                    lyricsText = track.lyrics.lyrics;
                } else if (track.lyrics.text) {
                    lyricsText = track.lyrics.text;
                } else {
                    lyricsText = JSON.stringify(track.lyrics);
                }
                
                if (lyricsText && typeof lyricsText === 'string') {
                    // 处理歌词格式
                    if (lyricsText.includes('[') && lyricsText.includes(']')) {
                        // 解析LRC歌词
                        const lines = lyricsText.split('\n');
                        const timeMap = {};
                        
                        lines.forEach((line, index) => {
                            const timeMatches = line.match(/\[(\d+):(\d+\.\d+)\]/g);
                            let text = line.replace(/\[\d+:\d+\.\d+\]/g, '').trim();
                            
                            if (timeMatches && text) {
                                timeMatches.forEach(timeMatch => {
                                    const timeParts = timeMatch.match(/\[(\d+):(\d+\.\d+)\]/);
                                    if (timeParts) {
                                        const minutes = parseFloat(timeParts[1]);
                                        const seconds = parseFloat(timeParts[2]);
                                        const time = minutes * 60 + seconds;
                                        
                                        if (timeMap[time]) {
                                            timeMap[time] += '\n' + text;
                                        } else {
                                            timeMap[time] = text;
                                        }
                                    }
                                });
                            } else if (text) {
                                const specialTime = -1 - index;
                                timeMap[specialTime] = text;
                            }
                        });
                        
                        lyricsData = Object.keys(timeMap).map(time => {
                            return {
                                time: parseFloat(time),
                                text: timeMap[time]
                            };
                        });
                        
                        lyricsData.sort((a, b) => a.time - b.time);
                        
                        // 添加占位元素，使前几句歌词能在中间显示
                        const placeholderHeight = Math.floor(lyricsContainer.clientHeight / 3); // 使用容器高度的1/3作为占位高度
                        const placeholder = document.createElement('div');
                        placeholder.style.height = `${placeholderHeight}px`;
                        placeholder.style.flexShrink = '0'; // 防止被压缩
                        lyricsContainer.appendChild(placeholder);

                        lyricsData.forEach((item, index) => {
                            const textLines = item.text.split('\n');
                            
                            textLines.forEach((textLine, lineIndex) => {
                                if (textLine.trim()) {
                                    const lyricsLine = document.createElement('div');
                                    lyricsLine.className = 'lyrics-line';
                                    lyricsLine.textContent = textLine.trim();
                                    lyricsLine.dataset.index = index;
                                    lyricsContainer.appendChild(lyricsLine);
                                }
                            });
                        });
                    } else {
                        // 普通文本歌词
                        const lines = lyricsText.split('\n');
                        lines.forEach((line, index) => {
                            if (line.trim()) {
                                const lyricsLine = document.createElement('div');
                                lyricsLine.className = 'lyrics-line';
                                lyricsLine.textContent = line.trim();
                                lyricsLine.dataset.index = index;
                                lyricsContainer.appendChild(lyricsLine);
                            }
                        });
                    }
                } else {
                    showNoLyrics();
                }
            } else {
                showNoLyrics();
            }
            
            // 添加一个空的占位元素，确保最后一行歌词也能垂直居中
            const spacer = document.createElement('div');
            spacer.style.height = '50%';
            lyricsContainer.appendChild(spacer);
        }
        
        // 更新歌词高亮
        function updateLyricsHighlight(currentTime) {
            if (lyricsData.length === 0) return;
            
            // 查找当前时间对应的歌词
            let newIndex = -1;
            for (let i = 0; i < lyricsData.length; i++) {
                if (currentTime >= lyricsData[i].time) {
                    newIndex = i;
                } else {
                    break;
                }
            }
            
            // 如果找到了新的歌词行，更新高亮
            if (newIndex !== -1 && newIndex !== currentLyricIndex) {
                // 移除之前的高亮
                if (currentLyricIndex >= 0) {
                    const prevLines = document.querySelectorAll(`.lyrics-line[data-index="${currentLyricIndex}"]`);
                    prevLines.forEach(line => {
                        line.classList.remove('active');
                    });
                }
                
                // 添加新的高亮 - 高亮同一时间的所有歌词
                const currentLines = document.querySelectorAll(`.lyrics-line[data-index="${newIndex}"]`);
                if (currentLines.length > 0) {
                    currentLines.forEach(line => {
                        line.classList.add('active');
                    });
                    
                    // 滚动到当前歌词行 - 确保垂直居中
                    const container = lyricsContainer;
                    const lineTop = currentLines[0].offsetTop;
                    const lineHeight = currentLines[0].offsetHeight;
                    const containerHeight = container.clientHeight;
                    
                    // 计算目标滚动位置，使当前行在容器中间
                    let targetScrollTop = lineTop - (containerHeight - lineHeight) / 2;
                    
                    // 限制滚动范围
                    const maxScrollTop = container.scrollHeight - containerHeight;
                    targetScrollTop = Math.max(0, Math.min(maxScrollTop, targetScrollTop));
                    
                    container.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                }
                
                currentLyricIndex = newIndex;
            }
        }
        
        // 显示无歌词提示
        function showNoLyrics() {
            const noLyrics = document.createElement('div');
            noLyrics.className = 'no-lyrics';
            noLyrics.textContent = '暂无歌词';
            lyricsContainer.appendChild(noLyrics);
        }
        
        // 为指定曲目应用歌词
        function applyLyricsToTrack(trackIndex, lyricsFile) {
            if (trackIndex < 0 || trackIndex >= tracks.length) return;
            
            tracks[trackIndex].lyrics = lyricsFile.content;
            
            // 如果这是当前播放的曲目，更新歌词显示
            if (trackIndex === currentTrackIndex) {
                updateLyrics(tracks[trackIndex]);
            }
            
            // 更新播放列表显示
            renderPlaylist();
            
            // 更新歌词列表显示
            renderLyricsList();
        }
        
        /* ============================================
           拖拽功能
           ============================================ */
        
        let dragSrcIndex = null;
        let dragSrcListIndex = null;

        // 拖放开始
        function handleDragStart(e) {
            const listIndex = parseInt(this.dataset.listIndex);
            const trackIndex = parseInt(this.dataset.trackIndex);
            
            // 保存拖拽数据
            e.dataTransfer.setData('text/plain', JSON.stringify({
                listIndex: listIndex,
                trackIndex: trackIndex
            }));
            
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        // 拖放经过
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        // 拖放完成
        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
            const dragSrcListIndex = dragData.listIndex;
            const dragSrcTrackIndex = dragData.trackIndex;
            
            if (dragSrcListIndex !== null) {
                const dragDestListIndex = parseInt(this.dataset.listIndex);
                
                if (dragSrcListIndex !== dragDestListIndex) {
                    if (currentPlaylistId === null) {
                        // 全部歌曲模式下，直接操作tracks数组
                        const draggedTrack = tracks[dragSrcListIndex];
                        tracks.splice(dragSrcListIndex, 1);
                        tracks.splice(dragDestListIndex, 0, draggedTrack);
                        
                        // 更新当前播放索引
                        if (currentTrackIndex === dragSrcListIndex) {
                            currentTrackIndex = dragDestListIndex;
                        } else if (currentTrackIndex > dragSrcListIndex && currentTrackIndex <= dragDestListIndex) {
                            currentTrackIndex--;
                        } else if (currentTrackIndex < dragSrcListIndex && currentTrackIndex >= dragDestListIndex) {
                            currentTrackIndex++;
                        }
                    } else {
                        // 歌单模式下，操作当前歌单的trackFilenames数组
                        const playlist = playlists.find(p => p.id === currentPlaylistId);
                        if (playlist && playlist.trackFilenames) {
                            // 获取当前显示的歌曲索引列表
                            const displayedIndices = getDisplayedTrackIndices();
                            
                            // 获取拖拽源和目标位置的文件名
                            const srcFilename = playlist.trackFilenames[dragSrcListIndex];
                            const destFilename = playlist.trackFilenames[dragDestListIndex];
                            
                            if (srcFilename && destFilename) {
                                // 移动文件名
                                const srcIndexInPlaylist = playlist.trackFilenames.indexOf(srcFilename);
                                const destIndexInPlaylist = playlist.trackFilenames.indexOf(destFilename);
                                
                                if (srcIndexInPlaylist !== -1 && destIndexInPlaylist !== -1) {
                                    playlist.trackFilenames.splice(srcIndexInPlaylist, 1);
                                    playlist.trackFilenames.splice(destIndexInPlaylist, 0, srcFilename);
                                    
                                    // 保存歌单
                                    savePlaylists();
                                }
                            }
                        }
                    }
                    
                    renderPlaylist();
                }
            }
            
            return false;
        }

        // 拖放结束
        function handleDragEnd(e) {
            const items = playlistContainer.querySelectorAll('.playlist-item');
            items.forEach(item => item.classList.remove('dragging'));
        }

        // 辅助函数：获取当前显示的歌曲索引列表
        function getDisplayedTrackIndices() {
            if (currentPlaylistId === null) {
                // 全部歌曲：显示所有歌曲
                return tracks.map((_, index) => index);
            } else {
                // 歌单模式：只显示歌单中的歌曲
                const playlist = playlists.find(p => p.id === currentPlaylistId);
                if (playlist) {
                    // 根据文件名查找对应的歌曲索引
                    return playlist.trackFilenames
                        .map(filename => tracks.findIndex(track => track.file.name === filename))
                        .filter(index => index !== -1);
                } else {
                    return tracks.map((_, index) => index);
                }
            }
        }
        
        /* ============================================
           响应式布局函数
           ============================================ */
        
        // 响应式布局调整
        function adjustLayout() {
            const screenWidth = window.innerWidth;
            
            if (screenWidth < 1024) {
                document.querySelector('.lyrics-section').style.display = 'none';
            } else {
                document.querySelector('.lyrics-section').style.display = 'flex';
            }
            
            if (screenWidth < 768) {
                if (!playlistSection.classList.contains('hidden')) {
                    hidePlaylist();
                }
            }
            
            // 更新专辑封面背景层大小
            setTimeout(() => {
                updateAlbumArtBackgroundSize();
            }, 100);
        }
        
        /* ============================================
           MediaSession API 函数
           ============================================ */
        
        // 初始化MediaSession API
        function initMediaSession() {
            if (!('mediaSession' in navigator)) {
                console.log('MediaSession API is not supported in this browser');
                return;
            }
            
            // 设置媒体操作处理程序
            navigator.mediaSession.setActionHandler('play', function() {
                togglePlay();
            });
            
            navigator.mediaSession.setActionHandler('pause', function() {
                togglePlay();
            });
            
            navigator.mediaSession.setActionHandler('previoustrack', function() {
                prevTrack();
            });
            
            navigator.mediaSession.setActionHandler('nexttrack', function() {
                nextTrack();
            });
            
            navigator.mediaSession.setActionHandler('seekbackward', function(details) {
                const skipTime = details.seekOffset || 10;
                audio.currentTime = Math.max(audio.currentTime - skipTime, 0);
            });
            
            navigator.mediaSession.setActionHandler('seekforward', function(details) {
                const skipTime = details.seekOffset || 10;
                audio.currentTime = Math.min(audio.currentTime + skipTime, audio.duration);
            });
            
            navigator.mediaSession.setActionHandler('seekto', function(details) {
                if (details.fastSeek && 'fastSeek' in audio) {
                    audio.fastSeek(details.seekTime);
                } else {
                    audio.currentTime = details.seekTime;
                }
            });
            
            // 设置初始播放状态
            updateMediaSessionPlaybackState('none');
        }
        
        // 更新MediaSession元数据
        function updateMediaSessionMetadata(track) {
            if (!('mediaSession' in navigator)) return;
            
            if (track) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: track.title,
                    artist: track.artist,
                    album: track.album,
                    artwork: track.cover ? [
                        { src: track.cover, sizes: '96x96', type: 'image/jpeg' },
                        { src: track.cover, sizes: '128x128', type: 'image/jpeg' },
                        { src: track.cover, sizes: '192x192', type: 'image/jpeg' },
                        { src: track.cover, sizes: '256x256', type: 'image/jpeg' },
                        { src: track.cover, sizes: '384x384', type: 'image/jpeg' },
                        { src: track.cover, sizes: '512x512', type: 'image/jpeg' }
                    ] : []
                });
            } else {
                navigator.mediaSession.metadata = null;
            }
        }
        
        // 更新MediaSession播放状态
        function updateMediaSessionPlaybackState(state) {
            if (!('mediaSession' in navigator)) return;
            
            navigator.mediaSession.playbackState = state;
        }

        /* ============================================
        拖放功能函数
        ============================================ */

        // 初始化拖放功能
        function initDragAndDrop() {
            // 防止内部拖动触发文件拖放
            let isInternalDrag = false;
            
            document.addEventListener('dragstart', function(e) {
                // 检查是否是内部元素（专辑封面、播放列表项）的拖动
                const target = e.target;
                const isCoverArt = target.closest('.album-art-container') || 
                                target.closest('.album-art-large') ||
                                target.closest('.playlist-item');
                
                if (isCoverArt) {
                    isInternalDrag = true;
                }
            });
            
            document.addEventListener('dragend', function() {
                isInternalDrag = false;
            });
            
            document.addEventListener('dragover', function(e) {
                // 如果是内部拖动，不触发文件拖放
                if (isInternalDrag) {
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                
                // 只有在真正拖放文件时才显示效果
                const hasFiles = e.dataTransfer && e.dataTransfer.types && 
                                e.dataTransfer.types.includes('Files');
                
                if (hasFiles) {
                    document.body.classList.add('drag-over');
                }
            });

            document.addEventListener('dragleave', function(e) {
                if (e.relatedTarget === null || !e.relatedTarget.closest('body')) {
                    document.body.classList.remove('drag-over');
                }
            });

            document.addEventListener('drop', function(e) {
                // 如果是内部拖动，不触发文件处理
                if (isInternalDrag) {
                    isInternalDrag = false;
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                document.body.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length === 0) return;
                
                // 处理拖放的文件
                handleDroppedFiles(files);
            });
            
            // 添加拖放区域的CSS样式
            const style = document.createElement('style');
            style.textContent = `
                .drag-over {
                    position: relative;
                }
                .drag-over::after {
                    content: '';
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(59, 130, 246, 0.2);
                    border: 3px dashed var(--primary-color);
                    border-radius: 8px;
                    z-index: 10000;
                    pointer-events: none;
                    backdrop-filter: blur(5px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.5rem;
                    color: white;
                    font-weight: bold;
                }
                .drag-over::before {
                    content: '拖放到此添加文件';
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 10001;
                    background: rgba(0, 0, 0, 0.8);
                    padding: 20px 40px;
                    border-radius: 10px;
                    font-size: 1.2rem;
                    pointer-events: none;
                }
            `;
            document.head.appendChild(style);
        }

        // 处理拖放的文件
        function handleDroppedFiles(files) {
            if (files.length === 0) return;
            
            // 显示加载状态
            showLoadingState(true);
            
            // 分离不同类型的文件
            const audioFiles = [];
            const lyricsFiles = [];
            let settingsFile = null;
            
            Array.from(files).forEach(file => {
                const name = file.name.toLowerCase();
                
                if (name.endsWith('.mp3') || name.endsWith('.flac') || 
                    name.endsWith('.ogg') || name.endsWith('.wav') || 
                    name.endsWith('.aac') || name.endsWith('.m4a')) {
                    audioFiles.push(file);
                } else if (name.endsWith('.lrc') || name.endsWith('.txt')) {
                    lyricsFiles.push(file);
                } else if (name.endsWith('.json')) {
                    settingsFile = file;
                } else if (file.type === '') {
                    // 可能是文件夹（webkitdirectory返回的类型为空）
                    handleFolderFromDrop(file);
                }
            });
            
            // 处理设置文件（优先处理）
            if (settingsFile) {
                processSettingsFile(settingsFile);
            }
            
            // 处理歌词文件
            if (lyricsFiles.length > 0) {
                importLyricsFiles(lyricsFiles).then(() => {
                    if (lyricsFiles.length > 0 && audioFiles.length === 0) {
                        showToast(`成功导入 ${lyricsFiles.length} 个歌词文件`);
                    }
                });
            }
            
            // 处理音频文件
            if (audioFiles.length > 0) {
                processAudioFilesBatch(audioFiles).then(processedTracks => {
                    // 添加到播放列表
                    const wasEmpty = tracks.length === 0;
                    tracks = tracks.concat(processedTracks);
                    renderPlaylist();
                    
                    // 如果是第一首歌曲，自动加载
                    if (wasEmpty && processedTracks.length > 0) {
                        loadTrack(0);
                    }
                    
                    // 尝试自动匹配歌词
                    autoMatchAllTracks();
                    
                    // 显示提示信息
                    let message = `成功导入 ${processedTracks.length} 首歌曲`;
                    if (lyricsFiles.length > 0) {
                        message += ` 和 ${lyricsFiles.length} 个歌词文件`;
                    }
                    showToast(message);
                    
                }).catch(error => {
                    console.error('处理音频文件失败:', error);
                    showToast('处理音频文件失败，请重试');
                }).finally(() => {
                    showLoadingState(false);
                });
            } else if (lyricsFiles.length > 0 || settingsFile) {
                // 只有歌词或设置文件时，也需要隐藏加载状态
                setTimeout(() => {
                    showLoadingState(false);
                }, 500);
            } else {
                showLoadingState(false);
            }
        }

        // 处理拖放中的文件夹
        function handleFolderFromDrop(file) {
            // 对于拖放的文件夹，我们需要检查是否包含大量文件
            // 由于拖放API不直接支持文件夹，我们这里假设用户已经选择了多个文件
            // 实际上，浏览器会将文件夹中的所有文件作为独立的文件传递
            // 所以我们只需要按类型处理这些文件即可
            console.log('检测到可能来自文件夹的文件:', file.name);
        }

        // 处理设置文件
        function processSettingsFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    if (importSettings(settings)) {
                        showToast('设置导入成功');
                    }
                } catch (error) {
                    console.error('设置文件解析失败:', error);
                    showToast('设置文件格式错误，导入失败', 3000);
                }
            };
            reader.onerror = function() {
                showToast('读取设置文件失败', 3000);
            };
            reader.readAsText(file);
        }
        
        /* ============================================
           工具函数
           ============================================ */
        
        // 更新封面变化程度
        function updateChangeIntensity() {
            changeIntensity = parseInt(changeIntensitySlider.value) / 100;
            changeIntensityValue.textContent = `${changeIntensitySlider.value}%`;
            
            console.log(`封面变化程度已更新为: ${changeIntensity}`);
            
            // 立即应用新的变化程度
            if (isAlbumArtAnimationEnabled) {
                // 强制更新一次封面缩放
                if (dataArray && analyser) {
                    analyser.getByteFrequencyData(dataArray);
                    const lowFreqEnergy = getLowFrequencyEnergy();
                    const hasPeak = detectPeakImproved(lowFreqEnergy);
                    updateAlbumArtScaleSmooth(hasPeak, lowFreqEnergy);
                }
            }
        }


        // 新增：动画缓动函数
        function easeOutQuart(x) {
            return 1 - Math.pow(1 - x, 4);
        }

        function easeInOutQuad(x) {
            return x < 0.5 ? 2 * x * x : 1 - Math.pow(-2 * x + 2, 2) / 2;
        }

        // 新增：弹簧物理动画
        function applySpringAnimation() {
            if (!animationState.isAnimating) return;
            
            const currentTime = Date.now();
            const deltaTime = Math.min(currentTime - animationState.lastAnimationTime, 32) / 16;
            
            // 计算弹簧力
            const displacement = animationState.targetScale - animationState.currentScale;
            const springForce = displacement * 0.3;
            const dampingForce = -animationState.velocity * 0.2;
            
            // 更新速度
            animationState.velocity += (springForce + dampingForce) * deltaTime;
            
            // 限制最大速度
            const maxVelocity = animationState.maxVelocity * (1 + lowFreqEnergyHistory.length * 0.1);
            animationState.velocity = Math.max(-maxVelocity, Math.min(maxVelocity, animationState.velocity));
            
            // 更新位置
            animationState.currentScale += animationState.velocity * deltaTime;
            
            // 应用平滑因子
            const smoothFactor = animationState.smoothFactor * (1 - smoothedEnergy * 0.3);
            animationState.currentScale = animationState.currentScale * (1 - smoothFactor) + 
                                        animationState.targetScale * smoothFactor;
            
            // 检查是否接近目标
            if (Math.abs(animationState.currentScale - animationState.targetScale) < 0.001 && 
                Math.abs(animationState.velocity) < 0.001) {
                animationState.isAnimating = false;
                animationState.currentScale = animationState.targetScale;
            }
            
            // 应用缩放
            albumArtLarge.style.transform = `scale(${animationState.currentScale})`;
            currentImageScale = animationState.currentScale;
            
            // 更新背景层透明度
            const opacity = 0.7 + (1.0 - animationState.currentScale) * 0.3;
            albumArtBackground.style.opacity = Math.max(0.5, Math.min(1.0, opacity));
            
            animationState.lastAnimationTime = currentTime;
            
            // 如果仍在动画中，继续下一帧
            if (animationState.isAnimating) {
                requestAnimationFrame(() => {
                    if (animationState.isAnimating) {
                        applySpringAnimation();
                    }
                });
            }
        }

        // 新增：重置动画状态
        function resetAnimationState() {
            animationState.currentScale = coverImageSize;
            animationState.targetScale = coverImageSize;
            animationState.velocity = 0;
            animationState.isAnimating = false;
            lowFreqEnergyHistory = [];
            animationState.energyHistory = [];
            lastPeakTime = 0;
            smoothedEnergy = 0;
        }

        // 优化：检测鼓声峰值（改进版本）
        function detectPeakImproved(currentEnergy) {
            // 添加到历史记录
            lowFreqEnergyHistory.push(currentEnergy);
            if (lowFreqEnergyHistory.length > historySize) {
                lowFreqEnergyHistory.shift();
            }
            
            // 计算加权平均值
            let weightedSum = 0;
            let weightSum = 0;
            for (let i = 0; i < lowFreqEnergyHistory.length; i++) {
                const weight = (i + 1) / lowFreqEnergyHistory.length;
                weightedSum += lowFreqEnergyHistory[i] * weight;
                weightSum += weight;
            }
            const weightedAvgEnergy = weightedSum / weightSum;
            
            // 计算标准差
            let variance = 0;
            for (let i = 0; i < lowFreqEnergyHistory.length; i++) {
                variance += Math.pow(lowFreqEnergyHistory[i] - weightedAvgEnergy, 2);
            }
            const stdDev = Math.sqrt(variance / lowFreqEnergyHistory.length);
            
            // 动态阈值
            const dynamicThreshold = weightedAvgEnergy + stdDev * 1.2;
            const finalThreshold = Math.max(peakThreshold, dynamicThreshold);
            
            // 检查是否超过阈值且不是太频繁
            const now = Date.now();
            const timeSinceLastPeak = now - lastPeakTime;
            
            // 峰值检测条件
            const isSignificantPeak = currentEnergy > finalThreshold && 
                                    currentEnergy > weightedAvgEnergy * 1.4;
            
            // 防止过快的连续峰值
            const isNotTooFrequent = timeSinceLastPeak > minPeakInterval * 2;
            
            // 能量变化率检测
            const energyChange = lowFreqEnergyHistory.length > 1 ? 
                                currentEnergy - lowFreqEnergyHistory[lowFreqEnergyHistory.length - 2] : 0;
            const hasRisingEdge = energyChange > 0.05;
            
            const isPeak = isSignificantPeak && isNotTooFrequent && hasRisingEdge;
            
            if (isPeak) {
                lastPeakTime = now;
                console.log(`峰值检测: 能量=${currentEnergy.toFixed(3)}, 阈值=${finalThreshold.toFixed(3)}, 变化率=${energyChange.toFixed(3)}`);
            }
            
            return isPeak;
        }

        // 优化：平滑更新专辑封面缩放
        function updateAlbumArtScaleSmooth(hasPeak, lowFreqEnergy) {
            if (!isAlbumArtAnimationEnabled) {
                animationState.currentScale = coverImageSize;
                animationState.targetScale = coverImageSize;
                albumArtLarge.style.transform = `scale(${coverImageSize})`;
                return;
            }
            
            // 更新能量历史
            animationState.energyHistory.push(lowFreqEnergy);
            if (animationState.energyHistory.length > animationState.energyHistorySize) {
                animationState.energyHistory.shift();
            }
            
            // 计算平滑后的能量值
            smoothedEnergy = animationState.energyHistory.reduce((a, b) => a + b, 0) / 
                            animationState.energyHistory.length;
            
            let baseScale = coverImageSize;
            let targetScale = baseScale;
            
            if (hasPeak) {
                // 峰值时应用更强的缩放效果，但使用缓动函数平滑
                const peakIntensity = Math.min(lowFreqEnergy * 1.5, 1.0);
                
                if (zoomDirection) {
                    // 放大模式 - 应用变化程度
                    const maxScale = baseScale + (10 * changeIntensity);
                    targetScale = baseScale + (maxScale - baseScale) * easeOutQuart(peakIntensity);
                } else {
                    // 缩小模式 - 应用变化程度
                    const minScale = Math.max(baseScale - (10 * changeIntensity), 0.7);
                    targetScale = baseScale - (baseScale - minScale) * easeOutQuart(peakIntensity);
                }
                
                // 峰值时重置动画状态，确保响应迅速但平滑
                animationState.velocity = 0;
                console.log(`检测到峰值: ${lowFreqEnergy.toFixed(3)}, 变化程度: ${changeIntensity}, 目标缩放: ${targetScale.toFixed(3)}`);
            } else {
                // 无峰值时，根据平滑能量轻微调整 - 应用变化程度
                const energyFactor = smoothedEnergy * 0.1;
                
                if (zoomDirection) {
                    // 轻微放大 - 应用变化程度
                    const targetFactor = 0.5 * energyFactor * changeIntensity;
                    targetScale = baseScale + (baseScale * targetFactor);
                } else {
                    // 轻微缩小 - 应用变化程度
                    const targetFactor = 0.5 * energyFactor * changeIntensity;
                    targetScale = baseScale - (baseScale * targetFactor);
                }
            }
            
            // 限制缩放范围
            targetScale = Math.max(0.7, Math.min(1.5, targetScale));
            
            // 更新动画状态
            animationState.targetScale = targetScale;
            animationState.isAnimating = true;
            
            // 应用弹簧物理效果
            applySpringAnimation();
        }

        // 优化：主更新函数
        function updateAlbumArtScaleOptimized() {
            if (!analyser || !dataArray || !isAlbumArtAnimationEnabled) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // 计算20-150Hz频段的能量
            const lowFreqEnergy = getLowFrequencyEnergy();
            
            // 使用改进的峰值检测
            const hasPeak = detectPeakImproved(lowFreqEnergy);
            
            // 使用平滑的缩放更新
            updateAlbumArtScaleSmooth(hasPeak, lowFreqEnergy);
        }
        
           // 格式化时间
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        // 更新可视化颜色（优化版）
        function updateVisualizerColor() {
            // 根据设置调整颜色
            const gradientIntensity = visualizerSettings.gradientIntensity / 100;
            const brightness = visualizerSettings.brightness / 100;
            const saturation = visualizerSettings.saturation / 100;
            
            // 创建渐变色
            const color1 = adjustColorProperties(visualizerColor, brightness, saturation);
            const color2 = adjustColorProperties(lightenColor(visualizerColor, 0.3 * gradientIntensity), brightness, saturation);
            const color3 = adjustColorProperties(lightenColor(visualizerColor, 0.6 * gradientIntensity), brightness, saturation);
            
            // 更新所有柱子的背景色
            visualizerBars.forEach(bar => {
                bar.style.background = `linear-gradient(to top, 
                    ${color1} 0%, 
                    ${color2} 50%,
                    ${color3} 100%)`;
            });
            
            // 更新透明度
            const transparency = visualizerSettings.transparency / 100;
            audioVisualizer.style.opacity = transparency;
            
            // 更新粒子颜色
            updateParticlesColor();
            
            console.log(`当前可视化颜色: ${visualizerColor}, 调整后: ${color1}`);
        }
        
        // 颜色变亮函数
        function lightenColor(color, percent) {
            const num = parseInt(color.slice(1), 16);
            const amt = Math.round(2.55 * percent * 100);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            
            return "#" + (
                0x1000000 + 
                (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 + 
                (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 + 
                (B < 255 ? (B < 1 ? 0 : B) : 255)
            ).toString(16).slice(1);
        }
        
        // 调整颜色亮度和饱和度
        function adjustColorProperties(color, brightness, saturation) {
            // 将十六进制颜色转换为RGB
            const hex = color.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            // 将RGB转换为HSL
            let hsl = rgbToHsl(r, g, b);
            
            // 调整饱和度
            hsl[1] = Math.min(1, hsl[1] * saturation);
            
            // 调整亮度
            hsl[2] = Math.min(1, hsl[2] * brightness);
            
            // 将HSL转换回RGB
            const rgb = hslToRgb(hsl[0], hsl[1], hsl[2]);
            
            // 返回十六进制颜色
            return rgbToHex(rgb[0], rgb[1], rgb[2]);
        }
        
        // RGB转HSL
        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0; // 无色
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                
                h /= 6;
            }
            
            return [h, s, l];
        }
        
        // HSL转RGB
        function hslToRgb(h, s, l) {
            let r, g, b;
            
            if (s === 0) {
                r = g = b = l; // 无色
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }
        
        // RGB转十六进制
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // 从图片提取边缘颜色
        function extractEdgeColor(imageElement, callback) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置canvas尺寸
            const size = 100;
            canvas.width = size;
            canvas.height = size;
            
            // 绘制图像到canvas
            ctx.drawImage(imageElement, 0, 0, size, size);
            
            // 存储不同区域的边缘颜色
            const colorSamples = {
                topLeft: [],
                topRight: [],
                bottomLeft: [],
                bottomRight: [],
                centerEdges: []
            };
            
            // 边缘采样宽度
            const edgeWidth = 15;
            
            // 采样函数 - 从特定区域采样颜色
            function sampleRegion(startX, endX, startY, endY, regionName) {
                for (let x = startX; x < endX; x += 2) { // 跳着采样，提高性能
                    for (let y = startY; y < endY; y += 2) {
                        const pixelData = ctx.getImageData(x, y, 1, 1).data;
                        if (pixelData[3] > 128) { // 忽略透明像素
                            colorSamples[regionName].push([pixelData[0], pixelData[1], pixelData[2]]);
                        }
                    }
                }
            }
            
            // 采样四个角落区域
            const cornerSize = Math.floor(size * 0.3); // 角落区域大小
            
            // 左上角
            sampleRegion(0, cornerSize, 0, cornerSize, 'topLeft');
            // 右上角
            sampleRegion(size - cornerSize, size, 0, cornerSize, 'topRight');
            // 左下角
            sampleRegion(0, cornerSize, size - cornerSize, size, 'bottomLeft');
            // 右下角
            sampleRegion(size - cornerSize, size, size - cornerSize, size, 'bottomRight');
            
            // 采样中心边缘区域
            const centerStart = Math.floor(size * 0.35);
            const centerEnd = Math.floor(size * 0.65);
            
            // 上边缘中心
            for (let x = centerStart; x < centerEnd; x += 2) {
                for (let y = 0; y < edgeWidth; y++) {
                    const pixelData = ctx.getImageData(x, y, 1, 1).data;
                    if (pixelData[3] > 128) {
                        colorSamples.centerEdges.push([pixelData[0], pixelData[1], pixelData[2]]);
                    }
                }
            }
            
            // 下边缘中心
            for (let x = centerStart; x < centerEnd; x += 2) {
                for (let y = size - edgeWidth; y < size; y++) {
                    const pixelData = ctx.getImageData(x, y, 1, 1).data;
                    if (pixelData[3] > 128) {
                        colorSamples.centerEdges.push([pixelData[0], pixelData[1], pixelData[2]]);
                    }
                }
            }
            
            // 左边缘中心
            for (let y = centerStart; y < centerEnd; y += 2) {
                for (let x = 0; x < edgeWidth; x++) {
                    const pixelData = ctx.getImageData(x, y, 1, 1).data;
                    if (pixelData[3] > 128) {
                        colorSamples.centerEdges.push([pixelData[0], pixelData[1], pixelData[2]]);
                    }
                }
            }
            
            // 右边缘中心
            for (let y = centerStart; y < centerEnd; y += 2) {
                for (let x = size - edgeWidth; x < size; x++) {
                    const pixelData = ctx.getImageData(x, y, 1, 1).data;
                    if (pixelData[3] > 128) {
                        colorSamples.centerEdges.push([pixelData[0], pixelData[1], pixelData[2]]);
                    }
                }
            }
            
            // 计算每个区域的平均颜色
            const regionColors = {};
            
            for (const region in colorSamples) {
                const samples = colorSamples[region];
                if (samples.length > 0) {
                    let totalR = 0, totalG = 0, totalB = 0;
                    samples.forEach(color => {
                        totalR += color[0];
                        totalG += color[1];
                        totalB += color[2];
                    });
                    
                    const avgR = Math.floor(totalR / samples.length);
                    const avgG = Math.floor(totalG / samples.length);
                    const avgB = Math.floor(totalB / samples.length);
                    
                    // 将RGB转换为HSL进行调整
                    let hsl = rgbToHsl(avgR, avgG, avgB);
                    
                    // 根据不同区域调整颜色特性
                    if (region.includes('top')) {
                        // 顶部区域通常较亮，稍微调亮一点
                        hsl[2] = Math.min(0.4, hsl[2] * 1.1);
                    } else if (region.includes('bottom')) {
                        // 底部区域稍微调暗
                        hsl[2] = Math.max(0.12, hsl[2] * 0.9);
                    }
                    
                    // 降低饱和度，使颜色更柔和
                    hsl[1] = Math.min(0.5, hsl[1] * 0.7);
                    
                    // 将HSL转换回RGB
                    const rgb = hslToRgb(hsl[0], hsl[1], hsl[2]);
                    regionColors[region] = rgbToHex(rgb[0], rgb[1], rgb[2]);
                }
            }
            
            // 如果未能提取到足够颜色，使用默认颜色
            const defaultColors = {
                topLeft: '#444444',
                topRight: '#333333',
                bottomLeft: '#222222',
                bottomRight: '#111111',
                centerEdges: '#2a2a2a'
            };
            
            // 确保每个区域都有颜色
            for (const region in defaultColors) {
                if (!regionColors[region] || regionColors[region] === '#000000') {
                    regionColors[region] = defaultColors[region];
                }
            }
            
            // 创建多色渐变背景
            // 使用从四个角落到中心的径向渐变，每个角落使用不同的颜色
            const gradientStyle = `
                radial-gradient(circle at 20% 20%, ${regionColors.topLeft} 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, ${regionColors.topRight} 0%, transparent 50%),
                radial-gradient(circle at 20% 80%, ${regionColors.bottomLeft} 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, ${regionColors.bottomRight} 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, ${regionColors.centerEdges} 0%, transparent 70%),
                radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.8) 100%)
            `;
            
            // 创建一个混合所有颜色的基础背景作为回退
            const baseColor = regionColors.centerEdges;
            
            callback({
                gradient: gradientStyle,
                baseColor: baseColor,
                regionColors: regionColors
            });
        }
        
        // 优化：从图片提取主色调和次要色调
        function extractDominantColor(imageElement, callback) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置canvas尺寸
            canvas.width = 100;
            canvas.height = 100;
            
            // 绘制图像到canvas
            ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
            
            // 获取像素数据
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 收集所有颜色及其出现次数
            const colorCounts = new Map();
            
            // 遍历像素，按颜色相似度聚类
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const a = data[i + 3];
                
                // 忽略透明或接近透明的像素
                if (a < 128) continue;
                
                // 将颜色量化到32个级别，减少颜色数量但保持更多细节
                const quantizedR = Math.floor(r / 8) * 8;
                const quantizedG = Math.floor(g / 8) * 8;
                const quantizedB = Math.floor(b / 8) * 8;
                
                const colorKey = `${quantizedR},${quantizedG},${quantizedB}`;
                
                // 统计颜色出现次数
                colorCounts.set(colorKey, (colorCounts.get(colorKey) || 0) + 1);
            }
            
            // 如果没有找到任何颜色，使用默认颜色
            if (colorCounts.size === 0) {
                callback('#3b82f6');
                return;
            }
            
            // 将颜色按出现次数排序
            const sortedColors = Array.from(colorCounts.entries())
                .sort((a, b) => b[1] - a[1])
                .map(entry => {
                    const [colorKey, count] = entry;
                    const [r, g, b] = colorKey.split(',').map(Number);
                    return {
                        color: rgbToHex(r, g, b),
                        rgb: { r, g, b },
                        count: count,
                        brightness: (0.299 * r + 0.587 * g + 0.114 * b) / 255,
                        saturation: calculateSaturation(r, g, b)
                    };
                });
            
            // 主色调（出现次数最多的颜色）
            const primaryColor = sortedColors[0];
            
            // 寻找次要色调（排除主色调，选择下一个合适的颜色）
            let selectedColor = primaryColor;
            let foundSuitableColor = false;
            
            // 检查主色调是否合适
            const primarySuitable = isColorSuitable(primaryColor);
            
            if (primarySuitable) {
                // 主色调合适，直接使用
                selectedColor = primaryColor;
                foundSuitableColor = true;
                console.log(`使用主色调: ${primaryColor.color}, 亮度: ${primaryColor.brightness.toFixed(3)}`);
            } else {
                // 主色调不合适，寻找合适的次要色调
                console.log(`主色调不合适 (亮度: ${primaryColor.brightness.toFixed(3)}), 寻找次要色调...`);
                
                // 寻找符合要求的次要色调
                for (let i = 1; i < Math.min(10, sortedColors.length); i++) {
                    const secondaryColor = sortedColors[i];
                    
                    // 检查次要色调是否合适
                    if (isColorSuitable(secondaryColor)) {
                        selectedColor = secondaryColor;
                        foundSuitableColor = true;
                        console.log(`找到合适的次要色调 #${i}: ${secondaryColor.color}, 亮度: ${secondaryColor.brightness.toFixed(3)}`);
                        break;
                    }
                }
                
                // 如果没有找到合适的次要色调，尝试对主色调进行调整
                if (!foundSuitableColor) {
                    console.log('未找到合适的次要色调，尝试调整主色调');
                    selectedColor = adjustUnsuitableColor(primaryColor);
                }
            }
            
            // 对选中的颜色进行最终调整，确保适合可视化效果
            let finalColor = adjustColorForVisualization(selectedColor.color, selectedColor.brightness);
            
            // 调用回调函数
            callback(finalColor);
        }

        // 辅助函数：计算颜色的饱和度
        function calculateSaturation(r, g, b) {
            const max = Math.max(r, g, b) / 255;
            const min = Math.min(r, g, b) / 255;
            
            if (max === min) return 0; // 灰度色
            
            const lightness = (max + min) / 2;
            const delta = max - min;
            
            return lightness > 0.5 
                ? delta / (2 - max - min)
                : delta / (max + min);
        }

        // 辅助函数：检查颜色是否合适（亮度合适且有一定饱和度）
        function isColorSuitable(colorObj) {
            // 亮度范围：0.15-0.85 之间
            const isBrightnessOk = colorObj.brightness >= 0.15 && colorObj.brightness <= 0.85;
            
            // 饱和度：大于0.2（避免使用过于灰暗的颜色）
            const isSaturatedEnough = colorObj.saturation > 0.2;
            
            // 如果是蓝色系，可以适当放宽饱和度要求（因为蓝色通常饱和度较低）
            const isBlueDominant = colorObj.rgb.b > colorObj.rgb.r * 1.5 && colorObj.rgb.b > colorObj.rgb.g * 1.5;
            const saturationThreshold = isBlueDominant ? 0.15 : 0.2;
            
            return isBrightnessOk && colorObj.saturation > saturationThreshold;
        }

        // 辅助函数：调整不合适的颜色
        function adjustUnsuitableColor(colorObj) {
            let { r, g, b } = colorObj.rgb;
            let adjustedBrightness = colorObj.brightness;
            
            console.log(`调整不合适的主色调: ${colorObj.color}, 亮度: ${colorObj.brightness.toFixed(3)}`);
            
            // 如果颜色太暗（亮度 < 0.15）
            if (colorObj.brightness < 0.15) {
                // 增加亮度
                const factor = 0.2 / colorObj.brightness;
                r = Math.min(255, Math.round(r * factor));
                g = Math.min(255, Math.round(g * factor));
                b = Math.min(255, Math.round(b * factor));
                adjustedBrightness = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                console.log(`颜色太暗，增加亮度到: ${adjustedBrightness.toFixed(3)}`);
            }
            // 如果颜色太亮（亮度 > 0.85）
            else if (colorObj.brightness > 0.85) {
                // 降低亮度
                const factor = 0.7 / colorObj.brightness;
                r = Math.round(r * factor);
                g = Math.round(g * factor);
                b = Math.round(b * factor);
                adjustedBrightness = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                console.log(`颜色太亮，降低亮度到: ${adjustedBrightness.toFixed(3)}`);
            }
            
            // 如果饱和度不足，尝试增强颜色
            if (colorObj.saturation < 0.2) {
                // 增强主色调
                const hsl = rgbToHsl(r, g, b);
                hsl[1] = Math.min(0.6, hsl[1] * 1.5); // 增强饱和度，但不过度
                const rgb = hslToRgb(hsl[0], hsl[1], hsl[2]);
                r = rgb[0];
                g = rgb[1];
                b = rgb[2];
                console.log(`饱和度不足，增强颜色`);
            }
            
            return {
                color: rgbToHex(r, g, b),
                rgb: { r, g, b },
                brightness: adjustedBrightness,
                saturation: calculateSaturation(r, g, b)
            };
        }

        // 辅助函数：为可视化效果调整颜色
        function adjustColorForVisualization(colorHex, brightness) {
            const hex = colorHex.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            // 转换为HSL进行最终调整
            const hsl = rgbToHsl(r, g, b);
            
            // 确保饱和度适中
            hsl[1] = Math.min(0.7, Math.max(0.3, hsl[1] * 1.2));
            
            // 确保亮度适中
            if (brightness < 0.25) {
                hsl[2] = Math.min(0.5, hsl[2] * 1.5);
            } else if (brightness > 0.75) {
                hsl[2] = Math.max(0.4, hsl[2] * 0.8);
            }
            
            // 将HSL转换回RGB
            const rgb = hslToRgb(hsl[0], hsl[1], hsl[2]);
            
            // 返回调整后的颜色
            return rgbToHex(rgb[0], rgb[1], rgb[2]);
        }

        // 新增：获取颜色排名（用于调试）
        function getColorRankings(colorCounts) {
            return Array.from(colorCounts.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map((entry, index) => {
                    const [colorKey, count] = entry;
                    const [r, g, b] = colorKey.split(',').map(Number);
                    const brightness = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    const saturation = calculateSaturation(r, g, b);
                    return {
                        rank: index + 1,
                        color: rgbToHex(r, g, b),
                        count: count,
                        brightness: brightness,
                        saturation: saturation,
                        suitable: isColorSuitable({
                            rgb: { r, g, b },
                            brightness: brightness,
                            saturation: saturation
                        })
                    };
                });
        }
        
        // 检测并转换编码
        function detectAndConvertEncoding(text) {
            // 常见编码检测和转换
            const encodings = ['utf-8', 'gbk', 'gb2312', 'big5', 'shift_jis'];
            
            for (let encoding of encodings) {
                try {
                    // 尝试使用TextDecoder解码
                    const decoder = new TextDecoder(encoding);
                    const encoder = new TextEncoder();
                    const bytes = encoder.encode(text);
                    const decoded = decoder.decode(bytes);
                    
                    // 检查是否包含常见中文字符
                    if (containsChinese(decoded)) {
                        return decoded;
                    }
                } catch (e) {
                    console.log(`Failed to decode with ${encoding}`, e);
                }
            }
            
            // 如果所有编码都失败，返回原始文本
            return text;
        }
        
        // 检查是否包含中文字符
        function containsChinese(text) {
            return /[\u4e00-\u9fa5]/.test(text);
        }
        
        // 从歌词内容提取歌曲标题
        function extractSongTitleFromLyrics(lyricsContent) {
            const titleMatch = lyricsContent.match(/\[ti:(.*?)\]/i);
            return titleMatch ? titleMatch[1].trim() : null;
        }
        
        // 从歌词内容提取歌手
        function extractArtistFromLyrics(lyricsContent) {
            const artistMatch = lyricsContent.match(/\[ar:(.*?)\]/i);
            return artistMatch ? artistMatch[1].trim() : null;
        }
        
        // 显示/隐藏加载状态
        function showLoadingState(show) {
            const playlistContainer = document.getElementById('playlist-container');
            if (show) {
                // 显示加载指示器
                const loadingHtml = `
                    <div class="loading-indicator">
                        <div class="loading-spinner"></div>
                        <p>正在处理文件，请稍候...</p>
                    </div>
                `;
                playlistContainer.insertAdjacentHTML('beforeend', loadingHtml);
            } else {
                // 移除加载指示器
                const loadingIndicator = playlistContainer.querySelector('.loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
            }
        }

        // 显示Toast通知
        function showToast(message, duration = 6000) {
            // 移除现有的toast
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }
            
            // 创建新的toast
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 14px;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                animation: toastSlideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            // 自动移除
            setTimeout(() => {
                toast.style.animation = 'toastSlideOut 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        }

        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes toastSlideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes toastSlideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            
            .loading-indicator {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
                color: var(--text-muted);
            }
            
            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 3px solid rgba(255, 255, 255, 0.1);
                border-top: 3px solid var(--primary-color);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 15px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        /* ============================================
           初始化播放器
           ============================================ */
        
        // 初始化播放器
        initPlayer();
    </script>
    
    <!-- 引入jsmediatags库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
</body>
</html>
